<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MERIDIAN 3.0 ‚Äî Team Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<style>
:root{
  --ink:#12100e;--paper:#f7f3ec;--p2:#ede8de;--p3:#e3dbd0;
  --ruled:#cfc8b8;--muted:#8c7f6e;--faint:#b8ad9c;
  --red:#b83232;--green:#2a6e48;--amber:#b87820;--blue:#1e4f82;
  --purple:#5e1e82;--teal:#1a6e6e;--rose:#8a1e4e;
  --sh:0 2px 14px rgba(18,16,14,.1);--shl:0 8px 36px rgba(18,16,14,.16);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--paper);color:var(--ink);font-family:'Instrument Sans',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 27px,rgba(160,140,100,.08) 28px);pointer-events:none;z-index:0;}

/* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
.f-syne{font-family:'Syne',sans-serif;}
.fw8{font-weight:800;} .fw7{font-weight:700;} .fw6{font-weight:600;}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#login-screen{position:fixed;inset:0;z-index:9000;display:flex;align-items:center;justify-content:center;background:var(--ink);}
#login-screen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 40px,rgba(255,255,255,.015) 40px,rgba(255,255,255,.015) 41px);}
.login-box{background:var(--paper);border-radius:10px;padding:40px 44px;width:400px;max-width:94vw;position:relative;box-shadow:0 24px 80px rgba(0,0,0,.4);}
.login-logo{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;letter-spacing:.18em;color:var(--ink);margin-bottom:4px;}
.login-logo em{color:var(--red);font-style:normal;}
.login-sub{font-size:.72rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;font-family:'Syne',sans-serif;margin-bottom:28px;}
.login-label{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:5px;display:block;}
.login-input{width:100%;background:var(--p2);border:1.5px solid var(--ruled);border-radius:5px;padding:11px 14px;color:var(--ink);font-family:'Instrument Sans',sans-serif;font-size:.9rem;outline:none;margin-bottom:14px;transition:border-color .18s;}
.login-input:focus{border-color:var(--ink);}
.login-btn{width:100%;background:var(--ink);color:var(--paper);border:none;border-radius:5px;padding:13px;font-family:'Syne',sans-serif;font-size:.72rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;cursor:pointer;transition:background .18s;margin-top:4px;}
.login-btn:hover{background:var(--red);}
.login-err{color:var(--red);font-size:.76rem;margin-top:8px;display:none;font-family:'Syne',sans-serif;font-weight:600;}
.login-err.vis{display:block;}
.session-info{font-size:.68rem;color:var(--muted);margin-top:14px;text-align:center;}
.first-run-note{background:var(--p2);border:1px solid var(--ruled);border-radius:5px;padding:12px 14px;margin-bottom:18px;font-size:.76rem;color:var(--muted);line-height:1.6;}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#app{display:none;min-height:100vh;position:relative;z-index:1;}
#app.vis{display:block;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.shell{display:grid;grid-template-columns:220px 1fr;min-height:100vh;}
.sidebar{background:var(--ink);color:var(--paper);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;}
.sb-logo{padding:22px 20px 16px;border-bottom:1px solid rgba(255,255,255,.08);}
.sb-logo-mark{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;letter-spacing:.16em;color:var(--paper);}
.sb-logo-mark em{color:#e87070;font-style:normal;}
.sb-logo-sub{font-size:.58rem;color:rgba(255,255,255,.35);letter-spacing:.12em;text-transform:uppercase;font-family:'Syne',sans-serif;margin-top:2px;}
.sb-user{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px;}
.sb-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:800;flex-shrink:0;}
.sb-user-name{font-family:'Syne',sans-serif;font-size:.76rem;font-weight:700;color:var(--paper);}
.sb-user-role{font-size:.58rem;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em;font-family:'Syne',sans-serif;}
.sb-section{padding:14px 16px 6px;font-family:'Syne',sans-serif;font-size:.54rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.28);}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;transition:background .15s;border-radius:0;font-family:'Syne',sans-serif;font-size:.72rem;font-weight:600;color:rgba(255,255,255,.6);letter-spacing:.04em;position:relative;}
.sb-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.9);}
.sb-item.active{background:rgba(255,255,255,.1);color:#fff;}
.sb-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#e87070;border-radius:0 2px 2px 0;}
.sb-icon{font-size:.9rem;flex-shrink:0;width:18px;text-align:center;}
.sb-badge{margin-left:auto;background:#e87070;color:#fff;font-size:.55rem;font-weight:800;font-family:'Syne',sans-serif;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center;}
.sb-bottom{margin-top:auto;padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);}
.sb-logout{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:4px;color:rgba(255,255,255,.5);font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:8px;cursor:pointer;transition:all .18s;}
.sb-logout:hover{background:rgba(184,50,50,.3);color:#fff;border-color:rgba(184,50,50,.5);}

/* ‚îÄ‚îÄ MAIN AREA ‚îÄ‚îÄ */
.main{overflow-y:auto;display:flex;flex-direction:column;}
.page{display:none;flex:1;padding:24px 28px 60px;}
.page.active{display:block;}
.page-title{font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.page-heading{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;margin-bottom:20px;color:var(--ink);}

/* ‚îÄ‚îÄ STORAGE MODE BAR ‚îÄ‚îÄ */
.storage-bar{background:var(--p2);border-bottom:1px solid var(--ruled);padding:6px 28px;display:flex;align-items:center;gap:12px;font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.storage-mode-tag{padding:3px 9px;border-radius:3px;font-size:.58rem;}
.sm-local{background:rgba(42,110,72,.15);color:var(--green);}
.sm-gdrive{background:rgba(30,79,130,.15);color:var(--blue);}
.sm-server{background:rgba(94,30,130,.15);color:var(--purple);}
.sync-btn{margin-left:auto;background:none;border:1px solid var(--ruled);border-radius:3px;padding:3px 10px;font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;color:var(--muted);transition:all .18s;}
.sync-btn:hover{border-color:var(--ink);color:var(--ink);}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px;}
.sync-dot.warn{background:var(--amber);}
.sync-dot.err{background:var(--red);}

/* ‚îÄ‚îÄ NOTIFICATION BANNER ‚îÄ‚îÄ */
.notif-bar{position:fixed;top:0;left:220px;right:0;z-index:800;display:flex;flex-direction:column;gap:0;pointer-events:none;}
.notif{background:var(--ink);color:var(--paper);padding:12px 20px;display:flex;align-items:center;gap:12px;font-size:.78rem;animation:slideDown .3s ease;pointer-events:all;border-bottom:1px solid rgba(255,255,255,.1);}
@keyframes slideDown{from{transform:translateY(-100%);opacity:0;}to{transform:translateY(0);opacity:1;}}
.notif-icon{font-size:1rem;flex-shrink:0;}
.notif-text{flex:1;}
.notif-close{background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;font-size:1rem;}

/* ‚îÄ‚îÄ CARDS & GRIDS ‚îÄ‚îÄ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.card{background:var(--p2);border:1px solid var(--ruled);border-radius:8px;padding:18px;}
.card.white{background:var(--paper);}
.stat-card{text-align:center;padding:16px;}
.stat-val{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;line-height:1;}
.stat-lbl{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;font-family:'Syne',sans-serif;font-weight:700;margin-top:4px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{font-family:'Syne',sans-serif;font-size:.64rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;border-radius:4px;padding:8px 16px;cursor:pointer;border:1.5px solid;transition:all .18s;white-space:nowrap;}
.btn-primary{background:var(--ink);color:var(--paper);border-color:var(--ink);}
.btn-primary:hover{background:var(--red);border-color:var(--red);}
.btn-secondary{background:transparent;color:var(--muted);border-color:var(--ruled);}
.btn-secondary:hover{border-color:var(--ink);color:var(--ink);}
.btn-danger{background:transparent;color:var(--red);border-color:var(--red);}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-green{background:var(--green);color:#fff;border-color:var(--green);}
.btn-blue{background:var(--blue);color:#fff;border-color:var(--blue);}
.btn-sm{padding:5px 11px;font-size:.58rem;}
.btn-xs{padding:3px 8px;font-size:.54rem;}
.btn-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.fg{display:flex;flex-direction:column;gap:4px;margin-bottom:13px;}
.fg label,.form-label{font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);}
.fi,.fsel,.fta{background:var(--p2);border:1.5px solid var(--ruled);border-radius:4px;padding:9px 12px;color:var(--ink);font-family:'Instrument Sans',sans-serif;font-size:.84rem;outline:none;transition:border-color .18s;width:100%;}
.fi:focus,.fsel:focus,.fta:focus{border-color:var(--ink);}
.fi::placeholder,.fta::placeholder{color:var(--faint);}
.fta{resize:vertical;min-height:70px;}
.fsel option{background:var(--paper);}
.form-row{display:grid;gap:12px;margin-bottom:13px;}
.form-row.c2{grid-template-columns:1fr 1fr;}
.form-row.c3{grid-template-columns:1fr 1fr 1fr;}
.form-row.c1{grid-template-columns:1fr;}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.tbl{width:100%;border-collapse:collapse;font-size:.78rem;}
.tbl th{font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);padding:8px 12px;text-align:left;border-bottom:1.5px solid var(--ruled);}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--ruled);vertical-align:middle;}
.tbl tr:last-child td{border-bottom:none;}
.tbl tr:hover td{background:var(--p2);}
.tbl-wrap{background:var(--paper);border:1px solid var(--ruled);border-radius:8px;overflow:hidden;}

/* ‚îÄ‚îÄ STATUS BADGES ‚îÄ‚îÄ */
.status-badge{font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:3px 8px;border-radius:3px;white-space:nowrap;}

/* ‚îÄ‚îÄ TASK CARDS (team) ‚îÄ‚îÄ */
.team-task{background:var(--paper);border:1px solid var(--ruled);border-radius:6px;padding:13px 15px;margin-bottom:8px;animation:slideIn .22s ease;transition:box-shadow .18s;}
.team-task:hover{box-shadow:var(--sh);}
@keyframes slideIn{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}
.tt-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:6px;}
.tt-title{font-family:'Syne',sans-serif;font-size:.84rem;font-weight:700;flex:1;line-height:1.3;}
.tt-meta{display:flex;align-items:center;gap:8px;font-size:.68rem;color:var(--muted);flex-wrap:wrap;}
.tt-actions{display:flex;gap:5px;align-items:center;flex-shrink:0;}
.assign-chip{display:flex;align-items:center;gap:5px;background:var(--p2);border-radius:50px;padding:3px 9px 3px 5px;font-size:.66rem;font-family:'Syne',sans-serif;font-weight:600;}
.assign-avatar{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:800;font-family:'Syne',sans-serif;flex-shrink:0;}

/* ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ */
.inbox-item{background:var(--paper);border:1.5px solid var(--amber);border-radius:6px;padding:13px 15px;margin-bottom:8px;}
.inbox-from{font-size:.66rem;color:var(--muted);margin-bottom:4px;font-family:'Syne',sans-serif;font-weight:600;}
.inbox-title{font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;margin-bottom:6px;}
.inbox-actions{display:flex;gap:7px;margin-top:10px;}

/* ‚îÄ‚îÄ OVERLAYS / MODALS ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;z-index:900;background:rgba(18,16,14,.5);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(4px);}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--paper);border:1px solid var(--ruled);border-radius:9px;width:560px;max-width:96vw;max-height:92vh;overflow-y:auto;padding:28px;box-shadow:var(--shl);transform:translateY(12px);transition:transform .25s;position:relative;}
.overlay.open .modal{transform:translateY(0);}
.modal-sm{width:420px;}
.modal-lg{width:760px;}
.modal-title{font-family:'Syne',sans-serif;font-size:.96rem;font-weight:800;margin-bottom:3px;}
.modal-sub{font-size:.78rem;color:var(--muted);margin-bottom:22px;font-style:italic;}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;padding-top:16px;border-top:1px solid var(--ruled);}

/* TABS inside modal */
.tab-bar{display:flex;gap:0;border:1px solid var(--ruled);border-radius:4px;overflow:hidden;margin-bottom:18px;}
.tab-btn{flex:1;font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;border:none;background:transparent;color:var(--muted);padding:8px;cursor:pointer;transition:all .18s;}
.tab-btn.active{background:var(--ink);color:var(--paper);}
.tab-panel{display:none;} .tab-panel.active{display:block;}

/* ‚îÄ‚îÄ PERMISSIONS MATRIX ‚îÄ‚îÄ */
.perm-matrix{overflow-x:auto;}
.perm-table{border-collapse:collapse;min-width:500px;}
.perm-table th,.perm-table td{padding:8px 10px;text-align:center;border:1px solid var(--ruled);font-size:.72rem;}
.perm-table th:first-child,.perm-table td:first-child{text-align:left;font-weight:600;}
.perm-check{width:16px;height:16px;cursor:pointer;accent-color:var(--green);}

/* ‚îÄ‚îÄ WORKLOAD BAR ‚îÄ‚îÄ */
.workload-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.wl-name{width:120px;font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;flex-shrink:0;}
.wl-bar-track{flex:1;height:10px;background:var(--p3);border-radius:5px;overflow:hidden;}
.wl-bar-fill{height:100%;border-radius:5px;transition:width .5s ease;}
.wl-count{font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;width:40px;text-align:right;color:var(--muted);}

/* ‚îÄ‚îÄ EMAIL COMPOSER ‚îÄ‚îÄ */
.email-preview{background:var(--p2);border:1px solid var(--ruled);border-radius:5px;padding:14px;font-size:.78rem;line-height:1.7;margin:12px 0;color:var(--ink);white-space:pre-wrap;font-family:monospace;}
.schedule-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

/* ‚îÄ‚îÄ STORAGE SWITCHER ‚îÄ‚îÄ */
.storage-options{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:18px;}
.storage-opt{border:2px solid var(--ruled);border-radius:7px;padding:16px;cursor:pointer;transition:all .18s;text-align:center;}
.storage-opt:hover,.storage-opt.active{border-color:var(--ink);background:var(--p2);}
.storage-opt-icon{font-size:1.6rem;margin-bottom:6px;}
.storage-opt-name{font-family:'Syne',sans-serif;font-size:.7rem;font-weight:800;letter-spacing:.06em;}
.storage-opt-desc{font-size:.64rem;color:var(--muted);margin-top:3px;line-height:1.4;}

/* ‚îÄ‚îÄ CATEGORY MANAGER ‚îÄ‚îÄ */
.cat-chip{display:inline-flex;align-items:center;gap:6px;background:var(--p2);border:1px solid var(--ruled);border-radius:50px;padding:4px 10px 4px 8px;font-size:.68rem;font-family:'Syne',sans-serif;font-weight:700;margin:3px;}
.cat-chip-del{background:none;border:none;cursor:pointer;color:var(--muted);font-size:.8rem;line-height:1;padding:0 2px;}
.cat-chip-del:hover{color:var(--red);}
.cat-color-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.cat-section{background:var(--paper);border:1px solid var(--ruled);border-radius:7px;padding:16px;margin-bottom:14px;}
.cat-section-title{font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.add-cat-row{display:flex;gap:8px;align-items:center;margin-top:10px;}

/* ‚îÄ‚îÄ VISUAL TIMELINE ‚îÄ‚îÄ */
.vtl-wrap{position:relative;background:var(--paper);border-radius:8px;}
.modal-x{position:absolute;top:12px;right:14px;background:none;border:none;font-size:1.3rem;color:var(--muted);cursor:pointer;line-height:1;padding:2px 6px;border-radius:4px;transition:background .15s,color .15s;}
.modal-x:hover{background:var(--ruled);color:var(--ink);}
.vtl-header{display:grid;border-bottom:2px solid var(--ruled);}
.vtl-hour-col{font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;color:var(--muted);text-align:right;padding:5px 8px 5px 0;border-right:1px solid var(--ruled);width:44px;flex-shrink:0;}
.vtl-body{position:relative;}
.vtl-row{display:flex;border-bottom:1px solid rgba(207,200,184,.4);min-height:52px;position:relative;}
.vtl-row.half{min-height:28px;border-bottom:1px dashed rgba(207,200,184,.25);}
.vtl-row:hover{background:rgba(207,200,184,.12);}
.vtl-time{font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;color:var(--muted);width:44px;flex-shrink:0;border-right:1px solid var(--ruled);padding:4px 6px 0 0;text-align:right;background:var(--p2);}
.vtl-slot{flex:1;position:relative;padding:2px 4px;}
.vtl-block{border-radius:4px;padding:5px 9px;margin:2px 2px;cursor:pointer;transition:opacity .15s,box-shadow .15s;position:relative;overflow:hidden;}
.vtl-block:hover{opacity:.88;box-shadow:0 2px 8px rgba(0,0,0,.15);}
.vtl-block-name{font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.vtl-block-meta{font-size:.58rem;opacity:.75;margin-top:1px;}
.vtl-block-time{font-size:.56rem;opacity:.65;font-family:'Syne',sans-serif;font-weight:700;}
.vtl-now-line{position:absolute;left:44px;right:0;height:2px;background:var(--red);z-index:10;pointer-events:none;}
.vtl-now-line::before{content:'';position:absolute;left:-4px;top:-4px;width:10px;height:10px;border-radius:50%;background:var(--red);}
.vtl-now-label{position:absolute;left:2px;font-family:'Syne',sans-serif;font-size:.54rem;font-weight:800;color:var(--red);background:var(--paper);padding:1px 3px;border-radius:2px;}

/* ‚îÄ‚îÄ DAY PLANNER (day divider) ‚îÄ‚îÄ */
.dp-wrap{background:var(--paper);border:1px solid var(--ruled);border-radius:8px;overflow:hidden;}
.dp-zone{border-bottom:1px solid var(--ruled);padding:14px 16px;cursor:pointer;transition:background .15s;display:flex;align-items:center;gap:12px;}
.dp-zone:last-child{border-bottom:none;}
.dp-zone:hover{background:var(--p2);}
.dp-zone-color{width:6px;align-self:stretch;border-radius:3px;flex-shrink:0;min-height:36px;}
.dp-zone-body{flex:1;}
.dp-zone-name{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;}
.dp-zone-time{font-size:.7rem;color:var(--muted);margin-top:2px;}
.dp-zone-tasks{font-size:.68rem;color:var(--muted);margin-top:3px;}
.dp-zone-edit{opacity:0;transition:opacity .15s;}
.dp-zone:hover .dp-zone-edit{opacity:1;}
.dp-add-btn{width:100%;background:transparent;border:2px dashed var(--ruled);border-radius:6px;padding:12px;font-family:'Syne',sans-serif;font-size:.64rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all .18s;margin-top:10px;}
.dp-add-btn:hover{border-color:var(--ink);color:var(--ink);}

/* ‚îÄ‚îÄ RECURRING BADGE ‚îÄ‚îÄ */
.recur-badge{display:inline-flex;align-items:center;gap:3px;background:rgba(26,110,110,.12);color:var(--teal);border-radius:3px;padding:2px 7px;font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--ruled);border-radius:3px;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:22px;right:22px;z-index:9999;background:var(--ink);color:var(--paper);border-radius:5px;padding:10px 16px;font-family:'Syne',sans-serif;font-size:.7rem;font-weight:600;letter-spacing:.06em;transform:translateY(14px);opacity:0;transition:all .25s;pointer-events:none;max-width:280px;}
.toast.show{transform:translateY(0);opacity:1;}

/* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
.drop-zone{border:2px dashed var(--ruled);border-radius:6px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;}
.drop-zone:hover,.drop-zone.drag{border-color:var(--blue);background:rgba(30,79,130,.05);}
.drop-icon{font-size:1.8rem;margin-bottom:6px;}
.drop-label{font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;color:var(--muted);}

/* ‚ïê‚ïê TEAMS ‚ïê‚ïê */
.team-chip{display:inline-flex;align-items:center;gap:5px;border-radius:50px;padding:3px 10px 3px 6px;font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;}
.team-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.kanban-board{display:flex;gap:14px;overflow-x:auto;padding-bottom:12px;min-height:300px;}
.kanban-col{background:var(--p2);border:1px solid var(--ruled);border-radius:8px;min-width:220px;flex:0 0 220px;display:flex;flex-direction:column;}
.kanban-col-hdr{padding:12px 14px;border-bottom:1px solid var(--ruled);display:flex;align-items:center;justify-content:space-between;}
.kanban-col-title{font-family:'Syne',sans-serif;font-size:.65rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;}
.kanban-col-count{font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;background:var(--paper);border-radius:50px;padding:1px 8px;color:var(--muted);}
.kanban-cards{padding:8px;display:flex;flex-direction:column;gap:6px;flex:1;overflow-y:auto;}
.kanban-card{background:var(--paper);border:1px solid var(--ruled);border-radius:6px;padding:10px 12px;cursor:pointer;transition:box-shadow .15s;}
.kanban-card:hover{box-shadow:var(--sh);}
.kc-title{font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;margin-bottom:5px;line-height:1.3;}
.kc-meta{font-size:.63rem;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.gantt-wrap{overflow-x:auto;}
.gantt-table{min-width:900px;border-collapse:collapse;}
.gantt-table th{font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:8px 10px;text-align:left;border-bottom:1.5px solid var(--ruled);white-space:nowrap;}
.gantt-table td{padding:6px 10px;border-bottom:1px solid var(--ruled);vertical-align:middle;font-size:.75rem;}
.gantt-bar-wrap{position:relative;height:20px;background:var(--p3);border-radius:3px;overflow:hidden;min-width:100px;}
.gantt-bar{position:absolute;top:0;height:100%;border-radius:3px;opacity:.85;}
.gantt-today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--red);z-index:5;}

/* ‚ïê‚ïê AI ‚ïê‚ïê */
.ai-chat-fab{position:fixed;bottom:24px;right:24px;z-index:600;background:linear-gradient(135deg,#1e4f82,#5e1e82);color:#fff;border:none;border-radius:50px;padding:12px 18px;font-family:'Syne',sans-serif;font-size:.68rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;box-shadow:0 4px 20px rgba(30,79,130,.4);transition:all .22s;display:flex;align-items:center;gap:8px;}
.ai-chat-fab:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(30,79,130,.5);}
.ai-panel{position:fixed;bottom:80px;right:24px;z-index:601;width:380px;max-height:600px;background:var(--paper);border:1px solid var(--ruled);border-radius:12px;box-shadow:var(--shl);display:flex;flex-direction:column;transform:translateY(20px);opacity:0;pointer-events:none;transition:all .25s;}
.ai-panel.open{transform:translateY(0);opacity:1;pointer-events:all;}
.ai-panel-hdr{padding:14px 16px;border-bottom:1px solid var(--ruled);display:flex;align-items:center;gap:10px;}
.ai-panel-title{font-family:'Syne',sans-serif;font-size:.76rem;font-weight:800;flex:1;}
.ai-panel-sub{font-size:.6rem;color:var(--muted);font-family:'Syne',sans-serif;}
.ai-panel-close{background:none;border:none;cursor:pointer;color:var(--muted);font-size:1.1rem;}
.ai-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;max-height:380px;}
.ai-msg{max-width:88%;padding:9px 12px;border-radius:8px;font-size:.76rem;line-height:1.5;}
.ai-msg.user{background:var(--ink);color:var(--paper);align-self:flex-end;border-radius:8px 8px 2px 8px;}
.ai-msg.ai{background:var(--p2);color:var(--ink);align-self:flex-start;border-radius:8px 8px 8px 2px;border:1px solid var(--ruled);}
.ai-msg.ai.thinking{opacity:.6;font-style:italic;}
.ai-input-row{padding:10px 12px;border-top:1px solid var(--ruled);display:flex;gap:8px;}
.ai-input{flex:1;background:var(--p2);border:1.5px solid var(--ruled);border-radius:6px;padding:8px 12px;font-family:'Instrument Sans',sans-serif;font-size:.8rem;outline:none;resize:none;height:36px;}
.ai-input:focus{border-color:var(--blue);}
.ai-send{background:var(--blue);color:#fff;border:none;border-radius:6px;padding:8px 14px;font-family:'Syne',sans-serif;font-size:.64rem;font-weight:700;cursor:pointer;transition:background .15s;white-space:nowrap;}
.ai-send:hover{background:#1a3f6e;}
.ai-send:disabled{opacity:.5;cursor:not-allowed;}
.ai-suggestion-strip{padding:8px 12px;display:flex;gap:6px;flex-wrap:wrap;border-bottom:1px solid var(--ruled);}
.ai-suggestion{background:var(--p2);border:1px solid var(--ruled);border-radius:50px;padding:4px 10px;font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;}
.ai-suggestion:hover{background:var(--ink);color:var(--paper);}
.ai-inline-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(30,79,130,.1),rgba(94,30,130,.1));border:1px solid rgba(30,79,130,.2);border-radius:4px;padding:2px 7px;font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;color:var(--blue);letter-spacing:.06em;}
.ai-risk-badge{background:rgba(184,50,50,.1);color:var(--red);border-color:rgba(184,50,50,.2);}
.ai-parse-preview{background:var(--p2);border:1.5px solid var(--blue);border-radius:7px;padding:14px;margin:10px 0;font-size:.76rem;}
.ai-parse-preview .ap-title{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--blue);margin-bottom:10px;}
.ai-parse-field{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.ai-parse-field label{font-size:.6rem;color:var(--muted);width:80px;flex-shrink:0;font-family:'Syne',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:.08em;}
.ai-parse-val{font-weight:600;color:var(--ink);}

/* ‚ïê‚ïê TEAM DASHBOARD ‚ïê‚ïê */
.tdb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-bottom:20px;}
.tdb-person-card{background:var(--paper);border:1px solid var(--ruled);border-radius:8px;padding:16px;position:relative;overflow:hidden;}
.tdb-person-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.tdb-person-card.green::before{background:var(--green);}
.tdb-person-card.amber::before{background:var(--amber);}
.tdb-person-card.red::before{background:var(--red);}
.traffic-light{display:flex;gap:5px;margin-bottom:10px;}
.tl-dot{width:12px;height:12px;border-radius:50%;opacity:.25;transition:opacity .3s;}
.tl-dot.active{opacity:1;}
.tl-red{background:#e74c3c;} .tl-amber{background:#f39c12;} .tl-green{background:#27ae60;}
.tdb-person-name{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:800;margin-bottom:4px;}
.tdb-person-role{font-size:.62rem;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.08em;font-family:'Syne',sans-serif;font-weight:700;}
.tdb-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:.66rem;}
.tdb-bar-label{width:60px;color:var(--muted);flex-shrink:0;font-family:'Syne',sans-serif;font-weight:700;}
.tdb-bar-track{flex:1;height:6px;background:var(--p3);border-radius:3px;overflow:hidden;}
.tdb-bar-fill{height:100%;border-radius:3px;}
.tdb-bar-val{width:28px;text-align:right;font-weight:700;font-family:'Syne',sans-serif;}
.risk-ribbon{background:rgba(184,50,50,.08);border:1px solid rgba(184,50,50,.2);border-radius:6px;padding:10px 12px;margin-top:10px;font-size:.68rem;}
.risk-ribbon-title{font-family:'Syne',sans-serif;font-size:.58rem;font-weight:800;color:var(--red);letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;}
.ai-insight-card{background:linear-gradient(135deg,rgba(30,79,130,.06),rgba(94,30,130,.06));border:1px solid rgba(30,79,130,.2);border-radius:8px;padding:16px;margin-bottom:16px;}
.ai-insight-title{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;color:var(--blue);letter-spacing:.14em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.ai-insight-item{font-size:.75rem;line-height:1.6;margin-bottom:4px;padding-left:14px;position:relative;}
.ai-insight-item::before{content:'‚ú¶';position:absolute;left:0;font-size:.55rem;color:var(--blue);top:2px;}

/* ‚ïê‚ïê AI LEARNING ‚ïê‚ïê */
.ai-learning-log{background:var(--p2);border:1px solid var(--ruled);border-radius:6px;padding:12px;max-height:180px;overflow-y:auto;font-size:.68rem;line-height:1.8;}
.ai-learn-entry{border-bottom:1px solid var(--ruled);padding:4px 0;display:flex;gap:8px;}
.ai-learn-ts{color:var(--muted);flex-shrink:0;font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;}
.ai-confirm-bar{background:linear-gradient(90deg,rgba(30,79,130,.1),rgba(94,30,130,.08));border:1.5px solid rgba(30,79,130,.25);border-radius:7px;padding:12px 16px;margin:10px 0;display:flex;align-items:center;gap:12px;font-size:.76rem;}
.ai-confirm-bar .ai-confirm-text{flex:1;line-height:1.5;}
.ai-confirm-actions{display:flex;gap:6px;flex-shrink:0;}

/* ‚ïê‚ïê SMTP / EMAIL ‚ïê‚ïê */
.email-provider-card{border:1.5px solid var(--ruled);border-radius:6px;padding:14px;margin-bottom:10px;transition:border-color .18s;}
.email-provider-card.active-provider{border-color:var(--blue);background:rgba(30,79,130,.04);}
.ep-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer;}
.ep-radio{width:16px;height:16px;accent-color:var(--blue);}
.ep-name{font-family:'Syne',sans-serif;font-size:.76rem;font-weight:800;}
.ep-tag{font-size:.58rem;color:var(--green);font-family:'Syne',sans-serif;font-weight:700;background:rgba(42,110,72,.1);padding:2px 7px;border-radius:3px;}
.ep-fields{display:none;}
.ep-fields.visible{display:block;}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:860px){.shell{grid-template-columns:1fr;}.sidebar{height:auto;position:relative;}.notif-bar{left:0;}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">M<em>E</em>RIDIAN</div>
    <div class="login-sub">Team Planner ¬∑ Sign In</div>
    <div class="first-run-note" id="first-run-note" style="display:none">
      ‚ú¶ First run detected. Create your Admin account below. This will be the master account.
    </div>
    <label class="login-label">Username</label>
    <input class="login-input" id="login-user" placeholder="Enter username" autocomplete="username">
    <label class="login-label">Password</label>
    <input class="login-input" type="password" id="login-pass" placeholder="Enter password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()" id="login-btn">Sign In</button>
    <div class="login-err" id="login-err">Invalid username or password.</div>
    <div class="session-info">Sessions expire after 8 hours of inactivity</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <!-- STORAGE BAR -->
  <div class="storage-bar">
    <span><span class="sync-dot" id="sync-dot"></span>Storage:</span>
    <span class="storage-mode-tag sm-local" id="storage-mode-tag">Local</span>
    <span id="sync-status-text" style="font-size:.6rem;">Last synced: Just now</span>
    <button class="sync-btn" onclick="syncNow()">‚ü≥ Sync Now</button>
  </div>

  <!-- NOTIFICATIONS -->
  <div class="notif-bar" id="notif-bar"></div>

  <div class="shell">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sb-logo">
        <div class="sb-logo-mark">M<em>E</em>RIDIAN</div>
        <div class="sb-logo-sub">Team Planner</div>
      </div>
      <div class="sb-user">
        <div class="sb-avatar" id="sb-avatar" style="background:#e87070;color:#fff;">A</div>
        <div>
          <div class="sb-user-name" id="sb-username">‚Äî</div>
          <div class="sb-user-role" id="sb-role">‚Äî</div>
        </div>
      </div>

      <!-- NAV: All users -->
      <div class="sb-section">My Planner</div>
      <div class="sb-item active" onclick="navTo('my-day')" id="nav-my-day"><span class="sb-icon">üìÖ</span>My Day</div>
      <div class="sb-item" onclick="navTo('inbox')" id="nav-inbox"><span class="sb-icon">üì•</span>Inbox<span class="sb-badge" id="inbox-badge" style="display:none">0</span></div>
      <div class="sb-item" onclick="navTo('my-tasks')" id="nav-my-tasks"><span class="sb-icon">‚úì</span>My Tasks</div>
      <div class="sb-item" onclick="navTo('calendar')" id="nav-calendar"><span class="sb-icon">üóì</span>Calendar</div>
      <div class="sb-item" onclick="navTo('day-planner')" id="nav-day-planner"><span class="sb-icon">‚è∞</span>Day Planner</div>
      <div class="sb-section" id="nav-teams-section">My Teams</div>
      <div id="nav-teams-list"><!-- dynamically populated --></div>

      <!-- NAV: Admin / Manager -->
      <div class="sb-section" id="nav-team-section" style="display:none">Team</div>
      <div class="sb-item" onclick="navTo('team-view')" id="nav-team-view" style="display:none"><span class="sb-icon">üë•</span>Team View</div>
      <div class="sb-item" onclick="navTo('assign-task')" id="nav-assign-task" style="display:none"><span class="sb-icon">‚Üó</span>Assign Task</div>
      <div class="sb-item" onclick="navTo('email-center')" id="nav-email-center" style="display:none"><span class="sb-icon">‚úâ</span>Email Center</div>
      <div class="sb-item" onclick="navTo('team-manager')" id="nav-team-manager" style="display:none"><span class="sb-icon">üè¢</span>Manage Teams</div>

      <!-- NAV: Admin only -->
      <div class="sb-section" id="nav-admin-section" style="display:none">Admin</div>
      <div class="sb-item" onclick="navTo('user-manager')" id="nav-user-manager" style="display:none"><span class="sb-icon">üîë</span>User Manager</div>
      <div class="sb-item" onclick="navTo('cat-manager')" id="nav-cat-manager" style="display:none"><span class="sb-icon">üè∑</span>Category Manager</div>
      <div class="sb-item" onclick="navTo('integrations')" id="nav-integrations" style="display:none"><span class="sb-icon">‚öô</span>Integrations</div>

      <div class="sb-bottom">
        <button class="sb-logout" onclick="doLogout()">Sign Out</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">

      <!-- ‚îÄ‚îÄ MY DAY ‚îÄ‚îÄ -->
      <div class="page active" id="page-my-day">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:10px;">
          <div><div class="page-title">Personal Planner</div><div class="page-heading" id="my-day-heading">Today</div></div>
          <div class="btn-row">
            <button class="btn btn-primary btn-sm" onclick="openTaskModal()">+ Task</button>
            <button class="btn btn-secondary btn-sm" onclick="openMeetModal()">+ Meeting</button>
            <button class="btn btn-secondary btn-sm" onclick="navTo('day-planner')">‚è∞ Plan My Day</button>
          </div>
        </div>
        <div class="grid-4" style="margin-bottom:16px;" id="my-day-stats"></div>
        <div style="display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start;">
          <div id="my-day-list"></div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
              <span>Visual Timeline</span>
              <span id="tl-total-time" style="font-size:.6rem;color:var(--muted);font-weight:600;text-transform:none;letter-spacing:0;"></span>
            </div>
            <div id="my-day-timeline" style="height:520px;overflow-y:auto;border:1px solid var(--ruled);border-radius:8px;"></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ DAY PLANNER ‚îÄ‚îÄ -->
      <div class="page" id="page-day-planner">
        <div class="page-title">Personal Schedule</div>
        <div class="page-heading">Day Planner</div>
        <p style="font-size:.78rem;color:var(--muted);margin-bottom:18px;line-height:1.6;">Divide your day into named zones ‚Äî deep work, meetings, admin, personal time. Tasks assigned to a zone will appear in that block on the timeline.</p>
        <div class="grid-2" style="align-items:start;">
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Your Day Zones</div>
            <div class="dp-wrap" id="dp-zones-list"></div>
            <button class="dp-add-btn" onclick="openZoneModal()">+ Add Zone</button>
          </div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Today's Schedule Preview</div>
            <div id="dp-preview-timeline"></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ -->
      <div class="page" id="page-inbox">
        <div class="page-title">Assigned to Me</div>
        <div class="page-heading">Inbox</div>
        <div id="inbox-list"></div>
        <div id="inbox-empty" style="text-align:center;padding:50px;color:var(--muted);display:none;">
          <div style="font-size:2rem;margin-bottom:8px;">üì≠</div>
          <div style="font-family:'Syne',sans-serif;font-weight:700;">Inbox is empty</div>
          <div style="font-size:.78rem;margin-top:4px;">Assigned tasks will appear here</div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ MY TASKS ‚îÄ‚îÄ -->
      <div class="page" id="page-my-tasks">
        <div class="page-title">All My Work</div>
        <div class="page-heading">My Tasks</div>
        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;" id="my-tasks-filters"></div>
        <div id="my-tasks-list"></div>
      </div>

      <!-- ‚îÄ‚îÄ CALENDAR (simplified) ‚îÄ‚îÄ -->
      <div class="page" id="page-calendar">
        <div class="page-title">Schedule</div>
        <div class="page-heading">Calendar</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" onclick="calNav(-1)">&#8249; Prev</button>
          <span id="cal-label" style="font-family:'Syne',sans-serif;font-weight:700;font-size:.86rem;min-width:180px;text-align:center;"></span>
          <button class="btn btn-secondary btn-sm" onclick="calNav(1)">Next &#8250;</button>
          <button class="btn btn-primary btn-sm" onclick="calToday()">Today</button>
          <div style="margin-left:auto;display:flex;gap:3px;background:var(--p2);border:1px solid var(--ruled);border-radius:6px;padding:3px;">
            <button id="cal-view-day"   class="btn btn-xs btn-secondary" onclick="setCalView('day')"   style="border-radius:4px;min-width:38px;">Day</button>
            <button id="cal-view-week"  class="btn btn-xs btn-secondary" onclick="setCalView('week')"  style="border-radius:4px;min-width:38px;">Week</button>
            <button id="cal-view-month" class="btn btn-xs btn-primary"   onclick="setCalView('month')" style="border-radius:4px;min-width:42px;">Month</button>
          </div>
        </div>
        <div id="cal-grid" style="background:var(--paper);border:1px solid var(--ruled);border-radius:8px;overflow:hidden;"></div>
      </div>

      <!-- ‚îÄ‚îÄ TEAM VIEW (admin/manager) ‚îÄ‚îÄ -->
      <div class="page" id="page-team-view">
        <div class="page-title">Admin</div>
        <div class="page-heading">Team Dashboard</div>
        <div class="grid-4" id="team-stats" style="margin-bottom:20px;"></div>

        <!-- Filters -->
        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
          <select class="fsel" style="max-width:160px;" id="tv-filter-user" onchange="renderTeamView()"><option value="">All Members</option></select>
          <select class="fsel" style="max-width:140px;" id="tv-filter-status" onchange="renderTeamView()"><option value="">All Statuses</option></select>
          <select class="fsel" style="max-width:140px;" id="tv-filter-cat" onchange="renderTeamView()"><option value="">All Categories</option></select>
          <input class="fi" style="max-width:200px;" id="tv-filter-search" placeholder="Search tasks..." oninput="renderTeamView()">
        </div>

        <!-- Tabs -->
        <div class="tab-bar" style="max-width:500px;">
          <button class="tab-btn active" onclick="tvTab('tasks',this)">All Tasks</button>
          <button class="tab-btn" onclick="tvTab('workload',this)">Workload</button>
          <button class="tab-btn" onclick="tvTab('deadlines',this)">Upcoming Deadlines</button>
        </div>
        <div class="tab-panel active" id="tv-tasks"><div class="tbl-wrap"><table class="tbl" id="tv-tasks-table"><thead><tr><th>Task</th><th>Assigned To</th><th>Category</th><th>Status</th><th>Deadline</th><th>Priority</th><th>Actions</th></tr></thead><tbody id="tv-tasks-body"></tbody></table></div></div>
        <div class="tab-panel" id="tv-workload"><div id="tv-workload-body" style="padding:8px 0;"></div></div>
        <div class="tab-panel" id="tv-deadlines"><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Task</th><th>Owner</th><th>Deadline</th><th>Status</th><th>Days Left</th></tr></thead><tbody id="tv-deadlines-body"></tbody></table></div></div>
      </div>

      <!-- ‚îÄ‚îÄ ASSIGN TASK ‚îÄ‚îÄ -->
      <div class="page" id="page-assign-task">
        <div class="page-title">Team Management</div>
        <div class="page-heading">Assign Task</div>
        <div style="max-width:600px;">
          <div class="fg"><label>Task Title *</label><input class="fi" id="at-title" placeholder="What needs to be done?"></div>
          <div class="form-row c2">
            <div class="fg"><label>Assign To *</label><select class="fsel" id="at-assignee"></select></div>
            <div class="fg"><label>Category</label><select class="fsel" id="at-category"></select></div>
          </div>
          <div class="form-row c3">
            <div class="fg"><label>Deadline</label><input class="fi" type="date" id="at-deadline"></div>
            <div class="fg"><label>Priority</label><select class="fsel" id="at-priority"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select></div>
            <div class="fg"><label>Duration (min)</label><input class="fi" type="number" id="at-duration" value="60" min="5" step="5"></div>
          </div>
          <div class="fg"><label>Description / Instructions</label><textarea class="fta" id="at-desc" placeholder="Context, steps, links..."></textarea></div>
          <div class="form-row c2">
            <div class="fg"><label>Attachment URL</label><input class="fi" id="at-link" placeholder="https://drive.google.com/..."></div>
            <div class="fg"><label>File Attachment (‚â§500KB)</label><input class="fi" type="file" id="at-file" style="padding:6px;" accept="*/*"></div>
          </div>
          <div class="ai-insight-card" style="margin-bottom:14px;" id="at-ai-hint-card">
            <div class="ai-insight-title"><span>‚ú¶</span>AI Assignment Suggestion</div>
            <div id="at-ai-hint" style="font-size:.74rem;color:var(--muted);">Fill in the task title then click "‚ú¶ AI Suggest Assignee" for a workload-based recommendation.</div>
          </div>
          <div class="fg"><label>Notify via Email?</label>
            <select class="fsel" id="at-notify"><option value="yes">Yes ‚Äî send email notification</option><option value="no">No ‚Äî in-app only</option></select>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="submitAssignment()">‚Üó Assign Task</button>
            <button class="btn btn-secondary" onclick="aiHintAssignee()" id="at-ai-suggest-btn">‚ú¶ AI Suggest Assignee</button>
            <button class="btn btn-secondary" onclick="navTo('team-view')">Cancel</button>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ EMAIL CENTER ‚îÄ‚îÄ -->
      <div class="page" id="page-email-center">
        <div class="page-title">Communications</div>
        <div class="page-heading">Email Center</div>
        <div class="grid-2">
          <div>
            <div class="card" style="margin-bottom:14px;">
              <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Compose Email</div>
              <div class="fg"><label>To</label><select class="fsel" id="em-to"><option value="">Select recipient...</option></select></div>
              <div class="fg"><label>Subject</label><input class="fi" id="em-subject" placeholder="Email subject..."></div>
              <div class="fg"><label>Template</label>
                <select class="fsel" id="em-template" onchange="applyTemplate()">
                  <option value="custom">Custom message</option>
                  <option value="status">Status Update</option>
                  <option value="reminder">Task Reminder</option>
                  <option value="overdue">Overdue Alert</option>
                  <option value="weekly">Weekly Digest</option>
                </select>
              </div>
              <div class="fg"><label>Message</label><textarea class="fta" id="em-body" placeholder="Your message..." style="min-height:120px;"></textarea></div>
              <div class="fg"><label>Schedule Send (optional)</label><input class="fi" type="datetime-local" id="em-schedule"></div>
              <div class="btn-row">
                <button class="btn btn-primary" onclick="sendEmail()">‚úâ Send Now</button>
                <button class="btn btn-secondary" onclick="scheduleEmail()">‚è∞ Schedule</button>
                <button class="btn btn-secondary" onclick="aiDraftEmail()" title="Use AI to write this email based on actual task data">‚ú¶ AI Draft</button>
              </div>
            </div>
          </div>
          <div>
            <div class="card" style="margin-bottom:14px;">
              <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Scheduled Emails</div>
              <div id="scheduled-emails-list"></div>
            </div>
            <div class="card">
              <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Email Log</div>
              <div id="email-log-list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ USER MANAGER (admin) ‚îÄ‚îÄ -->
      <div class="page" id="page-user-manager">
        <div class="page-title">Admin</div>
        <div class="page-heading">User Manager</div>
        <div class="btn-row" style="margin-bottom:16px;">
          <button class="btn btn-primary" onclick="openUserModal()">+ Add User</button>
          <button class="btn btn-secondary" onclick="exportUsers()">‚¨á Export Users</button>
        </div>
        <div class="tbl-wrap" style="margin-bottom:20px;">
          <table class="tbl">
            <thead><tr><th>User</th><th>Role</th><th>Email</th><th>Status</th><th>Last Active</th><th>Can See</th><th>Actions</th></tr></thead>
            <tbody id="user-table-body"></tbody>
          </table>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Visibility Permission Matrix</div>
          <div class="perm-matrix" id="perm-matrix"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ CATEGORY MANAGER (admin) ‚îÄ‚îÄ -->
      <div class="page" id="page-cat-manager">
        <div class="page-title">Admin</div>
        <div class="page-heading">Category Manager</div>
        <div class="grid-2">
          <div>
            <div class="cat-section">
              <div class="cat-section-title">Task Statuses</div>
              <div id="cat-statuses"></div>
              <div class="add-cat-row">
                <input class="fi" id="new-status-name" placeholder="Status name..." style="flex:1">
                <input type="color" id="new-status-color" value="#2a6e48" style="width:36px;height:36px;border:1px solid var(--ruled);border-radius:4px;cursor:pointer;padding:2px;">
                <button class="btn btn-primary btn-sm" onclick="addStatus()">Add</button>
              </div>
            </div>
            <div class="cat-section">
              <div class="cat-section-title">Task Categories</div>
              <div id="cat-categories"></div>
              <div class="add-cat-row">
                <input class="fi" id="new-cat-name" placeholder="Category name..." style="flex:1">
                <input type="color" id="new-cat-color" value="#1e4f82" style="width:36px;height:36px;border:1px solid var(--ruled);border-radius:4px;cursor:pointer;padding:2px;">
                <button class="btn btn-primary btn-sm" onclick="addCategory()">Add</button>
              </div>
            </div>
          </div>
          <div>
            <div class="cat-section">
              <div class="cat-section-title">Meeting Types</div>
              <div id="cat-meet-types"></div>
              <div class="add-cat-row">
                <input class="fi" id="new-meet-type" placeholder="Meeting type..." style="flex:1">
                <button class="btn btn-primary btn-sm" onclick="addMeetType()">Add</button>
              </div>
            </div>
            <div class="cat-section">
              <div class="cat-section-title">Priority Levels</div>
              <div id="cat-priorities"></div>
              <div class="add-cat-row">
                <input class="fi" id="new-priority" placeholder="Priority name..." style="flex:1">
                <input type="color" id="new-priority-color" value="#b83232" style="width:36px;height:36px;border:1px solid var(--ruled);border-radius:4px;cursor:pointer;padding:2px;">
                <button class="btn btn-primary btn-sm" onclick="addPriority()">Add</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ INTEGRATIONS (admin) ‚îÄ‚îÄ -->
      <div class="page" id="page-integrations">
        <div class="page-title">Admin</div>
        <div class="page-heading">Integrations & Settings</div>

        <!-- Storage Mode -->
        <div class="card" style="margin-bottom:18px;">
          <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Storage Mode</div>
          <div class="storage-options">
            <div class="storage-opt active" id="so-local" onclick="setStorageMode('local')">
              <div class="storage-opt-icon">üíæ</div>
              <div class="storage-opt-name">Local Only</div>
              <div class="storage-opt-desc">Works offline. Data on this device only.</div>
            </div>
            <div class="storage-opt" id="so-gdrive" onclick="setStorageMode('gdrive')">
              <div class="storage-opt-icon">‚òÅ</div>
              <div class="storage-opt-name">Google Drive</div>
              <div class="storage-opt-desc">Shared file in Drive. Syncs across team.</div>
            </div>
            <div class="storage-opt" id="so-server" onclick="setStorageMode('server')">
              <div class="storage-opt-icon">üñ•</div>
              <div class="storage-opt-name">Server / API</div>
              <div class="storage-opt-desc">Self-hosted endpoint. Full multi-user.</div>
            </div>
          </div>
          <div id="gdrive-config" style="display:none;margin-top:12px;">
            <div class="fg"><label>Google Drive API Key</label><input class="fi" id="gdrive-api-key" placeholder="AIza..."></div>
            <div class="fg"><label>Client ID</label><input class="fi" id="gdrive-client-id" placeholder="...apps.googleusercontent.com"></div>
            <div class="fg"><label>Shared Folder ID (leave blank for root)</label><input class="fi" id="gdrive-folder-id" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs..."></div>
            <button class="btn btn-blue" onclick="connectGDrive()">Connect Google Drive</button>
          </div>
          <div id="server-config" style="display:none;margin-top:12px;">
            <div class="fg"><label>API Endpoint URL</label><input class="fi" id="server-url" placeholder="https://your-server.com/api/meridian"></div>
            <div class="fg"><label>API Key / Token (optional)</label><input class="fi" id="server-token" placeholder="Bearer token or API key"></div>
            <div class="fg"><label>Sync Interval (seconds)</label><input class="fi" type="number" id="server-interval" value="30" min="10"></div>
            <button class="btn btn-blue" onclick="testServerConnection()">Test Connection</button>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;">
            <button class="btn btn-primary btn-sm" onclick="exportData()">‚¨á Export All Data (JSON)</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-data-file').click()">‚¨Ü Import Data (JSON)</button>
            <input type="file" id="import-data-file" accept=".json" style="display:none" onchange="importData(this)">
          </div>
        </div>

        <!-- AI Configuration -->
        <div class="card" style="margin-bottom:18px;border-left:3px solid var(--blue);">
          <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--blue);margin-bottom:14px;">‚ú¶ AI Configuration</div>
          <div class="form-row c2">
            <div class="fg"><label>AI Provider</label>
              <select class="fsel" id="ai-provider" onchange="updateAIProviderUI()">
                <option value="gemini">Google Gemini (free, no card)</option>
                <option value="groq">Groq (free, Llama 3 / Mixtral)</option>
                <option value="openrouter">OpenRouter (free models)</option>
                <option value="huggingface">Hugging Face (free, slower)</option>
              </select>
            </div>
            <div class="fg"><label>API Key *</label><input class="fi" id="ai-api-key" placeholder="Get free key from provider site"></div>
          </div>
          <div class="fg" id="ai-model-wrap"><label>Model (optional override)</label><input class="fi" id="ai-model" placeholder="e.g. gemini-pro, llama3-8b-8192"></div>
          <div class="btn-row">
            <button class="btn btn-blue btn-sm" onclick="saveAIConfig()">Save AI Config</button>
            <button class="btn btn-secondary btn-sm" onclick="testAI()">Test AI</button>
          </div>
          <div style="margin-top:10px;font-size:.72rem;color:var(--muted);line-height:1.7;" id="ai-provider-hint">
            ‚ú¶ <strong>Gemini:</strong> aistudio.google.com ‚Üí Get API key (free, generous quota)<br>
            ‚ú¶ <strong>Groq:</strong> console.groq.com ‚Üí Create API key (free, very fast)<br>
            ‚ú¶ <strong>OpenRouter:</strong> openrouter.ai ‚Üí Free credits on signup<br>
            ‚ú¶ <strong>Hugging Face:</strong> huggingface.co/settings/tokens ‚Üí Free inference
          </div>
        </div>

        <!-- Email Provider -->
        <div class="card" style="margin-bottom:18px;">
          <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Email Provider</div>
          <div class="fg"><label>Active Provider</label>
            <select class="fsel" id="email-provider" onchange="updateEmailProviderUI()">
              <option value="emailjs">EmailJS (200/month free, zero setup)</option>
              <option value="resend">Resend (3,000/month free ‚≠ê)</option>
              <option value="web3forms">Web3Forms (250/month free, no backend!)</option>
              <option value="smtp">SMTP ‚Äî Gmail / Outlook (free, unlimited)</option>
              <option value="sendgrid">SendGrid (100/day free)</option>
              <option value="webhook">Webhook / Zapier / Custom API</option>
            </select>
          </div>

          <!-- EmailJS -->
          <div id="ep-emailjs">
            <div class="form-row c3">
              <div class="fg"><label>Service ID</label><input class="fi" id="ejs-service" placeholder="service_xxxxxx"></div>
              <div class="fg"><label>Template ID</label><input class="fi" id="ejs-template" placeholder="template_xxxxxx"></div>
              <div class="fg"><label>Public Key</label><input class="fi" id="ejs-pubkey" placeholder="xxxxxxxxxxxxxx"></div>
            </div>
            <div style="font-size:.7rem;color:var(--muted);">Sign up at emailjs.com ¬∑ Template vars: <code>{{to_name}} {{to_email}} {{subject}} {{message}}</code></div>
          </div>

          <!-- Resend -->
          <div id="ep-resend" class="email-provider-card" style="display:none;">
            <div class="fg"><label>Resend API Key</label><input class="fi" id="resend-key" placeholder="re_xxxxxxxxxxxx"></div>
            <div class="fg"><label>From Email (verified domain)</label><input class="fi" id="resend-from" placeholder="noreply@yourdomain.com"></div>
            <div style="font-size:.7rem;color:var(--muted);line-height:1.7;">‚ú¶ Sign up at <strong>resend.com</strong> (free: 3,000/month, 100/day)<br>‚ú¶ Add & verify your domain, then create an API key</div>
          </div>

          <!-- Web3Forms (free, no backend) -->
          <div id="ep-web3forms" class="email-provider-card" style="display:none;">
            <div style="font-size:.72rem;background:rgba(42,110,72,.08);border-radius:5px;padding:10px;margin-bottom:12px;line-height:1.7;">
              ‚ú¶ <strong>Web3Forms</strong> ‚Äî 250 free emails/month, no backend, no domain needed!<br>
              ‚ú¶ Sign up at <strong>web3forms.com</strong> ‚Üí get your Access Key instantly (email not verified)<br>
              ‚ú¶ Emails are sent FROM web3forms.com servers but TO your recipients
            </div>
            <div class="fg"><label>Web3Forms Access Key *</label><input class="fi" id="w3f-key" placeholder="Get free key at web3forms.com"></div>
            <div class="fg"><label>Reply-To Email (so recipients can reply back)</label><input class="fi" id="w3f-replyto" placeholder="your@email.com"></div>
          </div>

          <!-- SMTP (via relay) -->
          <div id="ep-smtp" class="email-provider-card" style="display:none;">
            <div style="font-size:.72rem;color:var(--muted);margin-bottom:12px;line-height:1.6;background:var(--p2);border-radius:5px;padding:10px;">
              ‚ú¶ <strong>SMTP via Relay:</strong> Browsers can't connect to SMTP directly. You need a tiny Node.js relay (free, 5 min setup).<br>
              ‚ú¶ <strong>Quick relay setup:</strong> <code>npx meridian-smtp-relay</code> ‚Äî or copy the relay code from the button below.<br>
              ‚ú¶ <strong>Gmail App Password:</strong> myaccount.google.com ‚Üí Security ‚Üí 2FA ‚Üí App Passwords ‚Üí use smtp.gmail.com:587<br>
              ‚ú¶ <strong>Outlook:</strong> smtp-mail.outlook.com:587 with your Microsoft account<br>
              ‚ú¶ <strong>‚≠ê Recommended alternative:</strong> Use Resend or Web3Forms instead ‚Äî they work directly in the browser with no relay needed
            </div>
            <div class="form-row c2">
              <div class="fg"><label>SMTP Host</label><input class="fi" id="smtp-host" placeholder="smtp.gmail.com"></div>
              <div class="fg"><label>Port</label><input class="fi" id="smtp-port" placeholder="587" value="587" type="number"></div>
            </div>
            <div class="form-row c2">
              <div class="fg"><label>Username / Email</label><input class="fi" id="smtp-user" placeholder="you@gmail.com"></div>
              <div class="fg"><label>Password / App Password</label><input class="fi" type="password" id="smtp-pass" placeholder="app-password"></div>
            </div>
            <div class="fg"><label>From Email</label><input class="fi" id="smtp-from" placeholder="you@gmail.com"></div>
            <div class="fg"><label>Relay Endpoint URL</label><input class="fi" id="smtp-relay-url" placeholder="http://localhost:3001/send (your Node relay)"></div>
            <div class="fg"><label>Relay Auth Token (optional)</label><input class="fi" id="smtp-relay-auth" placeholder="Bearer token if relay requires auth"></div>
            <button class="btn btn-secondary btn-sm" onclick="copyRelayScript()" style="margin-top:4px;">üìã Copy Relay Server Script (Node.js)</button>
          </div>

          <!-- SendGrid -->
          <div id="ep-sendgrid" class="email-provider-card" style="display:none;">
            <div class="fg"><label>SendGrid API Key</label><input class="fi" id="sg-key" placeholder="SG.xxxxxxxxxxxxxxxxxxxx"></div>
            <div class="fg"><label>From Email (verified sender)</label><input class="fi" id="sg-from" placeholder="sender@yourdomain.com"></div>
            <div style="font-size:.7rem;color:var(--muted);">Sign up at sendgrid.com ¬∑ Free: 100 emails/day forever</div>
          </div>

          <!-- Webhook -->
          <div id="ep-webhook" class="email-provider-card" style="display:none;">
            <div class="fg"><label>Webhook / API Endpoint URL</label><input class="fi" id="webhook-url" placeholder="https://hooks.zapier.com/... or https://your-api.com/send-email"></div>
            <div class="fg"><label>Authorization Header (optional)</label><input class="fi" id="webhook-auth" placeholder="Bearer token or API key"></div>
            <div style="font-size:.7rem;color:var(--muted);line-height:1.7;">
              POSTs JSON: <code style="background:var(--p2);padding:1px 5px;border-radius:3px;">{to_email, to_name, subject, message, from_name, timestamp}</code><br>
              ‚ú¶ Works with Zapier, Make.com, n8n, or any custom REST endpoint<br>
              ‚ú¶ Unlimited sends ‚Äî limited only by your webhook provider
            </div>
          </div>

          <div class="fg"><label>From Name (all providers)</label><input class="fi" id="ejs-from-name" placeholder="MERIDIAN Team Planner"></div>
          <div class="btn-row" style="margin-top:8px;">
            <button class="btn btn-primary btn-sm" onclick="saveEmailConfig()">Save Email Config</button>
            <button class="btn btn-secondary btn-sm" onclick="testEmail()">Send Test Email</button>
          </div>
        </div>

        <!-- Auto Status Updates -->
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Automated Status Updates</div>
          <div class="form-row c2">
            <div class="fg"><label>Weekly Digest Day</label><select class="fsel" id="digest-day"><option value="1">Monday</option><option value="5" selected>Friday</option><option value="0">Sunday</option></select></div>
            <div class="fg"><label>Digest Time</label><input class="fi" type="time" id="digest-time" value="09:00"></div>
          </div>
          <div class="fg"><label>Send digest to</label><select class="fsel" id="digest-to"><option value="all">All team members</option><option value="admin">Admin only</option></select></div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
            <input type="checkbox" id="auto-overdue" style="accent-color:var(--green);width:16px;height:16px;">
            <label for="auto-overdue" style="font-size:.78rem;cursor:pointer;">Send overdue alerts when a deadline passes</label>
          </div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
            <input type="checkbox" id="auto-status-change" style="accent-color:var(--green);width:16px;height:16px;" checked>
            <label for="auto-status-change" style="font-size:.78rem;cursor:pointer;">Notify assigners when task status changes</label>
          </div>
          <button class="btn btn-primary btn-sm" onclick="saveAutoConfig()">Save Automation Settings</button>
        </div>
      </div>


      <!-- ‚îÄ‚îÄ TEAM BOARD ‚îÄ‚îÄ -->
      <div class="page" id="page-team-board">
        <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;flex-wrap:wrap;">
          <div>
            <div class="page-title">Team</div>
            <div class="page-heading" id="team-board-heading">Board</div>
          </div>
          <div class="btn-row" style="margin-left:auto;flex-wrap:wrap;">
            <select class="fsel" style="max-width:160px;" id="tb-filter-status" onchange="renderTeamBoard()"><option value="">All Statuses</option></select>
            <select class="fsel" style="max-width:140px;" id="tb-filter-member" onchange="renderTeamBoard()"><option value="">All Members</option></select>
            <button class="btn btn-primary btn-sm" onclick="openAssignToTeam()">+ Assign Task</button>
            <button class="btn btn-secondary btn-sm" onclick="aiAnalyseTeam()">‚ú¶ AI Analyse</button>
          </div>
        </div>
        <div class="tab-bar" style="max-width:520px;margin-bottom:16px;">
          <button class="tab-btn active" onclick="tbView('kanban',this)">Kanban</button>
          <button class="tab-btn" onclick="tbView('table',this)">Table</button>
          <button class="tab-btn" onclick="tbView('gantt',this)">Gantt</button>
          <button class="tab-btn" onclick="tbView('dashboard',this)">Dashboard</button>
        </div>
        <div id="tb-kanban" class="tab-panel active"></div>
        <div id="tb-table" class="tab-panel"></div>
        <div id="tb-gantt" class="tab-panel"></div>
        <div id="tb-dashboard" class="tab-panel"></div>
      </div>

      <!-- ‚îÄ‚îÄ TEAM MANAGER (admin) ‚îÄ‚îÄ -->
      <div class="page" id="page-team-manager">
        <div class="page-title">Admin</div>
        <div class="page-heading">Team Manager</div>
        <div class="btn-row" style="margin-bottom:16px;">
          <button class="btn btn-primary" onclick="openTeamModal()">+ Create Team</button>
        </div>
        <div id="teams-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;"></div>
      </div>

    </div><!-- /main -->
  </div><!-- /shell -->
</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TASK MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="task-modal" onclick="closeIf(event,'task-modal')">
  <div class="modal modal-lg">
    <div class="modal-title" id="task-modal-title">Add Task</div>
    <div class="modal-sub">Fills into your timeline and day plan automatically</div>
    <div class="fg"><label>Task Name *</label><input class="fi" id="tm-name" placeholder="What needs doing?"></div>
    <div class="form-row c2">
      <div class="fg"><label>Date</label><input class="fi" type="date" id="tm-date"></div>
      <div class="fg"><label>Floating Task?</label><select class="fsel" id="tm-float"><option value="no">No ‚Äî date locked</option><option value="yes">Yes ‚Äî flexible date</option></select></div>
    </div>

    <!-- TIME SECTION -->
    <div style="background:var(--p2);border:1px solid var(--ruled);border-radius:6px;padding:14px;margin-bottom:13px;">
      <div style="font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">‚è± Time & Schedule</div>
      <div class="form-row c3">
        <div class="fg"><label>Start Time (optional)</label><input class="fi" type="time" id="tm-start-time" oninput="calcEndTime()"></div>
        <div class="fg"><label>End Time</label><input class="fi" type="time" id="tm-end-time" oninput="calcDuration()"></div>
        <div class="fg"><label>Duration (minutes) *</label><input class="fi" type="number" id="tm-duration" value="30" min="5" step="5" oninput="calcEndTime()"></div>
      </div>
      <div class="form-row c2">
        <div class="fg"><label>Day Zone</label><select class="fsel" id="tm-zone"><option value="">No zone ‚Äî unscheduled</option></select></div>
        <div class="fg"><label>Time Estimate (rough)</label><select class="fsel" id="tm-estimate">
          <option value="">Use duration above</option>
          <option value="15">Quick ‚Äî 15 min</option>
          <option value="30">Short ‚Äî 30 min</option>
          <option value="60">1 hour</option>
          <option value="90">1.5 hours</option>
          <option value="120">2 hours</option>
          <option value="180">Half day ‚Äî 3 hours</option>
          <option value="360">Full day ‚Äî 6 hours</option>
        </select></div>
      </div>
      <div id="time-preview" style="font-size:.72rem;color:var(--muted);font-family:'Syne',sans-serif;font-weight:600;"></div>
    </div>

    <!-- RECURRENCE SECTION -->
    <div style="background:var(--p2);border:1px solid var(--ruled);border-radius:6px;padding:14px;margin-bottom:13px;">
      <div style="font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">‚Üª Recurrence</div>
      <div class="form-row c3">
        <div class="fg"><label>Repeat</label><select class="fsel" id="tm-recur" onchange="toggleRecurOpts()">
          <option value="none">Does not repeat</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="biweekly">Every 2 weeks</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select></div>
        <div class="fg" id="recur-end-wrap" style="display:none;"><label>End Date</label><input class="fi" type="date" id="tm-recur-end"></div>
        <div class="fg" id="recur-day-wrap" style="display:none;"><label>Day of Week</label><select class="fsel" id="tm-recur-day">
          <option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option>
          <option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
        </select></div>
      </div>
      <div id="recur-preview" style="font-size:.72rem;color:var(--teal);font-family:'Syne',sans-serif;font-weight:600;display:none;"></div>
    </div>

    <div class="form-row c3">
      <div class="fg"><label>Urgency</label><select class="fsel" id="tm-urgency"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select></div>
      <div class="fg"><label>Importance</label><select class="fsel" id="tm-importance"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select></div>
      <div class="fg"><label>Category</label><select class="fsel" id="tm-category"></select></div>
    </div>
    <div class="form-row c2">
      <div class="fg"><label>Deadline</label><input class="fi" type="date" id="tm-due"></div>
      <div class="fg"><label>Status</label><select class="fsel" id="tm-status"></select></div>
    </div>
    <div class="fg"><label>Notes</label><textarea class="fta" id="tm-notes" placeholder="Context, steps, links..." style="min-height:60px;"></textarea></div>
    <div class="form-row c2">
      <div class="fg"><label>Link / URL</label><input class="fi" id="tm-link" placeholder="https://..."></div>
      <div class="fg"><label>File Attachment (‚â§500KB)</label><input class="fi" type="file" id="tm-file" style="padding:6px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('task-modal')">Cancel</button>
      <button class="btn btn-primary" id="task-modal-submit" onclick="submitPersonalTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MEETING MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="meet-modal" onclick="closeIf(event,'meet-modal')">
  <div class="modal modal-sm">
    <button class="modal-x" onclick="closeModal('meet-modal')">√ó</button>
    <div class="modal-title">Add Meeting</div>
    <div class="modal-sub">Date & time locked</div>
    <div class="fg"><label>Title *</label><input class="fi" id="mm-title" placeholder="Meeting title..."></div>
    <div class="form-row c2">
      <div class="fg"><label>Date *</label><input class="fi" type="date" id="mm-date"></div>
      <div class="fg"><label>Type</label><select class="fsel" id="mm-type"></select></div>
    </div>
    <div class="form-row c2">
      <div class="fg"><label>Start</label><input class="fi" type="time" id="mm-start" value="09:00"></div>
      <div class="fg"><label>End</label><input class="fi" type="time" id="mm-end" value="10:00"></div>
    </div>
    <div class="fg"><label>Location / Link</label><input class="fi" id="mm-location" placeholder="Room or video URL..."></div>
    <div class="fg"><label>Attendees</label><input class="fi" id="mm-attendees" placeholder="Names or emails..."></div>
    <div class="fg"><label>Agenda</label><textarea class="fta" id="mm-agenda"></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('meet-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitMeeting()">Add Meeting</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USER MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="user-modal" onclick="closeIf(event,'user-modal')">
  <div class="modal modal-sm">
    <div class="modal-title" id="user-modal-title">Add User</div>
    <div class="fg"><label>Full Name *</label><input class="fi" id="um-name" placeholder="John Smith"></div>
    <div class="fg"><label>Username *</label><input class="fi" id="um-username" placeholder="johnsmith"></div>
    <div class="fg"><label>Email *</label><input class="fi" id="um-email" placeholder="john@company.com"></div>
    <div class="form-row c2">
      <div class="fg"><label>Role</label><select class="fsel" id="um-role"><option value="member">Member</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
      <div class="fg"><label>Color</label><input type="color" id="um-color" value="#2a6e48" style="width:100%;height:38px;border:1.5px solid var(--ruled);border-radius:4px;cursor:pointer;"></div>
    </div>
    <div class="fg"><label>Password *</label><input class="fi" type="password" id="um-password" placeholder="Minimum 6 characters"></div>
    <div class="fg"><label>Confirm Password *</label><input class="fi" type="password" id="um-confirm" placeholder="Repeat password"></div>
    <div id="um-err" style="color:var(--red);font-size:.72rem;display:none;font-family:'Syne',sans-serif;font-weight:600;"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('user-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitUser()">Save User</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TASK DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="task-detail-modal" onclick="closeIf(event,'task-detail-modal')">
  <div class="modal">
    <div class="modal-title" id="tdm-title">Task Detail</div>
    <div id="tdm-body"></div>
    <div class="modal-footer" id="tdm-footer"></div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ZONE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="zone-modal" onclick="closeIf(event,'zone-modal')">
  <div class="modal modal-sm">
    <div class="modal-title" id="zone-modal-title">Add Day Zone</div>
    <div class="modal-sub">Define a block of time in your day</div>
    <div class="fg"><label>Zone Name *</label><input class="fi" id="zm-name" placeholder="e.g. Deep Work, Admin, Personal..."></div>
    <div class="form-row c2">
      <div class="fg"><label>Start Time *</label><input class="fi" type="time" id="zm-start" value="09:00"></div>
      <div class="fg"><label>End Time *</label><input class="fi" type="time" id="zm-end" value="12:00"></div>
    </div>
    <div class="fg"><label>Colour</label><input type="color" id="zm-color" value="#1e4f82" style="width:100%;height:38px;border:1.5px solid var(--ruled);border-radius:4px;cursor:pointer;"></div>
    <div class="fg"><label>Description (optional)</label><input class="fi" id="zm-desc" placeholder="What kind of work goes here?"></div>
    <div id="zm-err" style="color:var(--red);font-size:.72rem;display:none;"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('zone-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitZone()">Save Zone</button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI CHAT PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="ai-panel" id="ai-panel">
  <div class="ai-panel-hdr">
    <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1e4f82,#5e1e82);display:flex;align-items:center;justify-content:center;font-size:.9rem;">‚ú¶</div>
    <div style="flex:1;">
      <div class="ai-panel-title">MERIDIAN AI</div>
      <div class="ai-panel-sub" id="ai-model-label">Powered by Gemini</div>
    </div>
    <button class="ai-panel-close" onclick="toggleAI()">√ó</button>
  </div>
  <div class="ai-suggestion-strip" id="ai-suggestions">
    <span class="ai-suggestion" onclick="askAI('Summarise my tasks today')">Today's summary</span>
    <span class="ai-suggestion" onclick="askAI('What tasks are at risk of going overdue?')">Risk check</span>
    <span class="ai-suggestion" onclick="askAI('Who has the most workload on my team?')">Workload</span>
    <span class="ai-suggestion" onclick="askAI('Write a weekly status email for my team')">Status email</span>
  </div>
  <div class="ai-messages" id="ai-messages">
    <div class="ai-msg ai">Hi! I can see your tasks, team, and schedule. Ask me anything ‚Äî or describe a task naturally and I'll parse it for you.<br><br>Try: <em>"Call client Friday 3pm 1 hour"</em></div>
  </div>
  <div class="ai-input-row">
    <textarea class="ai-input" id="ai-input" placeholder="Ask anything or describe a task..." rows="1" onkeydown="aiKeyDown(event)"></textarea>
    <button class="ai-send" id="ai-send-btn" onclick="sendAIMessage()">Send</button>
  </div>
</div>
<button class="ai-chat-fab" id="ai-fab" onclick="toggleAI()">
  <span>‚ú¶</span><span>AI Assistant</span>
</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI TASK PARSE CONFIRM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="ai-parse-modal" onclick="closeIf(event,'ai-parse-modal')">
  <div class="modal modal-sm">
    <div class="modal-title">AI Parsed Task</div>
    <div class="modal-sub">Review and confirm before adding</div>
    <div class="ai-parse-preview" id="ai-parse-preview"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('ai-parse-modal')">Cancel</button>
      <button class="btn btn-secondary" onclick="editParsedTask()">Edit First</button>
      <button class="btn btn-primary" onclick="confirmParsedTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEAM MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="team-modal" onclick="closeIf(event,'team-modal')">
  <div class="modal">
    <div class="modal-title" id="team-modal-title">Create Team</div>
    <div class="fg"><label>Team Name *</label><input class="fi" id="team-name" placeholder="e.g. Engineering, Marketing, Design..."></div>
    <div class="form-row c2">
      <div class="fg"><label>Team Lead / Manager *</label><select class="fsel" id="team-lead"></select></div>
      <div class="fg"><label>Colour</label><input type="color" id="team-color" value="#1e4f82" style="width:100%;height:38px;border:1.5px solid var(--ruled);border-radius:4px;cursor:pointer;"></div>
    </div>
    <div class="fg"><label>Description</label><input class="fi" id="team-desc" placeholder="What does this team do?"></div>
    <div class="fg"><label>Members (select multiple)</label>
      <div id="team-members-select" style="background:var(--p2);border:1.5px solid var(--ruled);border-radius:4px;padding:8px;max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:5px;"></div>
    </div>
    <!-- Team-specific categories override -->
    <details style="margin-top:12px;">
      <summary style="font-family:'Syne',sans-serif;font-size:.62rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);cursor:pointer;padding:8px 0;">Advanced: Custom Workflows</summary>
      <div style="margin-top:10px;">
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:8px;line-height:1.5;">Override status workflow and default category for this team. Leave blank to use global settings.</div>
        <div class="fg"><label>Default Category for New Tasks</label>
          <select class="fsel" id="team-default-cat"></select>
        </div>
        <div class="fg"><label>Team Status Workflow (comma-separated status IDs)</label>
          <input class="fi" id="team-workflow" placeholder="todo,inprogress,review,done (leave blank for global)">
        </div>
        <div class="fg"><label>Team Sprint / Period Label</label>
          <input class="fi" id="team-sprint" placeholder="e.g. Sprint 12, Q1 2026">
        </div>
      </div>
    </details>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('team-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitTeam()">Save Team</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRYPTO UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function hashPassword(pw) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function verifyPassword(pw, hash) {
  return (await hashPassword(pw)) === hash;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORE_KEY = 'meridian3_data';
const SESSION_KEY = 'meridian3_session';
const SESSION_TIMEOUT = 8 * 60 * 60 * 1000; // 8 hours

let DB = loadDB();
let SESSION = null;
let currentPage = 'my-day';
let calDate = new Date(); calDate.setHours(0,0,0,0);
let calView = 'month';
let editingUserId = null;

function loadDB() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e){}
  return createEmptyDB();
}

function createEmptyDB() {
  return {
    users: [],
    tasks: [],
    meetings: [],
    inbox: [],
    emailLog: [],
    scheduledEmails: [],
    config: {
      storageMode: 'local',
      gdriveApiKey: '', gdriveClientId: '', gdriveFolderId: '',
      serverUrl: '', serverToken: '', serverInterval: 30,
      ejsServiceId: '', ejsTemplateId: '', ejsPublicKey: '', ejsFromName: 'MERIDIAN',
      digestDay: 5, digestTime: '09:00', digestTo: 'all',
      autoOverdue: false, autoStatusChange: true
    },
    categories: {
      statuses: [
        {id:'todo',name:'Todo',color:'#8c7f6e'},
        {id:'inprogress',name:'In Progress',color:'#1e4f82'},
        {id:'review',name:'Review',color:'#b87820'},
        {id:'stuck',name:'Stuck',color:'#b83232'},
        {id:'done',name:'Done',color:'#2a6e48'},
        {id:'cancelled',name:'Cancelled',color:'#cfc8b8'}
      ],
      taskCategories: [
        {id:'deep',name:'Deep Work',color:'#1e4f82'},
        {id:'comms',name:'Email & Comms',color:'#5e1e82'},
        {id:'admin',name:'Admin',color:'#2a6e48'},
        {id:'creative',name:'Creative',color:'#b87820'},
        {id:'meetings',name:'Meetings',color:'#1a6e6e'},
        {id:'personal',name:'Personal',color:'#8c7f6e'}
      ],
      meetingTypes: [
        {id:'internal',name:'Internal'},
        {id:'client',name:'Client'},
        {id:'1on1',name:'1-on-1'},
        {id:'team',name:'Team'},
        {id:'external',name:'External'}
      ],
      priorities: [
        {id:'high',name:'High',color:'#b83232'},
        {id:'medium',name:'Medium',color:'#b87820'},
        {id:'low',name:'Low',color:'#2a6e48'}
      ]
    },
    permissions: {}, // {userId: {canSee: [userId, ...]}}
    nextId: 1
  };
}

function saveDB() {
  localStorage.setItem(STORE_KEY, JSON.stringify(DB));
  syncToBackend();
}

function genId() { return DB.nextId++; }
function getDayStr(d) { return new Date(d).toISOString().split('T')[0]; }
function today() { return getDayStr(new Date()); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkFirstRun() {
  if (DB.users.length === 0) {
    document.getElementById('first-run-note').style.display = 'block';
    document.getElementById('login-btn').textContent = 'Create Admin Account';
  }
}

async function doLogin() {
  const username = document.getElementById('login-user').value.trim();
  const password = document.getElementById('login-pass').value;
  const err = document.getElementById('login-err');
  err.classList.remove('vis');

  if (!username || !password) { err.textContent='Please enter username and password.'; err.classList.add('vis'); return; }

  // First run ‚Äî create admin
  if (DB.users.length === 0) {
    if (password.length < 6) { err.textContent='Password must be at least 6 characters.'; err.classList.add('vis'); return; }
    const hash = await hashPassword(password);
    const admin = { id: genId(), username, name: username, email: '', role: 'admin', color: '#b83232', passwordHash: hash, active: true, createdAt: Date.now(), lastActive: Date.now() };
    DB.users.push(admin);
    DB.permissions[admin.id] = { canSee: [] };
    saveDB();
    startSession(admin);
    return;
  }

  const user = DB.users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.active !== false);
  if (!user) { err.textContent='User not found or inactive.'; err.classList.add('vis'); return; }

  const ok = await verifyPassword(password, user.passwordHash);
  if (!ok) { err.textContent='Invalid password.'; err.classList.add('vis'); return; }

  user.lastActive = Date.now();
  saveDB();
  startSession(user);
}

function startSession(user) {
  SESSION = { userId: user.id, username: user.username, role: user.role, startedAt: Date.now() };
  sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION));
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('vis');
  initApp();
}

function checkSession() {
  const raw = sessionStorage.getItem(SESSION_KEY);
  if (!raw) return false;
  try {
    const s = JSON.parse(raw);
    if (Date.now() - s.startedAt > SESSION_TIMEOUT) { sessionStorage.removeItem(SESSION_KEY); return false; }
    SESSION = s;
    // Refresh activity
    SESSION.startedAt = Date.now();
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION));
    return true;
  } catch(e) { return false; }
}

function doLogout() {
  sessionStorage.removeItem(SESSION_KEY);
  SESSION = null;
  document.getElementById('app').classList.remove('vis');
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  checkFirstRun();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
  ensureDBShape(); // Fix any missing DB fields before rendering
  const user = currentUser();
  if (!user) { doLogout(); return; }

  // Sidebar user info
  document.getElementById('sb-username').textContent = user.name || user.username;
  document.getElementById('sb-role').textContent = user.role.toUpperCase();
  document.getElementById('sb-avatar').textContent = (user.name||user.username).charAt(0).toUpperCase();
  document.getElementById('sb-avatar').style.background = user.color || '#b83232';

  // Show admin/manager nav
  const isAdmin = user.role === 'admin';
  const isMgr = user.role === 'manager' || isAdmin;
  ['nav-team-section','nav-team-view','nav-assign-task','nav-email-center'].forEach(id=>document.getElementById(id).style.display=isMgr?'':'none');
  ['nav-admin-section','nav-user-manager','nav-cat-manager','nav-integrations'].forEach(id=>document.getElementById(id).style.display=isAdmin?'':'none');

  // Storage mode indicator
  updateStorageModeUI();
  // Populate selects
  populateAllSelects();
  // Load config into UI
  loadConfigUI();
  // Render
  navTo('my-day');
  // Check inbox
  checkInboxBadge();
  // Check notifications
  checkInAppNotifications();
  // Schedule auto-sync
  setInterval(syncNow, 30000);
  // Check scheduled emails
  setInterval(checkScheduledEmails, 60000);
  // Build teams sidebar
  buildTeamsSidebarNav();
  // Refresh AI suggestion chips
  refreshAISuggestions();
  // Check for tasks about to go overdue and log them
  checkOverdueLearning();
  // Show team manager nav for admin/manager
  const tmEl = document.getElementById('nav-team-manager');
  if (tmEl) tmEl.style.display = isMgr ? '' : 'none';
  // AI label
  const aiLabel = document.getElementById('ai-model-label');
  if (aiLabel && DB.config.aiProvider) {
    aiLabel.textContent = 'Powered by ' + ({gemini:'Gemini',groq:'Groq',openrouter:'OpenRouter',huggingface:'HuggingFace'}[DB.config.aiProvider]||'AI');
  }
}

function currentUser() {
  if (!SESSION) return null;
  return DB.users.find(u => u.id === SESSION.userId);
}

function canSeeUser(targetId) {
  const u = currentUser();
  if (!u) return false;
  if (u.role === 'admin') return true;
  if (u.id === targetId) return true;
  const perms = DB.permissions[u.id];
  if (!perms) return false;
  return perms.canSee && perms.canSee.includes(targetId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navTo(page) {
  currentPage = page;
  document.querySelectorAll('.sb-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  const navEl = document.getElementById('nav-' + page);
  if (navEl) navEl.classList.add('active');
  const pageEl = document.getElementById('page-' + page);
  if (pageEl) pageEl.classList.add('active');
  renderPage(page);
}

function renderPage(page) {
  if (page === 'my-day') renderMyDay();
  else if (page === 'inbox') renderInbox();
  else if (page === 'my-tasks') renderMyTasks();
  else if (page === 'calendar') renderCalendar();
  else if (page === 'day-planner') renderDayPlanner();
  else if (page === 'team-view') renderTeamView();
  else if (page === 'user-manager') renderUserManager();
  else if (page === 'cat-manager') renderCatManager();
  else if (page === 'integrations') loadConfigUI();
  else if (page === 'email-center') renderEmailCenter();
  else if (page === 'assign-task') populateAssignForm();
  else if (page === 'team-board') renderTeamBoard();
  else if (page === 'team-manager') renderTeamManager();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MY DAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTasksForDay(uid, dateStr) {
  // Get direct tasks + recurring tasks that fall on this date
  const direct = DB.tasks.filter(t => t.ownerId === uid && !t.deletedAt && (t.date === dateStr || t.float === 'yes') && (!t.recur || t.recur === 'none'));
  const recurring = getRecurringTasksForDate(uid, dateStr);
  return [...direct, ...recurring];
}

function getRecurringTasksForDate(uid, dateStr) {
  const result = [];
  const targetDate = new Date(dateStr + 'T00:00:00');
  const recurTasks = DB.tasks.filter(t => t.ownerId === uid && !t.deletedAt && t.recur && t.recur !== 'none');
  recurTasks.forEach(t => {
    const startDate = new Date((t.date || t.createdAt.toString().substring(0,10)) + 'T00:00:00');
    const endDate = t.recurEnd ? new Date(t.recurEnd + 'T00:00:00') : null;
    if (targetDate < startDate) return;
    if (endDate && targetDate > endDate) return;
    if (getDayStr(targetDate) === getDayStr(startDate)) return; // already shown as direct
    let matches = false;
    if (t.recur === 'daily') matches = true;
    else if (t.recur === 'weekly') matches = targetDate.getDay() === startDate.getDay();
    else if (t.recur === 'biweekly') {
      const diff = Math.round((targetDate - startDate) / 86400000);
      matches = diff % 14 === 0;
    }
    else if (t.recur === 'monthly') matches = targetDate.getDate() === startDate.getDate();
    else if (t.recur === 'yearly') matches = targetDate.getDate() === startDate.getDate() && targetDate.getMonth() === startDate.getMonth();
    if (matches) {
      // Create virtual copy
      result.push({...t, id: t.id + '_r_' + dateStr, _recurParentId: t.id, _isVirtual: true, date: dateStr});
    }
  });
  return result;
}

function renderMyDay() {
  const u = currentUser();
  const todayStr = today();
  document.getElementById('my-day-heading').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  const myTasks = getTasksForDay(u.id, todayStr);
  const myMeets = DB.meetings.filter(m => m.ownerId === u.id && m.date === todayStr);

  // Stats
  const stats = document.getElementById('my-day-stats');
  const done = myTasks.filter(t => t.status === 'done').length;
  const stuck = myTasks.filter(t => t.status === 'stuck').length;
  const inprog = myTasks.filter(t => t.status === 'inprogress').length;
  const totalMins = myTasks.reduce((s,t)=>s+(parseInt(t.duration)||30),0) + myMeets.reduce((s,m)=>{const[sh,sm]=m.start.split(':').map(Number);const[eh,em]=m.end.split(':').map(Number);return s+(eh*60+em)-(sh*60+sm);},0);
  stats.innerHTML = [
    {val: myTasks.length, lbl: 'Total Tasks', color: 'var(--blue)'},
    {val: done, lbl: 'Done', color: 'var(--green)'},
    {val: stuck, lbl: 'Stuck', color: 'var(--red)'},
    {val: totalMins>=60?Math.round(totalMins/60*10)/10+'h':totalMins+'m', lbl: 'Scheduled', color: 'var(--amber)'}
  ].map(s=>`<div class="card stat-card"><div class="stat-val" style="color:${s.color}">${s.val}</div><div class="stat-lbl">${s.lbl}</div></div>`).join('');

  // Task list
  const list = document.getElementById('my-day-list');
  if (myTasks.length === 0 && myMeets.length === 0) {
    list.innerHTML = `<div style="text-align:center;padding:40px;color:var(--muted);"><div style="font-size:2rem;margin-bottom:8px;">üìã</div><div style="font-family:'Syne',sans-serif;font-weight:700;">No tasks today</div><div style="font-size:.76rem;margin-top:4px;">Press the + Task button to begin</div></div>`;
  } else {
    list.innerHTML = myMeets.map(m => buildMeetCard(m)).join('') + myTasks.map(t => buildMyTaskCard(t)).join('');
  }

  // Visual Timeline
  renderVisualTimeline(myTasks, myMeets, 'my-day-timeline', u.id);
}

function buildMyTaskCard(t) {
  const cat = DB.categories.taskCategories.find(c=>c.id===t.category);
  const status = DB.categories.statuses.find(s=>s.id===t.status) || {name:'Todo',color:'#8c7f6e'};
  const due = t.due ? `<span style="color:${isOverdue(t.due)?'var(--red)':'var(--muted)'}">üìÖ ${fmtDate(t.due)}</span>` : '';
  const link = t.link ? `<a href="${esc(t.link)}" target="_blank" style="color:var(--blue);font-size:.68rem;">üîó Link</a>` : '';
  const file = t.fileData ? `<span style="font-size:.68rem;color:var(--blue);cursor:pointer;" onclick="downloadFile(${t.id})">üìé File</span>` : '';
  const assigner = t.assignedBy ? DB.users.find(u=>u.id===t.assignedBy) : null;
  const dur = parseInt(t.duration)||30;
  const durStr = dur>=60 ? (dur%60===0?`${dur/60}h`:`${Math.floor(dur/60)}h ${dur%60}m`) : `${dur}m`;
  const timeStr = t.startTime ? `${t.startTime}${t.endTime?'‚Äì'+t.endTime:''}` : '';
  const recurBadge = t.recur && t.recur!=='none' ? `<span class="recur-badge">‚Üª ${{'daily':'Daily','weekly':'Weekly','biweekly':'2-weekly','monthly':'Monthly','yearly':'Yearly'}[t.recur]||t.recur}</span>` : '';
  const virtualBadge = t._isVirtual ? `<span class="recur-badge" style="background:rgba(30,79,130,.1);color:var(--blue);">‚Üª recurring</span>` : '';
  const realId = t._recurParentId || t.id;
  return `<div class="team-task">
    <div class="tt-header">
      <div style="width:4px;background:${cat?cat.color:'var(--muted)'};border-radius:2px;align-self:stretch;flex-shrink:0;min-height:32px;"></div>
      <div style="flex:1;margin-left:10px;">
        <div class="tt-title">${esc(t.name)}</div>
        ${assigner?`<div style="font-size:.65rem;color:var(--muted);margin-top:1px;">Assigned by ${esc(assigner.name||assigner.username)}</div>`:''}
      </div>
      ${recurBadge}${virtualBadge}
      <span class="status-badge" style="background:${status.color}22;color:${status.color}">${status.name}</span>
      <div class="tt-actions">
        <button class="btn btn-xs btn-secondary" onclick="openTaskDetail(${realId})">Detail</button>
        <button class="btn btn-xs btn-green" onclick="changeStatus(${realId},'done')" ${t.status==='done'?'disabled':''}>‚úì</button>
      </div>
    </div>
    <div class="tt-meta">
      ${cat?`<span style="color:${cat.color}">‚óè ${cat.name}</span>`:''}
      <span style="font-family:'Syne',sans-serif;font-weight:700;">‚è± ${durStr}</span>
      ${timeStr?`<span style="color:var(--muted);">üïê ${timeStr}</span>`:''}
      ${due}${link}${file}
      <select onchange="changeStatus(${realId},this.value)" style="border:1px solid var(--ruled);border-radius:3px;font-size:.62rem;padding:2px 6px;background:var(--p2);font-family:'Syne',sans-serif;font-weight:700;cursor:pointer;">
        ${DB.categories.statuses.map(s=>`<option value="${s.id}" ${s.id===t.status?'selected':''}>${s.name}</option>`).join('')}
      </select>
    </div>
  </div>`;
}

function buildMeetCard(m) {
  return `<div class="team-task" style="border-left:3px solid var(--purple);">
    <div class="tt-header">
      <div style="flex:1"><span style="font-family:'Syne',sans-serif;font-size:.6rem;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.1em;">üìÖ Meeting</span>
      <div class="tt-title">${esc(m.title)}</div></div>
      <button class="btn btn-xs btn-danger" onclick="deleteMeeting('${m.id}')">√ó</button>
    </div>
    <div class="tt-meta"><span>üïê ${m.start}‚Äì${m.end}</span>${m.location?`<span>üìç ${esc(m.location)}</span>`:''}</div>
  </div>`;
}

function renderVisualTimeline(tasks, meets, containerId, userId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  // Build time blocks from tasks and meetings
  const blocks = [];

  // Meetings ‚Äî fixed time
  meets.forEach(m => {
    const [sh,sm] = m.start.split(':').map(Number);
    const [eh,em] = m.end.split(':').map(Number);
    blocks.push({ type:'meet', name:m.title, startMins:sh*60+sm, endMins:eh*60+em, color:'#5e1e82', meta:m.location||m.type||'meeting', id:m.id });
  });

  // Tasks with explicit start time
  tasks.forEach(t => {
    if (t.startTime) {
      const [sh,sm] = t.startTime.split(':').map(Number);
      const dur = parseInt(t.duration)||30;
      const endMins = sh*60+sm+dur;
      const cat = DB.categories.taskCategories.find(c=>c.id===t.category);
      blocks.push({ type:'task', name:t.name, startMins:sh*60+sm, endMins, color:cat?cat.color:'#1e4f82', meta:`${dur}m ¬∑ ${cat?cat.name:''}`, taskRef:t });
    }
  });

  // Tasks in zones (no explicit time but has zone)
  if (userId) {
    const u = DB.users.find(u=>u.id===userId);
    const zones = (u && u.dayZones) || [];
    zones.forEach(z => {
      const [zsh,zsm] = z.start.split(':').map(Number);
      let cursor = zsh*60+zsm;
      const zoneEndMins = z.end ? (() => { const [eh,em]=z.end.split(':').map(Number); return eh*60+em; })() : cursor+120;
      // Add zone background block
      blocks.push({ type:'zone', name:z.name, startMins:zsh*60+zsm, endMins:zoneEndMins, color:z.color, meta:z.desc||'', isZone:true });
      // Place unscheduled tasks assigned to this zone
      tasks.filter(t=>!t.startTime && t.zone===z.id && t.status!=='done').forEach(t=>{
        const dur = parseInt(t.duration)||30;
        const cat = DB.categories.taskCategories.find(c=>c.id===t.category);
        blocks.push({ type:'task', name:t.name, startMins:cursor, endMins:cursor+dur, color:cat?cat.color:z.color, meta:`${dur}m`, taskRef:t });
        cursor += dur + 5;
      });
    });
  }

  // Auto-place tasks with no time and no zone
  const unplaced = tasks.filter(t => !t.startTime && (!t.zone || t.zone==='') && t.status!=='done');
  if (unplaced.length > 0) {
    let cursor = 9*60; // 9am default
    // Skip past meetings
    unplaced.forEach(t => {
      // Bump cursor past any meeting at this slot
      let bumped = true;
      while(bumped) {
        bumped = false;
        meets.forEach(m => {
          const [sh,sm]=m.start.split(':').map(Number); const [eh,em]=m.end.split(':').map(Number);
          const ms=sh*60+sm; const me=eh*60+em;
          if(cursor>=ms&&cursor<me){cursor=me+5;bumped=true;}
        });
      }
      const dur = parseInt(t.duration)||30;
      const cat = DB.categories.taskCategories.find(c=>c.id===t.category);
      blocks.push({ type:'task-auto', name:t.name, startMins:cursor, endMins:cursor+dur, color:cat?cat.color:'#1e4f82', meta:`${dur}m ¬∑ auto-placed`, taskRef:t });
      cursor += dur + 5;
    });
  }

  if (blocks.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:30px;color:var(--muted);font-size:.76rem;">No scheduled items yet.<br>Add start times to tasks to see them here.</div>`;
    document.getElementById('tl-total-time') && (document.getElementById('tl-total-time').textContent='');
    return;
  }

  // Always show full 24-hour day (scrollable)
  const minH = 0;
  const maxH = 24;

  // Calculate total scheduled task time
  const taskMins = blocks.filter(b=>b.type==='task'||b.type==='task-auto').reduce((s,b)=>s+(b.endMins-b.startMins),0);
  const tlTotal = document.getElementById('tl-total-time');
  if(tlTotal) tlTotal.textContent = taskMins>0 ? `${taskMins>=60?Math.round(taskMins/60*10)/10+'h':taskMins+'m'} of tasks` : '';

  // Pixel scale: 1 min = 1.6px ‚Üí each hour = 96px ‚Üí 24h = 2304px (scrollable)
  const PX = 1.6;
  const HOUR_H = 60 * PX;   // 96px per hour
  const HOUR_W = 46;
  const totalHeight = 24 * HOUR_H;

  // Scroll to current hour on render (center ~2 hours before now)
  const nowDate = new Date();
  const nowMins = nowDate.getHours()*60+nowDate.getMinutes();
  const nowTop = nowMins * PX;
  const scrollTarget = Math.max(0, nowTop - HOUR_H * 2);

  let html = `<div class="vtl-wrap" style="overflow:hidden;">`;
  html += `<div style="position:relative;height:${totalHeight}px;">`;

  // Hour rows ‚Äî draw all 24
  for(let h = 0; h < 24; h++) {
    const top = h * HOUR_H;
    const isNight = h < 6 || h >= 22;
    const isBiz   = h >= 9 && h < 18;
    const rowBg   = isNight ? 'rgba(0,0,0,.018)' : isBiz ? 'transparent' : 'transparent';
    html += `<div style="position:absolute;left:0;right:0;top:${top}px;height:${HOUR_H}px;background:${rowBg};border-top:1px solid rgba(207,200,184,${h===0?'0':'.45'});">
      <div style="position:absolute;left:0;width:${HOUR_W}px;top:0;bottom:0;background:var(--p2);display:flex;align-items:flex-start;justify-content:flex-end;padding:4px 6px 0 0;">
        <span style="font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;color:${isNight?'var(--muted)':'var(--muted)'};opacity:${isNight?.55:1};">${fmtHour(h)}</span>
      </div>
    </div>`;
    // Half-hour tick
    html += `<div style="position:absolute;left:${HOUR_W}px;right:0;top:${top + 30*PX}px;height:1px;background:rgba(207,200,184,.22);"></div>`;
    // Quarter ticks
    html += `<div style="position:absolute;left:${HOUR_W}px;width:12px;top:${top+15*PX}px;height:1px;background:rgba(207,200,184,.18);"></div>`;
    html += `<div style="position:absolute;left:${HOUR_W}px;width:12px;top:${top+45*PX}px;height:1px;background:rgba(207,200,184,.18);"></div>`;
  }

  // Business hours highlight (9‚Äì18)
  html += `<div style="position:absolute;left:${HOUR_W}px;right:0;top:${9*HOUR_H}px;height:${9*HOUR_H}px;background:rgba(94,30,130,.025);pointer-events:none;border-left:2px solid rgba(94,30,130,.06);"></div>`;

  // Now line
  if(nowMins >= 0 && nowMins <= 1440) {
    html += `<div class="vtl-now-line" style="top:${nowTop}px;">
      <span class="vtl-now-label" style="top:-8px;white-space:nowrap;">${fmtHour(nowDate.getHours())}:${String(nowDate.getMinutes()).padStart(2,'0')}</span>
    </div>`;
  }

  // Content area (inside the hour grid)
  html += `<div style="position:absolute;left:${HOUR_W}px;right:0;top:0;bottom:0;">`;

  // Zone backgrounds
  blocks.filter(b=>b.isZone).forEach(b=>{
    const top = b.startMins * PX;
    const height = (b.endMins - b.startMins) * PX;
    html += `<div style="position:absolute;left:0;right:0;top:${top}px;height:${height}px;background:${b.color}09;border-left:3px solid ${b.color}40;pointer-events:none;">
      <div style="padding:3px 8px;font-family:'Syne',sans-serif;font-size:.54rem;font-weight:700;color:${b.color};text-transform:uppercase;letter-spacing:.1em;opacity:.65;">${esc(b.name)}</div>
    </div>`;
  });

  // Task & meeting blocks
  blocks.filter(b=>!b.isZone).forEach(b=>{
    const top    = b.startMins * PX;
    const height = Math.max((b.endMins - b.startMins) * PX, 24);
    const isDone   = b.taskRef?.status === 'done';
    const isDashed = b.type === 'task-auto';
    const startLabel = `${String(Math.floor(b.startMins/60)).padStart(2,'0')}:${String(b.startMins%60).padStart(2,'0')}`;
    html += `<div class="vtl-block" onclick="${b.taskRef?`openTaskDetail(${b.taskRef._recurParentId||b.taskRef.id})`:''}"
      style="position:absolute;left:4px;right:4px;top:${top}px;height:${height}px;
             background:${b.color}18;border-left:3px solid ${b.color};
             border-top:1px solid ${b.color}44;border-bottom:1px solid ${b.color}22;
             ${isDone?'opacity:.38;':''}"
      title="${esc(b.name)} ${startLabel}">
      <div class="vtl-block-name" style="color:${b.color};${isDone?'text-decoration:line-through;':''}">${esc(b.name)}</div>
      <div class="vtl-block-meta" style="color:${b.color};">${startLabel} ¬∑ ${esc(b.meta)}${isDashed?' <em style="opacity:.55;font-style:italic;">auto</em>':''}</div>
    </div>`;
  });

  html += `</div>`; // content area
  html += `</div>`; // inner relative
  html += `</div>`; // vtl-wrap

  container.innerHTML = html;

  // Scroll to show current time (2 hours before now so it's centred)
  container.scrollTop = scrollTarget;
}

// Legacy alias
function renderDayTimeline(tasks, meets) { renderVisualTimeline(tasks, meets, 'my-day-timeline', currentUser()?.id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INBOX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInbox() {
  const u = currentUser();
  const items = DB.inbox.filter(i => i.toId === u.id && !i.dismissed);
  const list = document.getElementById('inbox-list');
  const empty = document.getElementById('inbox-empty');
  if (items.length === 0) { list.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  list.innerHTML = items.map(item => {
    const from = DB.users.find(u => u.id === item.fromId);
    const cat = DB.categories.taskCategories.find(c=>c.id===item.category);
    return `<div class="inbox-item">
      <div class="inbox-from">From: ${esc(from?from.name||from.username:'Unknown')} ¬∑ ${fmtDate(item.createdAt)}</div>
      <div class="inbox-title">${esc(item.name)}</div>
      <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">${item.description?esc(item.description.substring(0,120))+'‚Ä¶':''}</div>
      <div class="tt-meta">
        ${cat?`<span style="color:${cat.color}">‚óè ${cat.name}</span>`:''}
        ${item.deadline?`<span style="color:${isOverdue(item.deadline)?'var(--red)':'var(--muted)'}">üìÖ Due ${fmtDate(item.deadline)}</span>`:''}
        <span>‚è± ${item.duration||60}m</span>
        ${item.link?`<a href="${esc(item.link)}" target="_blank" style="color:var(--blue);font-size:.68rem;">üîó Link</a>`:''}
        ${item.fileData?`<span style="font-size:.68rem;color:var(--blue);cursor:pointer;" onclick="downloadInboxFile('${item.id}')">üìé File</span>`:''}
      </div>
      <div class="inbox-actions">
        <button class="btn btn-primary btn-sm" onclick="acceptInboxItem('${item.id}')">‚úì Accept & Add to Tasks</button>
        <button class="btn btn-secondary btn-sm" onclick="dismissInbox('${item.id}')">Dismiss</button>
      </div>
    </div>`;
  }).join('');
}

function checkInboxBadge() {
  const u = currentUser();
  if(!u) return;
  const count = DB.inbox.filter(i => i.toId === u.id && !i.dismissed).length;
  const badge = document.getElementById('inbox-badge');
  if(count > 0) { badge.style.display='flex'; badge.textContent=count; }
  else badge.style.display='none';
}

function acceptInboxItem(id) {
  const item = DB.inbox.find(i=>i.id===id);
  if(!item) return;
  const u = currentUser();
  const task = {
    id: genId(), name: item.name, type:'task',
    ownerId: u.id, assignedBy: item.fromId,
    category: item.category||'admin',
    urgency: item.priority==='high'?'high':'medium',
    importance: item.priority==='high'?'high':'medium',
    impact: item.priority||'medium',
    duration: item.duration||60, date: null,
    due: item.deadline||null, float: 'yes',
    notes: item.description||'', link: item.link||'',
    fileData: item.fileData||null, fileName: item.fileName||null,
    status: 'todo', createdAt: Date.now(), score:0
  };
  DB.tasks.push(task);
  item.dismissed=true; item.acceptedAt=Date.now();
  saveDB(); checkInboxBadge(); renderInbox();
  toast(`‚úì "${item.name}" added to your tasks`);
  // Notify assigner
  if(DB.config.autoStatusChange) notifyStatusChange(item.fromId, `${u.name||u.username} accepted "${item.name}"`);
}

function dismissInbox(id) {
  const item = DB.inbox.find(i=>i.id===id);
  if(item) { item.dismissed=true; saveDB(); checkInboxBadge(); renderInbox(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MY TASKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMyTasks() {
  const u = currentUser();
  const tasks = DB.tasks.filter(t => t.ownerId === u.id && !t.deletedAt).sort((a,b)=>b.id-a.id);
  const filters = document.getElementById('my-tasks-filters');
  filters.innerHTML = `
    <select class="fsel" style="max-width:140px" onchange="renderMyTasks()" id="myt-status"><option value="">All Statuses</option>${DB.categories.statuses.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
    <select class="fsel" style="max-width:140px" onchange="renderMyTasks()" id="myt-cat"><option value="">All Categories</option>${DB.categories.taskCategories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>`;

  const statusF = document.getElementById('myt-status')?.value||'';
  const catF = document.getElementById('myt-cat')?.value||'';
  const filtered = tasks.filter(t => (!statusF||t.status===statusF) && (!catF||t.category===catF));

  const list = document.getElementById('my-tasks-list');
  if(filtered.length===0){list.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted);font-family:'Syne',sans-serif;font-weight:700;">No tasks found</div>`;return;}
  list.innerHTML = filtered.map(t => {
    const card = buildMyTaskCard(t);
    return card;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚îÄ‚îÄ Entry point ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendar() {
  _calUpdateViewBtns();
  if      (calView === 'day')  _calRenderDay();
  else if (calView === 'week') _calRenderWeek();
  else                         _calRenderMonth();
}

function setCalView(v) { calView = v; renderCalendar(); }

function calNav(dir) {
  if      (calView === 'day')  calDate.setDate(calDate.getDate() + dir);
  else if (calView === 'week') calDate.setDate(calDate.getDate() + dir * 7);
  else                         calDate.setMonth(calDate.getMonth() + dir);
  renderCalendar();
}

function calToday() {
  calDate = new Date(); calDate.setHours(0,0,0,0);
  renderCalendar();
}

function calDayClick(ds) {
  calDate = new Date(ds + 'T00:00:00');
  setCalView('day');
}

function _calUpdateViewBtns() {
  ['day','week','month'].forEach(function(v) {
    const btn = document.getElementById('cal-view-' + v);
    if (!btn) return;
    btn.className = 'btn btn-xs ' + (calView === v ? 'btn-primary' : 'btn-secondary');
  });
}

// ‚îÄ‚îÄ Shared helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _calPill(name, color, extra) {
  return '<div style="background:' + color + '18;border-left:2px solid ' + color + ';'
    + 'border-radius:2px;padding:1px 5px;font-size:.58rem;font-family:\'Syne\',sans-serif;'
    + 'font-weight:700;color:' + color + ';margin-bottom:2px;overflow:hidden;'
    + 'white-space:nowrap;text-overflow:ellipsis;' + (extra||'') + '">'
    + esc(name) + '</div>';
}

function _calTaskColor(t) {
  const cat = DB.categories.taskCategories.find(function(c){ return c.id === t.category; });
  return cat ? cat.color : '#1e4f82';
}

// ‚îÄ‚îÄ MONTH VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _calRenderMonth() {
  const u  = currentUser();
  const y  = calDate.getFullYear();
  const mo = calDate.getMonth();
  const todayStr   = today();
  const daysInMonth = new Date(y, mo + 1, 0).getDate();
  const startDay   = new Date(y, mo, 1).getDay();

  document.getElementById('cal-label').textContent =
    calDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

  let html = '<div style="display:grid;grid-template-columns:repeat(7,1fr);">';

  // Day-name headers
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(function(d) {
    html += '<div style="background:var(--p2);padding:8px;text-align:center;'
          + 'border-bottom:1px solid var(--ruled);border-right:1px solid var(--ruled);'
          + 'font-family:\'Syne\',sans-serif;font-size:.58rem;font-weight:700;'
          + 'letter-spacing:.1em;text-transform:uppercase;color:var(--muted);">' + d + '</div>';
  });

  // Empty leading cells
  for (let i = 0; i < startDay; i++) {
    html += '<div style="background:var(--p2);min-height:88px;'
          + 'border-bottom:1px solid var(--ruled);border-right:1px solid var(--ruled);"></div>';
  }

  // Day cells
  for (let d = 1; d <= daysInMonth; d++) {
    const ds      = getDayStr(new Date(y, mo, d));
    const myT     = getTasksForDay(u.id, ds);
    const myM     = DB.meetings.filter(function(m){ return m.ownerId === u.id && m.date === ds; });
    const isToday = ds === todayStr;
    const isWkend = new Date(y, mo, d).getDay() === 0 || new Date(y, mo, d).getDay() === 6;
    const bg      = isToday ? 'rgba(184,50,50,.07)' : isWkend ? 'rgba(0,0,0,.014)' : 'var(--paper)';
    const bgHover = isToday ? 'rgba(184,50,50,.12)' : 'var(--p2)';

    html += '<div onclick="calDayClick(\'' + ds + '\')"'
          + ' onmouseover="this.style.background=\'' + bgHover + '\'"'
          + ' onmouseout="this.style.background=\'' + bg + '\'"'
          + ' style="background:' + bg + ';min-height:88px;'
          + 'border-bottom:1px solid var(--ruled);border-right:1px solid var(--ruled);'
          + 'padding:5px;cursor:pointer;transition:background .12s;">';

    // Date number
    if (isToday) {
      html += '<div style="display:inline-flex;align-items:center;justify-content:center;'
            + 'width:22px;height:22px;border-radius:50%;background:var(--red);'
            + 'color:#fff;font-family:\'Syne\',sans-serif;font-size:.68rem;font-weight:800;'
            + 'margin-bottom:3px;">' + d + '</div>';
    } else {
      html += '<div style="font-family:\'Syne\',sans-serif;font-size:.76rem;font-weight:800;'
            + 'margin-bottom:3px;' + (isWkend ? 'color:var(--muted);' : '') + '">' + d + '</div>';
    }

    // Meeting pills
    myM.slice(0,1).forEach(function(m) {
      html += _calPill(m.title, '#5e1e82');
    });

    // Task pills
    myT.slice(0, 2).forEach(function(t) {
      html += _calPill(t.name, _calTaskColor(t), t.status === 'done' ? 'opacity:.4;text-decoration:line-through;' : '');
    });

    // Overflow count
    const extra = myT.length + myM.length - 3;
    if (extra > 0) {
      html += '<div style="font-size:.54rem;color:var(--muted);'
            + 'font-family:\'Syne\',sans-serif;font-weight:700;">+' + extra + ' more</div>';
    }
    html += '</div>';
  }
  html += '</div>';

  document.getElementById('cal-grid').innerHTML = html;
}

// ‚îÄ‚îÄ WEEK VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _calRenderWeek() {
  const u = currentUser();
  // Monday-start week containing calDate
  const dow   = calDate.getDay(); // 0=Sun
  const startOfWeek = new Date(calDate);
  startOfWeek.setDate(calDate.getDate() - dow); // Sun
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);

  document.getElementById('cal-label').textContent =
    startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    + ' ‚Äì '
    + endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  const todayStr = today();
  const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const PX     = 1.4;   // px per minute
  const HOUR_H = 60 * PX;
  const HOUR_W = 48;

  // Build 7-day array
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startOfWeek);
    d.setDate(d.getDate() + i);
    days.push(d);
  }

  // ‚îÄ‚îÄ Column header row ‚îÄ‚îÄ
  let hdr = '<div style="display:grid;grid-template-columns:' + HOUR_W + 'px repeat(7,1fr);'
          + 'border-bottom:2px solid var(--ruled);position:sticky;top:0;z-index:10;background:var(--paper);">';
  hdr += '<div style="background:var(--p2);"></div>';
  days.forEach(function(d) {
    const ds      = getDayStr(d);
    const isToday = ds === todayStr;
    const isWkend = d.getDay() === 0 || d.getDay() === 6;
    hdr += '<div style="padding:7px 4px;text-align:center;'
         + 'border-left:1px solid var(--ruled);'
         + 'background:' + (isToday ? 'rgba(184,50,50,.07)' : 'var(--p2)') + ';">'
         + '<div style="font-family:\'Syne\',sans-serif;font-size:.55rem;font-weight:700;'
         + 'letter-spacing:.08em;text-transform:uppercase;'
         + 'color:' + (isWkend ? 'var(--muted)' : 'var(--ink)') + ';">' + DAY_NAMES[d.getDay()] + '</div>'
         + '<div style="font-family:\'Syne\',sans-serif;font-size:.96rem;font-weight:800;'
         + (isToday ? 'color:var(--red);' : 'color:var(--ink);') + '">' + d.getDate() + '</div>'
         + '</div>';
  });
  hdr += '</div>';

  // ‚îÄ‚îÄ Scrollable time grid ‚îÄ‚îÄ
  const totalH = 24 * HOUR_H;
  let grid = '<div id="cal-week-scroll" style="height:520px;overflow-y:auto;">';
  grid += '<div style="position:relative;height:' + totalH + 'px;'
        + 'display:grid;grid-template-columns:' + HOUR_W + 'px repeat(7,1fr);">';

  // Hour labels + horizontal rules
  for (let h = 0; h < 24; h++) {
    const top = h * HOUR_H;
    // Hour label cell (spans only the gutter col via absolute positioning)
    grid += '<div style="position:absolute;left:0;width:' + HOUR_W + 'px;'
          + 'top:' + top + 'px;height:' + HOUR_H + 'px;background:var(--p2);'
          + 'border-top:1px solid var(--ruled);display:flex;align-items:flex-start;'
          + 'justify-content:flex-end;padding:3px 5px 0 0;">'
          + '<span style="font-family:\'Syne\',sans-serif;font-size:.52rem;font-weight:700;'
          + 'color:var(--muted);">' + fmtHour(h) + '</span></div>';
    // Full-width hour line
    grid += '<div style="position:absolute;left:' + HOUR_W + 'px;right:0;'
          + 'top:' + top + 'px;height:1px;background:rgba(207,200,184,.5);pointer-events:none;"></div>';
    // Half-hour line
    grid += '<div style="position:absolute;left:' + HOUR_W + 'px;right:0;'
          + 'top:' + (top + 30 * PX) + 'px;height:1px;'
          + 'background:rgba(207,200,184,.25);pointer-events:none;"></div>';
  }

  // Day columns
  days.forEach(function(d, col) {
    const ds      = getDayStr(d);
    const isToday = ds === todayStr;
    const colFrac = 'calc(' + HOUR_W + 'px + ' + col + ' * (100% - ' + HOUR_W + 'px) / 7)';
    const colW    = 'calc((100% - ' + HOUR_W + 'px) / 7)';

    // Today background strip
    if (isToday) {
      grid += '<div style="position:absolute;left:' + colFrac + ';width:' + colW + ';'
            + 'top:0;bottom:0;background:rgba(184,50,50,.035);pointer-events:none;"></div>';
    }

    // Vertical separator
    grid += '<div style="position:absolute;top:0;bottom:0;left:' + colFrac + ';'
          + 'width:1px;background:rgba(207,200,184,.5);pointer-events:none;"></div>';

    const data = calBlocksForDay(u.id, ds);

    // Meeting blocks
    data.meets.forEach(function(m) {
      const sh = parseInt(m.start.split(':')[0]);
      const sm = parseInt(m.start.split(':')[1]);
      const eh = parseInt(m.end.split(':')[0]);
      const em = parseInt(m.end.split(':')[1]);
      const top    = (sh * 60 + sm) * PX;
      const height = Math.max(((eh * 60 + em) - (sh * 60 + sm)) * PX, 20);
      grid += '<div title="' + esc(m.title) + '"'
            + ' style="position:absolute;left:calc(' + colFrac + ' + 2px);width:calc(' + colW + ' - 4px);'
            + 'top:' + top + 'px;height:' + height + 'px;'
            + 'background:rgba(94,30,130,.14);border-left:3px solid #5e1e82;border-radius:3px;'
            + 'padding:2px 4px;overflow:hidden;cursor:pointer;z-index:2;">'
            + '<div style="font-family:\'Syne\',sans-serif;font-size:.58rem;font-weight:700;'
            + 'color:#5e1e82;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(m.title) + '</div>'
            + '<div style="font-size:.52rem;color:#5e1e82;opacity:.7;">' + m.start + '</div>'
            + '</div>';
    });

    // Scheduled task blocks
    data.tasks.forEach(function(t) {
      if (!t.startTime) return;
      const sh  = parseInt(t.startTime.split(':')[0]);
      const sm  = parseInt(t.startTime.split(':')[1]);
      const dur = parseInt(t.duration) || 30;
      const top    = (sh * 60 + sm) * PX;
      const height = Math.max(dur * PX, 20);
      const color  = _calTaskColor(t);
      grid += '<div onclick="openTaskDetail(' + (t._recurParentId || t.id) + ')" title="' + esc(t.name) + '"'
            + ' style="position:absolute;left:calc(' + colFrac + ' + 2px);width:calc(' + colW + ' - 4px);'
            + 'top:' + top + 'px;height:' + height + 'px;'
            + 'background:' + color + '18;border-left:3px solid ' + color + ';border-radius:3px;'
            + 'padding:2px 4px;overflow:hidden;cursor:pointer;z-index:2;'
            + (t.status === 'done' ? 'opacity:.38;' : '') + '">'
            + '<div style="font-family:\'Syne\',sans-serif;font-size:.58rem;font-weight:700;color:' + color + ';'
            + 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'
            + (t.status === 'done' ? 'text-decoration:line-through;' : '') + '">' + esc(t.name) + '</div>'
            + '<div style="font-size:.52rem;color:' + color + ';opacity:.7;">' + t.startTime + ' ¬∑ ' + dur + 'm</div>'
            + '</div>';
    });

    // Unscheduled task dots at top of column
    const unscheduled = data.tasks.filter(function(t){ return !t.startTime && t.status !== 'done'; });
    if (unscheduled.length) {
      grid += '<div style="position:absolute;left:calc(' + colFrac + ' + 3px);top:3px;'
            + 'display:flex;flex-wrap:wrap;gap:2px;z-index:3;">';
      unscheduled.slice(0, 5).forEach(function(t) {
        const color = _calTaskColor(t);
        grid += '<div onclick="openTaskDetail(' + t.id + ')" title="' + esc(t.name) + '"'
              + ' style="width:7px;height:7px;border-radius:50%;background:' + color + ';cursor:pointer;"></div>';
      });
      if (unscheduled.length > 5) {
        grid += '<span style="font-size:.48rem;color:var(--muted);font-weight:700;line-height:8px;">+' + (unscheduled.length - 5) + '</span>';
      }
      grid += '</div>';
    }
  });

  // Now line
  const nowDate = new Date();
  const nowMins = nowDate.getHours() * 60 + nowDate.getMinutes();
  const nowDs   = getDayStr(nowDate);
  const nowCol  = days.findIndex(function(d){ return getDayStr(d) === nowDs; });
  if (nowCol >= 0) {
    const colFrac = 'calc(' + HOUR_W + 'px + ' + nowCol + ' * (100% - ' + HOUR_W + 'px) / 7)';
    const colW    = 'calc((100% - ' + HOUR_W + 'px) / 7)';
    grid += '<div style="position:absolute;left:' + colFrac + ';width:' + colW + ';'
          + 'top:' + (nowMins * PX) + 'px;height:2px;background:var(--red);z-index:10;pointer-events:none;">'
          + '<div style="position:absolute;left:-4px;top:-4px;width:10px;height:10px;'
          + 'border-radius:50%;background:var(--red);"></div></div>';
  }

  grid += '</div></div>'; // inner + scroll wrapper

  document.getElementById('cal-grid').innerHTML = hdr + grid;

  // Scroll to current hour
  const scrollEl = document.getElementById('cal-week-scroll');
  if (scrollEl) scrollEl.scrollTop = Math.max(0, nowMins * PX - 180);
}

// ‚îÄ‚îÄ DAY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _calRenderDay() {
  const u        = currentUser();
  const ds       = getDayStr(calDate);
  const todayStr = today();
  const isToday  = ds === todayStr;
  const PX       = 1.8;
  const HOUR_W   = 54;

  document.getElementById('cal-label').textContent =
    calDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

  const data     = calBlocksForDay(u.id, ds);
  const nowDate  = new Date();
  const nowMins  = nowDate.getHours() * 60 + nowDate.getMinutes();
  const totalH   = 24 * 60 * PX;

  // Unscheduled chips bar
  const unscheduled = data.tasks.filter(function(t){ return !t.startTime && t.status !== 'done'; });
  let topBar = '';
  if (unscheduled.length) {
    topBar = '<div style="padding:9px 12px;border-bottom:1px solid var(--ruled);background:var(--p2);">'
           + '<div style="font-family:\'Syne\',sans-serif;font-size:.56rem;font-weight:700;'
           + 'text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:5px;">'
           + 'Unscheduled</div>'
           + '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
    unscheduled.forEach(function(t) {
      const color = _calTaskColor(t);
      topBar += '<div onclick="openTaskDetail(' + t.id + ')" title="' + esc(t.name) + '"'
              + ' style="background:' + color + '18;border:1px solid ' + color + '44;border-radius:3px;'
              + 'padding:2px 8px;font-family:\'Syne\',sans-serif;font-size:.62rem;font-weight:700;'
              + 'color:' + color + ';cursor:pointer;white-space:nowrap;">' + esc(t.name) + '</div>';
    });
    topBar += '</div></div>';
  }

  // Scrollable time grid
  let grid = '<div id="cal-day-scroll" style="height:' + (unscheduled.length ? '480' : '540') + 'px;overflow-y:auto;">';
  grid += '<div style="position:relative;height:' + totalH + 'px;">';

  // Hour rows
  for (let h = 0; h < 24; h++) {
    const top     = h * 60 * PX;
    const isNight = h < 6 || h >= 22;
    grid += '<div style="position:absolute;left:0;right:0;top:' + top + 'px;height:' + (60 * PX) + 'px;'
          + 'border-top:1px solid rgba(207,200,184,.5);'
          + 'background:' + (isNight ? 'rgba(0,0,0,.018)' : 'transparent') + ';">'
          + '<div style="position:absolute;left:0;width:' + HOUR_W + 'px;top:0;bottom:0;'
          + 'background:var(--p2);display:flex;align-items:flex-start;justify-content:flex-end;'
          + 'padding:4px 6px 0 0;">'
          + '<span style="font-family:\'Syne\',sans-serif;font-size:.58rem;font-weight:700;'
          + 'color:' + (isNight ? 'rgba(140,127,110,.5)' : 'var(--muted)') + ';">' + fmtHour(h) + '</span>'
          + '</div></div>';
    // Half-hour tick
    grid += '<div style="position:absolute;left:' + HOUR_W + 'px;right:0;'
          + 'top:' + (top + 30 * PX) + 'px;height:1px;background:rgba(207,200,184,.25);"></div>';
  }

  // Events area
  grid += '<div style="position:absolute;left:' + HOUR_W + 'px;right:0;top:0;bottom:0;">';

  // Meetings
  data.meets.forEach(function(m) {
    const sh     = parseInt(m.start.split(':')[0]);
    const sm     = parseInt(m.start.split(':')[1]);
    const eh     = parseInt(m.end.split(':')[0]);
    const em     = parseInt(m.end.split(':')[1]);
    const top    = (sh * 60 + sm) * PX;
    const height = Math.max(((eh * 60 + em) - (sh * 60 + sm)) * PX, 32);
    grid += '<div style="position:absolute;left:4px;right:4px;top:' + top + 'px;height:' + height + 'px;'
          + 'background:rgba(94,30,130,.13);border-left:4px solid #5e1e82;border-radius:4px;'
          + 'padding:4px 8px;overflow:hidden;cursor:pointer;z-index:2;">'
          + '<div style="font-family:\'Syne\',sans-serif;font-size:.72rem;font-weight:700;color:#5e1e82;">' + esc(m.title) + '</div>'
          + '<div style="font-size:.62rem;color:#5e1e82;opacity:.75;">' + m.start + ' ‚Äì ' + m.end
          + (m.location ? ' ¬∑ ' + esc(m.location) : '') + '</div>'
          + '</div>';
  });

  // Scheduled tasks
  data.tasks.forEach(function(t) {
    if (!t.startTime) return;
    const sh     = parseInt(t.startTime.split(':')[0]);
    const sm     = parseInt(t.startTime.split(':')[1]);
    const dur    = parseInt(t.duration) || 30;
    const top    = (sh * 60 + sm) * PX;
    const height = Math.max(dur * PX, 32);
    const color  = _calTaskColor(t);
    const st     = DB.categories.statuses.find(function(s){ return s.id === t.status; });
    grid += '<div onclick="openTaskDetail(' + (t._recurParentId || t.id) + ')" title="' + esc(t.name) + '"'
          + ' style="position:absolute;left:4px;right:4px;top:' + top + 'px;height:' + height + 'px;'
          + 'background:' + color + '16;border-left:4px solid ' + color + ';border-radius:4px;'
          + 'padding:4px 8px;overflow:hidden;cursor:pointer;z-index:2;'
          + (t.status === 'done' ? 'opacity:.38;' : '') + '">'
          + '<div style="font-family:\'Syne\',sans-serif;font-size:.72rem;font-weight:700;color:' + color + ';'
          + (t.status === 'done' ? 'text-decoration:line-through;' : '') + '">' + esc(t.name) + '</div>'
          + '<div style="font-size:.62rem;color:' + color + ';opacity:.75;">'
          + t.startTime + ' ¬∑ ' + dur + 'm' + (st ? ' ¬∑ ' + st.name : '') + '</div>'
          + '</div>';
  });

  grid += '</div>'; // events overlay

  // Now line
  if (isToday) {
    grid += '<div style="position:absolute;left:' + HOUR_W + 'px;right:0;'
          + 'top:' + (nowMins * PX) + 'px;height:2px;background:var(--red);z-index:10;pointer-events:none;">'
          + '<div style="position:absolute;left:-4px;top:-4px;width:10px;height:10px;'
          + 'border-radius:50%;background:var(--red);"></div>'
          + '<span style="position:absolute;left:8px;top:-8px;font-family:\'Syne\',sans-serif;'
          + 'font-size:.52rem;font-weight:800;color:var(--red);background:var(--paper);'
          + 'padding:1px 3px;border-radius:2px;">'
          + String(nowDate.getHours()).padStart(2,'0') + ':' + String(nowDate.getMinutes()).padStart(2,'0')
          + '</span></div>';
  }

  grid += '</div></div>'; // inner + scroll

  document.getElementById('cal-grid').innerHTML = topBar + grid;

  // Scroll to current time
  const scrollEl = document.getElementById('cal-day-scroll');
  if (scrollEl) scrollEl.scrollTop = Math.max(0, nowMins * PX - 200);
}

// ‚îÄ‚îÄ Utility used by week & day ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calBlocksForDay(uid, ds) {
  return {
    tasks: getTasksForDay(uid, ds),
    meets: DB.meetings.filter(function(m){ return m.ownerId === uid && m.date === ds; })
  };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEAM VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTeamView() {
  const u = currentUser();
  const visibleUsers = DB.users.filter(tu => canSeeUser(tu.id));

  // Populate filter dropdowns
  const userSel = document.getElementById('tv-filter-user');
  const curUserVal = userSel.value;
  userSel.innerHTML = '<option value="">All Members</option>' + visibleUsers.map(u=>`<option value="${u.id}" ${u.id==curUserVal?'selected':''}>${esc(u.name||u.username)}</option>`).join('');

  const statusSel = document.getElementById('tv-filter-status');
  if(statusSel.children.length<=1) statusSel.innerHTML='<option value="">All Statuses</option>'+DB.categories.statuses.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  const catSel = document.getElementById('tv-filter-cat');
  if(catSel.children.length<=1) catSel.innerHTML='<option value="">All Categories</option>'+DB.categories.taskCategories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

  const filterUser = userSel.value;
  const filterStatus = statusSel.value;
  const filterCat = catSel.value;
  const search = (document.getElementById('tv-filter-search')?.value||'').toLowerCase();

  let tasks = DB.tasks.filter(t => {
    const owner = DB.users.find(u=>u.id===t.ownerId);
    if(!owner) return false;
    if(!canSeeUser(t.ownerId)) return false;
    if(!t.deletedAt) return true;
    return false;
  });
  if(filterUser) tasks=tasks.filter(t=>t.ownerId==filterUser);
  if(filterStatus) tasks=tasks.filter(t=>t.status===filterStatus);
  if(filterCat) tasks=tasks.filter(t=>t.category===filterCat);
  if(search) tasks=tasks.filter(t=>t.name.toLowerCase().includes(search));
  tasks.sort((a,b)=>(a.due||'9999')>(b.due||'9999')?1:-1);

  // Stats
  const statsEl = document.getElementById('team-stats');
  const doneT = tasks.filter(t=>t.status==='done').length;
  const stuckT = tasks.filter(t=>t.status==='stuck').length;
  const inprogT = tasks.filter(t=>t.status==='inprogress').length;
  statsEl.innerHTML=[
    {val:visibleUsers.length,lbl:'Members',color:'var(--blue)'},
    {val:tasks.length,lbl:'Total Tasks',color:'var(--ink)'},
    {val:stuckT,lbl:'Stuck',color:'var(--red)'},
    {val:doneT,lbl:'Done',color:'var(--green)'}
  ].map(s=>`<div class="card stat-card"><div class="stat-val" style="color:${s.color}">${s.val}</div><div class="stat-lbl">${s.lbl}</div></div>`).join('');

  // Tasks table
  const tbody = document.getElementById('tv-tasks-body');
  tbody.innerHTML = tasks.map(t=>{
    const owner=DB.users.find(u=>u.id===t.ownerId);
    const cat=DB.categories.taskCategories.find(c=>c.id===t.category);
    const status=DB.categories.statuses.find(s=>s.id===t.status)||{name:'Todo',color:'#8c7f6e'};
    const priority=DB.categories.priorities.find(p=>p.id===t.impact)||{name:'Medium',color:'#b87820'};
    const overdue=t.due&&isOverdue(t.due)&&t.status!=='done';
    return `<tr>
      <td><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;">${esc(t.name)}</div>${t.due?`<div style="font-size:.65rem;color:${overdue?'var(--red)':'var(--muted)'};">${overdue?'‚ö† OVERDUE ¬∑ ':''}Due ${fmtDate(t.due)}</div>`:''}</td>
      <td><div style="display:flex;align-items:center;gap:6px;"><div style="width:22px;height:22px;border-radius:50%;background:${owner?.color||'#8c7f6e'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;font-family:'Syne',sans-serif;">${(owner?.name||owner?.username||'?').charAt(0).toUpperCase()}</div><span style="font-size:.76rem;">${esc(owner?.name||owner?.username||'Unknown')}</span></div></td>
      <td>${cat?`<span style="color:${cat.color};font-family:'Syne',sans-serif;font-weight:700;font-size:.68rem;">‚óè ${cat.name}</span>`:'‚Äî'}</td>
      <td><span class="status-badge" style="background:${status.color}22;color:${status.color}">${status.name}</span></td>
      <td style="${overdue?'color:var(--red);font-weight:700;':''}">${t.due?fmtDate(t.due):'‚Äî'}</td>
      <td><span style="color:${priority.color};font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;">${priority.name}</span></td>
      <td><div style="display:flex;gap:4px;">
        <button class="btn btn-xs btn-secondary" onclick="openTaskDetail(${t.id})">View</button>
        <select onchange="adminChangeStatus(${t.id},this.value)" style="border:1px solid var(--ruled);border-radius:3px;font-size:.58rem;padding:2px;background:var(--p2);font-family:'Syne',sans-serif;font-weight:700;">
          ${DB.categories.statuses.map(s=>`<option value="${s.id}" ${s.id===t.status?'selected':''}>${s.name}</option>`).join('')}
        </select>
        <button class="btn btn-xs btn-danger" onclick="adminDeleteTask(${t.id})">√ó</button>
      </div></td>
    </tr>`;
  }).join('');

  // Workload
  const wlEl = document.getElementById('tv-workload-body');
  const maxTasks = Math.max(...visibleUsers.map(u=>DB.tasks.filter(t=>t.ownerId===u.id&&t.status!=='done'&&!t.deletedAt).length),1);
  wlEl.innerHTML = visibleUsers.map(u=>{
    const count=DB.tasks.filter(t=>t.ownerId===u.id&&t.status!=='done'&&!t.deletedAt).length;
    const pct=Math.round(count/maxTasks*100);
    const color=pct>80?'var(--red)':pct>50?'var(--amber)':'var(--green)';
    return `<div class="workload-row">
      <div class="wl-name">${esc(u.name||u.username)}</div>
      <div class="wl-bar-track"><div class="wl-bar-fill" style="width:${pct}%;background:${color};"></div></div>
      <div class="wl-count">${count} tasks</div>
    </div>`;
  }).join('');

  // Deadlines
  const dlBody = document.getElementById('tv-deadlines-body');
  const upcoming = tasks.filter(t=>t.due&&t.status!=='done').sort((a,b)=>a.due>b.due?1:-1);
  dlBody.innerHTML = upcoming.slice(0,20).map(t=>{
    const owner=DB.users.find(u=>u.id===t.ownerId);
    const status=DB.categories.statuses.find(s=>s.id===t.status)||{name:'Todo',color:'#8c7f6e'};
    const daysLeft=Math.ceil((new Date(t.due+'T00:00:00')-new Date())/(86400000));
    const overdue=daysLeft<0;
    return `<tr>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;">${esc(t.name)}</td>
      <td>${esc(owner?.name||owner?.username||'?')}</td>
      <td>${fmtDate(t.due)}</td>
      <td><span class="status-badge" style="background:${status.color}22;color:${status.color}">${status.name}</span></td>
      <td style="font-family:'Syne',sans-serif;font-weight:800;color:${overdue?'var(--red)':daysLeft<=3?'var(--amber)':'var(--green)'};">${overdue?`${Math.abs(daysLeft)}d overdue`:daysLeft===0?'Today':`${daysLeft}d`}</td>
    </tr>`;
  }).join('');
}

function tvTab(tab, btn) {
  document.querySelectorAll('#page-team-view .tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('#page-team-view .tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tv-'+tab).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASSIGN TASK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateAssignForm() {
  const u = currentUser();
  const users = DB.users.filter(tu => tu.id !== u.id && canSeeUser(tu.id) && tu.active!==false);
  document.getElementById('at-assignee').innerHTML = users.map(u=>`<option value="${u.id}">${esc(u.name||u.username)}</option>`).join('');
  document.getElementById('at-category').innerHTML = DB.categories.taskCategories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

async function submitAssignment() {
  const title = document.getElementById('at-title').value.trim();
  const assigneeId = parseInt(document.getElementById('at-assignee').value);
  if(!title||!assigneeId){toast('Please fill title and assignee');return;}
  const u = currentUser();
  const fileInput = document.getElementById('at-file');
  let fileData=null, fileName=null;
  if(fileInput.files[0]) {
    const f=fileInput.files[0];
    if(f.size>512000){toast('File too large (max 500KB)');return;}
    fileData = await fileToBase64(f); fileName=f.name;
  }
  const item = {
    id:'inbox_'+Date.now(), name:title, fromId:u.id, toId:assigneeId,
    category:document.getElementById('at-category').value,
    priority:document.getElementById('at-priority').value,
    deadline:document.getElementById('at-deadline').value||null,
    duration:parseInt(document.getElementById('at-duration').value)||60,
    description:document.getElementById('at-desc').value.trim(),
    link:document.getElementById('at-link').value.trim(),
    fileData, fileName, createdAt:Date.now(), dismissed:false
  };
  DB.inbox.push(item);
  // If email requested
  if(document.getElementById('at-notify').value==='yes') {
    const assignee=DB.users.find(u=>u.id===assigneeId);
    if(assignee?.email) sendEmailJS(assignee.email, assignee.name||assignee.username, `Task Assigned: ${title}`, `You have been assigned a new task by ${u.name||u.username}.\n\nTask: ${title}\nDeadline: ${item.deadline||'Not set'}\nPriority: ${item.priority}\n\n${item.description}`);
  }
  saveDB();
  // Push notification to user if online
  pushNotif(assigneeId, `üì• New task assigned: "${title}" by ${u.name||u.username}`);
  document.getElementById('at-title').value='';document.getElementById('at-desc').value='';document.getElementById('at-link').value='';document.getElementById('at-deadline').value='';fileInput.value='';
  toast(`‚úì Task assigned to ${DB.users.find(u=>u.id===assigneeId)?.name||'user'}`);
  navTo('team-view');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUserManager() {
  const tbody = document.getElementById('user-table-body');
  tbody.innerHTML = DB.users.map(u=>{
    const perms=DB.permissions[u.id]||{canSee:[]};
    const canSeeCount=perms.canSee?.length||0;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:28px;height:28px;border-radius:50%;background:${u.color||'#8c7f6e'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:800;font-family:'Syne',sans-serif;">${(u.name||u.username).charAt(0).toUpperCase()}</div>
        <div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:.8rem;">${esc(u.name||u.username)}</div><div style="font-size:.65rem;color:var(--muted);">@${esc(u.username)}</div></div>
      </div></td>
      <td><span class="status-badge" style="background:${u.role==='admin'?'rgba(184,50,50,.15)':u.role==='manager'?'rgba(30,79,130,.15)':'rgba(42,110,72,.15)'};color:${u.role==='admin'?'var(--red)':u.role==='manager'?'var(--blue)':'var(--green)'};">${u.role}</span></td>
      <td style="font-size:.72rem;">${esc(u.email||'‚Äî')}</td>
      <td><span class="status-badge" style="background:${u.active!==false?'rgba(42,110,72,.15)':'rgba(184,50,50,.15)'};color:${u.active!==false?'var(--green)':'var(--red)'};">${u.active!==false?'Active':'Inactive'}</span></td>
      <td style="font-size:.72rem;color:var(--muted);">${u.lastActive?new Date(u.lastActive).toLocaleDateString():'Never'}</td>
      <td style="font-size:.72rem;">${u.role==='admin'?'All':canSeeCount===0?'Own only':canSeeCount+' users'}</td>
      <td><div style="display:flex;gap:4px;">
        <button class="btn btn-xs btn-secondary" onclick="editUser(${u.id})">Edit</button>
        <button class="btn btn-xs" style="border:1px solid var(--ruled);border-radius:3px;padding:3px 8px;font-family:'Syne',sans-serif;font-size:.54rem;font-weight:700;cursor:pointer;background:${u.active!==false?'rgba(184,50,50,.1)':'rgba(42,110,72,.1)'};color:${u.active!==false?'var(--red)':'var(--green)'};" onclick="toggleUserActive(${u.id})">${u.active!==false?'Deactivate':'Activate'}</button>
      </div></td>
    </tr>`;
  }).join('');
  renderPermMatrix();
}

function renderPermMatrix() {
  const users = DB.users;
  const container = document.getElementById('perm-matrix');
  if(users.length === 0){container.innerHTML='<div style="color:var(--muted);font-size:.76rem;">No users yet</div>';return;}
  let html=`<table class="perm-table"><thead><tr><th>User \\ Can See ‚Üì</th>${users.map(u=>`<th style="font-size:.6rem;max-width:70px;overflow:hidden;">${esc((u.name||u.username).split(' ')[0])}</th>`).join('')}</tr></thead><tbody>`;
  users.forEach(viewer=>{
    const perms=DB.permissions[viewer.id]||{canSee:[]};
    html+=`<tr><td><strong>${esc(viewer.name||viewer.username)}</strong> <span style="font-size:.6rem;color:var(--muted);">(${viewer.role})</span></td>`;
    users.forEach(target=>{
      if(viewer.id===target.id||viewer.role==='admin'){
        html+=`<td style="background:rgba(42,110,72,.08);"><span style="color:var(--green);font-weight:700;">‚úì</span></td>`;
      } else {
        const checked=perms.canSee?.includes(target.id);
        html+=`<td><input type="checkbox" class="perm-check" ${checked?'checked':''} onchange="togglePerm(${viewer.id},${target.id},this.checked)"></td>`;
      }
    });
    html+=`</tr>`;
  });
  html+=`</tbody></table>`;
  container.innerHTML=html;
}

function togglePerm(viewerId, targetId, checked) {
  if(!DB.permissions[viewerId]) DB.permissions[viewerId]={canSee:[]};
  if(checked) {if(!DB.permissions[viewerId].canSee.includes(targetId)) DB.permissions[viewerId].canSee.push(targetId);}
  else DB.permissions[viewerId].canSee=DB.permissions[viewerId].canSee.filter(id=>id!==targetId);
  saveDB(); toast('Permission updated');
}

function openUserModal(uid=null) {
  editingUserId=uid;
  document.getElementById('user-modal-title').textContent=uid?'Edit User':'Add User';
  if(uid){
    const u=DB.users.find(u=>u.id===uid);
    if(!u) return;
    document.getElementById('um-name').value=u.name||'';
    document.getElementById('um-username').value=u.username;
    document.getElementById('um-email').value=u.email||'';
    document.getElementById('um-role').value=u.role;
    document.getElementById('um-color').value=u.color||'#2a6e48';
    document.getElementById('um-password').value='';
    document.getElementById('um-confirm').value='';
  } else {
    ['um-name','um-username','um-email','um-password','um-confirm'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('um-role').value='member';
    document.getElementById('um-color').value='#2a6e48';
  }
  document.getElementById('um-err').style.display='none';
  openModal('user-modal');
}

async function submitUser() {
  const name=document.getElementById('um-name').value.trim();
  const username=document.getElementById('um-username').value.trim().toLowerCase();
  const email=document.getElementById('um-email').value.trim();
  const role=document.getElementById('um-role').value;
  const color=document.getElementById('um-color').value;
  const pw=document.getElementById('um-password').value;
  const pw2=document.getElementById('um-confirm').value;
  const err=document.getElementById('um-err');
  err.style.display='none';
  if(!name||!username){err.textContent='Name and username required.';err.style.display='block';return;}
  if(!editingUserId&&(!pw||pw.length<6)){err.textContent='Password must be at least 6 characters.';err.style.display='block';return;}
  if(pw&&pw!==pw2){err.textContent='Passwords do not match.';err.style.display='block';return;}
  if(!editingUserId&&DB.users.find(u=>u.username===username)){err.textContent='Username already taken.';err.style.display='block';return;}

  if(editingUserId){
    const u=DB.users.find(u=>u.id===editingUserId);
    u.name=name; u.username=username; u.email=email; u.role=role; u.color=color;
    if(pw) u.passwordHash=await hashPassword(pw);
  } else {
    const u={id:genId(),name,username,email,role,color,passwordHash:await hashPassword(pw),active:true,createdAt:Date.now(),lastActive:null};
    DB.users.push(u);
    DB.permissions[u.id]={canSee:[]};
  }
  saveDB(); closeModal('user-modal'); renderUserManager();
  toast(editingUserId?'User updated':'User created ‚úì');
}

function editUser(id){openUserModal(id);}

function toggleUserActive(id){
  const u=DB.users.find(u=>u.id===id);
  if(u){u.active=!(u.active!==false);saveDB();renderUserManager();toast(`User ${u.active?'activated':'deactivated'}`);}
}

function exportUsers(){
  const data=DB.users.map(u=>({username:u.username,name:u.name,email:u.email,role:u.role}));
  downloadJSON(data,'meridian-users.json');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATEGORY MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCatManager() {
  renderCatChips('cat-statuses', DB.categories.statuses, 'statuses');
  renderCatChips('cat-categories', DB.categories.taskCategories, 'taskCategories');
  renderMeetTypes();
  renderPriorities();
}

function renderCatChips(containerId, items, key) {
  const el=document.getElementById(containerId);
  el.innerHTML=items.map((item,i)=>`<span class="cat-chip">
    <span class="cat-color-dot" style="background:${item.color||'var(--muted)'}"></span>
    ${esc(item.name)}
    <button class="cat-chip-del" onclick="deleteCat('${key}',${i})">√ó</button>
  </span>`).join('');
}

function renderMeetTypes(){
  document.getElementById('cat-meet-types').innerHTML=DB.categories.meetingTypes.map((t,i)=>`<span class="cat-chip">${esc(t.name)}<button class="cat-chip-del" onclick="deleteCat('meetingTypes',${i})">√ó</button></span>`).join('');
}

function renderPriorities(){
  document.getElementById('cat-priorities').innerHTML=DB.categories.priorities.map((p,i)=>`<span class="cat-chip"><span class="cat-color-dot" style="background:${p.color}"></span>${esc(p.name)}<button class="cat-chip-del" onclick="deleteCat('priorities',${i})">√ó</button></span>`).join('');
}

function addStatus(){const n=document.getElementById('new-status-name').value.trim();const c=document.getElementById('new-status-color').value;if(!n)return;DB.categories.statuses.push({id:'s'+Date.now(),name:n,color:c});document.getElementById('new-status-name').value='';saveDB();renderCatManager();populateAllSelects();}
function addCategory(){const n=document.getElementById('new-cat-name').value.trim();const c=document.getElementById('new-cat-color').value;if(!n)return;DB.categories.taskCategories.push({id:'c'+Date.now(),name:n,color:c});document.getElementById('new-cat-name').value='';saveDB();renderCatManager();populateAllSelects();}
function addMeetType(){const n=document.getElementById('new-meet-type').value.trim();if(!n)return;DB.categories.meetingTypes.push({id:'mt'+Date.now(),name:n});document.getElementById('new-meet-type').value='';saveDB();renderCatManager();}
function addPriority(){const n=document.getElementById('new-priority').value.trim();const c=document.getElementById('new-priority-color').value;if(!n)return;DB.categories.priorities.push({id:'p'+Date.now(),name:n,color:c});document.getElementById('new-priority').value='';saveDB();renderCatManager();}
function deleteCat(key,idx){DB.categories[key].splice(idx,1);saveDB();renderCatManager();populateAllSelects();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMAIL CENTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEmailCenter() {
  const sel=document.getElementById('em-to');
  sel.innerHTML='<option value="">Select recipient...</option>'+DB.users.map(u=>`<option value="${u.id}">${esc(u.name||u.username)} ${u.email?`<${u.email}>`:''}</option>`).join('');
  renderScheduledEmails();
  renderEmailLog();
}

function applyTemplate() {
  const tpl=document.getElementById('em-template').value;
  const templates={
    status:'Hi {{name}},\n\nHere is a status update on your tasks:\n\n[Task summary will appear here]\n\nBest,\nMERIDIAN',
    reminder:'Hi {{name}},\n\nThis is a reminder that the following task is due soon:\n\n[Task name] ‚Äî Due: [Date]\n\nPlease ensure it is completed on time.\n\nBest,\nMERIDIAN',
    overdue:'Hi {{name}},\n\nThe following task is now OVERDUE:\n\n[Task name] ‚Äî Was due: [Date]\n\nPlease update the status or reschedule.\n\nBest,\nMERIDIAN',
    weekly:'Hi {{name}},\n\nYour weekly summary for {{week}}:\n\n‚úì Completed: [N]\n‚è≥ In Progress: [N]\n‚ö† Stuck: [N]\n\nTop priority this week: [Task]\n\nBest,\nMERIDIAN'
  };
  if(templates[tpl]){document.getElementById('em-body').value=templates[tpl];}
}

function sendEmail() {
  const toId=document.getElementById('em-to').value;
  const subject=document.getElementById('em-subject').value.trim();
  const body=document.getElementById('em-body').value.trim();
  if(!toId||!subject||!body){toast('Please fill all email fields');return;}
  const toUser=DB.users.find(u=>u.id==toId);
  if(!toUser?.email){toast('Recipient has no email address ‚Äî add it in User Manager');return;}
  sendEmailJS(toUser.email, toUser.name||toUser.username, subject, body);
}

function scheduleEmail() {
  const toId=document.getElementById('em-to').value;
  const subject=document.getElementById('em-subject').value.trim();
  const body=document.getElementById('em-body').value.trim();
  const schedTime=document.getElementById('em-schedule').value;
  if(!toId||!subject||!body||!schedTime){toast('Fill all fields and pick a schedule time');return;}
  const toUser=DB.users.find(u=>u.id==toId);
  DB.scheduledEmails.push({id:'se'+Date.now(),toId,toEmail:toUser?.email,toName:toUser?.name||toUser?.username,subject,body,scheduledFor:schedTime,sent:false});
  saveDB(); renderScheduledEmails(); toast('Email scheduled ‚úì');
}

function renderScheduledEmails() {
  const list=document.getElementById('scheduled-emails-list');
  const items=DB.scheduledEmails.filter(e=>!e.sent);
  list.innerHTML=items.length===0?'<div style="font-size:.72rem;color:var(--muted);">No scheduled emails</div>':
    items.map(e=>`<div style="border:1px solid var(--ruled);border-radius:4px;padding:8px 10px;margin-bottom:6px;font-size:.72rem;">
      <div style="font-family:'Syne',sans-serif;font-weight:700;">${esc(e.subject)}</div>
      <div style="color:var(--muted);">To: ${esc(e.toName)} ¬∑ ${new Date(e.scheduledFor).toLocaleString()}</div>
      <button class="btn btn-xs btn-danger" style="margin-top:5px;" onclick="cancelScheduledEmail('${e.id}')">Cancel</button>
    </div>`).join('');
}

function renderEmailLog() {
  const list=document.getElementById('email-log-list');
  const items=DB.emailLog.slice(-10).reverse();
  list.innerHTML=items.length===0?'<div style="font-size:.72rem;color:var(--muted);">No emails sent yet</div>':
    items.map(e=>`<div style="padding:5px 0;border-bottom:1px solid var(--ruled);font-size:.68rem;"><span style="color:${e.success?'var(--green)':'var(--red)'};">‚óè</span> ${esc(e.subject)} ‚Üí ${esc(e.toName)} <span style="color:var(--muted);">${new Date(e.ts).toLocaleString()}</span></div>`).join('');
}

function cancelScheduledEmail(id){DB.scheduledEmails=DB.scheduledEmails.filter(e=>e.id!==id);saveDB();renderScheduledEmails();}

function checkScheduledEmails() {
  const now=new Date();
  DB.scheduledEmails.filter(e=>!e.sent&&new Date(e.scheduledFor)<=now).forEach(e=>{
    sendEmailJS(e.toEmail,e.toName,e.subject,e.body);
    e.sent=true;
  });
  saveDB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMAILJS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê



function logEmail(toEmail,toName,subject,success){
  DB.emailLog.push({toEmail,toName,subject,success,ts:Date.now()});
  if(DB.emailLog.length>100) DB.emailLog=DB.emailLog.slice(-100);
  saveDB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEGRATIONS CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadConfigUI() {
  const cfg=DB.config;
  ['gdriveApiKey','gdriveClientId','gdriveFolderId','serverUrl','serverToken','serverInterval','ejsServiceId','ejsTemplateId','ejsPublicKey','ejsFromName','digestDay','digestTime','digestTo'].forEach(k=>{
    const el=document.getElementById(k.replace(/([A-Z])/g,'-$1').toLowerCase().replace(/^-/,''));
    if(el&&cfg[k]!==undefined) el.value=cfg[k];
  });
  // Map camelCase to kebab-case IDs
  const map={ejsServiceId:'ejs-service',ejsTemplateId:'ejs-template',ejsPublicKey:'ejs-pubkey',ejsFromName:'ejs-from-name',gdriveApiKey:'gdrive-api-key',gdriveClientId:'gdrive-client-id',gdriveFolderId:'gdrive-folder-id',serverUrl:'server-url',serverToken:'server-token',serverInterval:'server-interval',digestDay:'digest-day',digestTime:'digest-time',digestTo:'digest-to'};
  Object.entries(map).forEach(([k,id])=>{const el=document.getElementById(id);if(el&&cfg[k]!==undefined)el.value=cfg[k];});
  if(document.getElementById('auto-overdue')) document.getElementById('auto-overdue').checked=cfg.autoOverdue||false;
  if(document.getElementById('auto-status-change')) document.getElementById('auto-status-change').checked=cfg.autoStatusChange!==false;
  // AI config
  if(document.getElementById('ai-provider')&&cfg.aiProvider) document.getElementById('ai-provider').value=cfg.aiProvider;
  if(document.getElementById('ai-api-key')&&cfg.aiApiKey) document.getElementById('ai-api-key').value=cfg.aiApiKey;
  if(document.getElementById('ai-model')&&cfg.aiModel) document.getElementById('ai-model').value=cfg.aiModel;
  // Email provider
  if(document.getElementById('email-provider')&&cfg.emailProvider) {
    document.getElementById('email-provider').value=cfg.emailProvider;
    updateEmailProviderUI();
  }
  if(document.getElementById('resend-key')&&cfg.resendKey) document.getElementById('resend-key').value=cfg.resendKey;
  if(document.getElementById('resend-from')&&cfg.resendFrom) document.getElementById('resend-from').value=cfg.resendFrom;
  // SMTP
  if(document.getElementById('smtp-host')&&cfg.smtpHost) document.getElementById('smtp-host').value=cfg.smtpHost;
  if(document.getElementById('smtp-port')&&cfg.smtpPort) document.getElementById('smtp-port').value=cfg.smtpPort;
  if(document.getElementById('smtp-user')&&cfg.smtpUser) document.getElementById('smtp-user').value=cfg.smtpUser;
  if(document.getElementById('smtp-from')&&cfg.smtpFrom) document.getElementById('smtp-from').value=cfg.smtpFrom;
  if(document.getElementById('smtp-relay-url')&&cfg.smtpRelayUrl) document.getElementById('smtp-relay-url').value=cfg.smtpRelayUrl;
  if(document.getElementById('sg-key')&&cfg.sgKey) document.getElementById('sg-key').value=cfg.sgKey;
  if(document.getElementById('sg-from')&&cfg.sgFrom) document.getElementById('sg-from').value=cfg.sgFrom;
  if(document.getElementById('webhook-url')&&cfg.webhookUrl) document.getElementById('webhook-url').value=cfg.webhookUrl;
  if(document.getElementById('webhook-auth')&&cfg.webhookAuth) document.getElementById('webhook-auth').value=cfg.webhookAuth;
  if(document.getElementById('w3f-key')&&cfg.w3fKey) document.getElementById('w3f-key').value=cfg.w3fKey;
  if(document.getElementById('w3f-replyto')&&cfg.w3fReplyTo) document.getElementById('w3f-replyto').value=cfg.w3fReplyTo;
  // SMTP
  ['smtp-host','smtp-port','smtp-user','smtp-from','smtp-relay-url','smtp-relay-auth'].forEach(id=>{const k=id.replace(/-([a-z])/g,(_,c)=>c.toUpperCase());const el=document.getElementById(id);if(el&&cfg[k]) el.value=cfg[k];});
  updateEmailProviderUI();
  updateStorageModeUI();
}

function setStorageMode(mode) {
  DB.config.storageMode=mode;
  saveDB(); updateStorageModeUI();
  document.getElementById('gdrive-config').style.display=mode==='gdrive'?'block':'none';
  document.getElementById('server-config').style.display=mode==='server'?'block':'none';
}

function updateStorageModeUI() {
  const mode=DB.config.storageMode||'local';
  ['local','gdrive','server'].forEach(m=>document.getElementById('so-'+m)?.classList.toggle('active',m===mode));
  const tag=document.getElementById('storage-mode-tag');
  if(tag){tag.className='storage-mode-tag sm-'+mode;tag.textContent={local:'Local',gdrive:'Google Drive',server:'Server'}[mode];}
}




function testEmail() {
  const u=currentUser();
  if(!u?.email){toast('Add your email in User Manager first');return;}
  sendEmailJS(u.email,u.name||u.username,'MERIDIAN Test Email','This is a test email from MERIDIAN. Your email integration is working correctly.');
}

function saveAutoConfig() {
  const map={digestDay:'digest-day',digestTime:'digest-time',digestTo:'digest-to'};
  Object.entries(map).forEach(([k,id])=>{const el=document.getElementById(id);if(el) DB.config[k]=el.value;});
  DB.config.autoOverdue=document.getElementById('auto-overdue')?.checked||false;
  DB.config.autoStatusChange=document.getElementById('auto-status-change')?.checked!==false;
  saveDB(); toast('Automation settings saved ‚úì');
}

function connectGDrive() {
  const apiKey=document.getElementById('gdrive-api-key').value.trim();
  const clientId=document.getElementById('gdrive-client-id').value.trim();
  const folderId=document.getElementById('gdrive-folder-id').value.trim();
  if(!apiKey||!clientId){toast('API Key and Client ID required');return;}
  DB.config.gdriveApiKey=apiKey; DB.config.gdriveClientId=clientId; DB.config.gdriveFolderId=folderId;
  saveDB(); toast('Google Drive config saved ‚Äî OAuth flow would launch here in a server deployment');
}

function testServerConnection() {
  const url=document.getElementById('server-url').value.trim();
  if(!url){toast('Enter server URL first');return;}
  const token=document.getElementById('server-token').value.trim();
  fetch(url+'/ping',{headers:token?{Authorization:'Bearer '+token}:{}})
    .then(r=>r.ok?toast('‚úì Server connected!'):toast('Server returned error: '+r.status))
    .catch(()=>toast('Could not reach server ‚Äî check URL and CORS settings'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncNow() {
  const mode=DB.config.storageMode;
  if(mode==='local'){document.getElementById('sync-status-text').textContent='Local mode ‚Äî auto-saved';document.getElementById('sync-dot').className='sync-dot';}
  else if(mode==='server') syncToServer();
  else if(mode==='gdrive') syncToGDrive();
}

async function syncToBackend() {
  const mode=DB.config.storageMode;
  if(mode==='server') syncToServer();
}

function syncToServer() {
  const url=DB.config.serverUrl; const token=DB.config.serverToken;
  if(!url) return;
  document.getElementById('sync-dot').className='sync-dot warn';
  fetch(url+'/save',{method:'POST',headers:{'Content-Type':'application/json',...(token?{Authorization:'Bearer '+token}:{})},body:JSON.stringify(DB)})
    .then(r=>{if(r.ok){document.getElementById('sync-dot').className='sync-dot';document.getElementById('sync-status-text').textContent='Synced: '+new Date().toLocaleTimeString();}else document.getElementById('sync-dot').className='sync-dot err';})
    .catch(()=>document.getElementById('sync-dot').className='sync-dot err');
}

function syncToGDrive() {
  // Google Drive sync requires OAuth ‚Äî placeholder for full implementation
  document.getElementById('sync-status-text').textContent='Google Drive sync requires server deployment';
  document.getElementById('sync-dot').className='sync-dot warn';
}

function exportData() {
  downloadJSON(DB,'meridian-backup-'+today()+'.json');
  toast('Data exported ‚úì');
}

function importData(input) {
  const f=input.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const imported=JSON.parse(e.target.result);
      if(!imported.users||!imported.tasks){toast('Invalid data file');return;}
      if(!confirm('This will replace ALL current data. Continue?')) return;
      DB=imported; saveDB(); initApp(); toast('Data imported ‚úì');
    }catch(e){toast('Failed to parse JSON file');}
  };
  reader.readAsText(f);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASK ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function changeStatus(taskId, statusId) {
  const t=DB.tasks.find(t=>t.id===taskId); if(!t) return;
  const oldStatus=t.status;
  t.status=statusId;
  t.updatedAt=Date.now();
  if(statusId==='done') t.completedAt=Date.now();
  saveDB();
  renderPage(currentPage);
  // Notify assigner if configured
  if(DB.config.autoStatusChange && t.assignedBy && t.assignedBy!==currentUser()?.id) {
    const assigner=DB.users.find(u=>u.id===t.assignedBy);
    const newStatus=DB.categories.statuses.find(s=>s.id===statusId);
    if(assigner?.email) {
      const u=currentUser();
      sendEmailJS(assigner.email, assigner.name||assigner.username, `Task Status Update: ${t.name}`, `${u?.name||u?.username} updated "${t.name}" status to: ${newStatus?.name||statusId}`);
    }
    pushNotif(t.assignedBy, `üìä "${t.name}" ‚Üí ${DB.categories.statuses.find(s=>s.id===statusId)?.name||statusId}`);
  }
}

function adminChangeStatus(taskId, statusId) { changeStatus(taskId, statusId); }

function adminDeleteTask(taskId) {
  if(!confirm('Delete this task?')) return;
  const t=DB.tasks.find(t=>t.id===taskId);
  if(t){t.deletedAt=Date.now();saveDB();renderTeamView();toast('Task deleted');}
}

function openTaskDetail(taskId) {
  const t=DB.tasks.find(t=>t.id===taskId); if(!t) return;
  const owner=DB.users.find(u=>u.id===t.ownerId);
  const assigner=t.assignedBy?DB.users.find(u=>u.id===t.assignedBy):null;
  const cat=DB.categories.taskCategories.find(c=>c.id===t.category);
  const status=DB.categories.statuses.find(s=>s.id===t.status)||{name:'Todo',color:'#8c7f6e'};
  document.getElementById('tdm-title').textContent=t.name;
  document.getElementById('tdm-body').innerHTML=`
    <div class="grid-2" style="gap:10px;margin-bottom:14px;">
      <div class="fg"><label>Status</label><select class="fsel" id="tdm-status" onchange="changeStatus(${t.id},this.value)">${DB.categories.statuses.map(s=>`<option value="${s.id}" ${s.id===t.status?'selected':''}>${s.name}</option>`).join('')}</select></div>
      <div class="fg"><label>Category</label><span style="font-size:.84rem;">${cat?`<span style="color:${cat.color}">‚óè ${cat.name}</span>`:'‚Äî'}</span></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;font-size:.76rem;">
      <div><div style="font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;">Owner</div>${esc(owner?.name||owner?.username||'‚Äî')}</div>
      <div><div style="font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;">Assigned By</div>${esc(assigner?.name||assigner?.username||'Self')}</div>
      <div><div style="font-family:'Syne',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;">Deadline</div>${t.due?`<span style="color:${isOverdue(t.due)&&t.status!=='done'?'var(--red)':'var(--ink)'};">${fmtDate(t.due)}</span>`:'‚Äî'}</div>
    </div>
    ${t.notes?`<div class="fg"><label>Notes</label><div style="background:var(--p2);border:1px solid var(--ruled);border-radius:4px;padding:10px;font-size:.78rem;line-height:1.6;">${esc(t.notes)}</div></div>`:''}
    ${t.link?`<div class="fg"><label>Link</label><a href="${esc(t.link)}" target="_blank" style="color:var(--blue);font-size:.8rem;word-break:break-all;">üîó ${esc(t.link)}</a></div>`:''}
    ${t.fileData?`<div class="fg"><label>Attachment</label><button class="btn btn-secondary btn-sm" onclick="downloadFile(${t.id})">üìé Download ${esc(t.fileName||'file')}</button></div>`:''}
    ${t.recur&&t.recur!=='none'?`<div class="fg"><label>Recurrence</label><div style="display:flex;align-items:center;gap:8px;"><span class="recur-badge">‚Üª ${{'daily':'Daily','weekly':'Weekly','biweekly':'Every 2 weeks','monthly':'Monthly','yearly':'Yearly'}[t.recur]||t.recur}</span>${t.recurEnd?`<span style="font-size:.72rem;color:var(--muted);">until ${fmtDate(t.recurEnd)}</span>`:'<span style="font-size:.72rem;color:var(--muted);">no end date</span>'}</div></div>`:''}
    ${t.startTime?`<div class="fg"><label>Scheduled Time</label><span style="font-family:'Syne',sans-serif;font-weight:700;font-size:.84rem;">${t.startTime}${t.endTime?' ‚Äì '+t.endTime:''}</span><span style="margin-left:8px;color:var(--muted);font-size:.72rem;">${(parseInt(t.duration)||30)>=60?Math.floor((parseInt(t.duration)||30)/60)+'h'+((parseInt(t.duration)||30)%60?` ${(parseInt(t.duration)||30)%60}m`:''):(parseInt(t.duration)||30)+'m'}</span></div>`:`<div class="fg"><label>Duration</label><span style="font-family:'Syne',sans-serif;font-weight:700;font-size:.84rem;">${(parseInt(t.duration)||30)>=60?Math.floor((parseInt(t.duration)||30)/60)+'h'+((parseInt(t.duration)||30)%60?` ${(parseInt(t.duration)||30)%60}m`:''):(parseInt(t.duration)||30)+'m'}</span></div>`}
    <div class="fg"><label>Schedule for Date</label><input class="fi" type="date" id="tdm-date" value="${t.date||''}" onchange="scheduleTask(${t.id},this.value)"></div>
  `;
  document.getElementById('tdm-footer').innerHTML=`<button class="btn btn-secondary" onclick="closeModal('task-detail-modal')">Close</button><button class="btn btn-primary" onclick="closeModal('task-detail-modal');openTaskModal(${t.id})">‚úé Edit</button><button class="btn btn-danger" onclick="adminDeleteTask(${t.id});closeModal('task-detail-modal')">Delete</button>`;
  openModal('task-detail-modal');
}

function scheduleTask(id,date){const t=DB.tasks.find(t=>t.id===id);if(t){t.date=date;t.float='no';saveDB();toast('Task scheduled for '+fmtDate(date));}}

function downloadFile(taskId) {
  const t=DB.tasks.find(t=>t.id===taskId); if(!t?.fileData) return;
  const a=document.createElement('a'); a.href=t.fileData; a.download=t.fileName||'file'; a.click();
}
function downloadInboxFile(id) {
  const item=DB.inbox.find(i=>i.id===id); if(!item?.fileData) return;
  const a=document.createElement('a'); a.href=item.fileData; a.download=item.fileName||'file'; a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASK MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcEndTime() {
  const start = document.getElementById('tm-start-time').value;
  const dur = parseInt(document.getElementById('tm-duration').value)||0;
  if (start && dur>0) {
    const [h,m] = start.split(':').map(Number);
    const endMins = h*60+m+dur;
    const eh = Math.floor(endMins/60)%24;
    const em = endMins%60;
    document.getElementById('tm-end-time').value = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
  }
  updateTimePreview();
}

function calcDuration() {
  const start = document.getElementById('tm-start-time').value;
  const end = document.getElementById('tm-end-time').value;
  if (start && end) {
    const [sh,sm]=start.split(':').map(Number);
    const [eh,em]=end.split(':').map(Number);
    const dur = (eh*60+em)-(sh*60+sm);
    if(dur>0) document.getElementById('tm-duration').value=dur;
  }
  updateTimePreview();
}

function updateTimePreview() {
  const dur = parseInt(document.getElementById('tm-duration').value)||0;
  const start = document.getElementById('tm-start-time').value;
  const end = document.getElementById('tm-end-time').value;
  const est = document.getElementById('tm-estimate').value;
  const finalDur = est ? parseInt(est) : dur;
  const durStr = finalDur>=60?`${Math.floor(finalDur/60)}h${finalDur%60?` ${finalDur%60}m`:''}`:`${finalDur}m`;
  const preview = document.getElementById('time-preview');
  if(preview) {
    let msg = `Duration: ${durStr}`;
    if(start) msg += ` ¬∑ ${start}${end?' ‚Äì '+end:''}`;
    preview.textContent = msg;
  }
}

function toggleRecurOpts() {
  const val = document.getElementById('tm-recur').value;
  const endWrap = document.getElementById('recur-end-wrap');
  const dayWrap = document.getElementById('recur-day-wrap');
  const preview = document.getElementById('recur-preview');
  endWrap.style.display = val!=='none' ? 'block' : 'none';
  dayWrap.style.display = val==='weekly'||val==='biweekly' ? 'block' : 'none';
  preview.style.display = val!=='none' ? 'block' : 'none';
  const labels = {daily:'Every day',weekly:'Every week on selected day',biweekly:'Every 2 weeks',monthly:'Same date each month',yearly:'Same date each year'};
  preview.textContent = val!=='none'?`‚Üª Repeats: ${labels[val]||val}`:'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSONAL TASK / MEETING SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editingTaskId = null;

async function submitPersonalTask() {
  const name=document.getElementById('tm-name').value.trim();
  if(!name){toast('Enter a task name');return;}
  const u=currentUser();
  const fileInput=document.getElementById('tm-file');
  let fileData=null,fileName=null;
  if(fileInput.files[0]){const f=fileInput.files[0];if(f.size>512000){toast('File too large');return;}fileData=await fileToBase64(f);fileName=f.name;}

  // Duration: prefer estimate if set, else field
  const estVal = document.getElementById('tm-estimate').value;
  const durVal = parseInt(document.getElementById('tm-duration').value)||30;
  const finalDur = estVal ? parseInt(estVal) : durVal;

  const taskData={
    name, type:'task', ownerId:u.id,
    category:document.getElementById('tm-category').value,
    urgency:document.getElementById('tm-urgency').value,
    importance:document.getElementById('tm-importance').value,
    impact:document.getElementById('tm-importance').value,
    duration:finalDur,
    startTime:document.getElementById('tm-start-time').value||null,
    endTime:document.getElementById('tm-end-time').value||null,
    zone:document.getElementById('tm-zone').value||null,
    date:document.getElementById('tm-date').value||null,
    due:document.getElementById('tm-due').value||null,
    float:document.getElementById('tm-float').value,
    recur:document.getElementById('tm-recur').value||'none',
    recurEnd:document.getElementById('tm-recur-end').value||null,
    recurDay:document.getElementById('tm-recur-day').value||null,
    notes:document.getElementById('tm-notes').value.trim(),
    link:document.getElementById('tm-link').value.trim(),
    status:document.getElementById('tm-status').value||'todo',
    score:0
  };

  if(editingTaskId) {
    // Edit existing
    const existing = DB.tasks.find(t=>t.id===editingTaskId);
    if(existing) {
      Object.assign(existing, taskData);
      if(fileData){existing.fileData=fileData;existing.fileName=fileName;}
      existing.updatedAt=Date.now();
    }
    toast(`‚úì "${name}" updated`);
  } else {
    const t={id:genId(),...taskData,assignedBy:null,fileData,fileName,createdAt:Date.now()};
    DB.tasks.push(t);
    toast(`‚úì "${name}" added`);
  }
  saveDB(); closeModal('task-modal'); editingTaskId=null;
  renderMyDay();
}

function submitMeeting() {
  const title=document.getElementById('mm-title').value.trim();
  const date=document.getElementById('mm-date').value;
  const start=document.getElementById('mm-start').value;
  const end=document.getElementById('mm-end').value;
  if(!title||!date||!start||!end){toast('Fill title, date and times');return;}
  const u=currentUser();
  const m={id:'m'+Date.now(),title,type:'meeting',ownerId:u.id,meetType:document.getElementById('mm-type').value,date,start,end,location:document.getElementById('mm-location').value.trim(),attendees:document.getElementById('mm-attendees').value.trim(),agenda:document.getElementById('mm-agenda').value.trim()};
  DB.meetings.push(m); saveDB(); closeModal('meet-modal'); renderMyDay(); toast(`üìÖ "${title}" added`);
}

function deleteMeeting(id){if(!confirm('Delete this meeting?'))return;DB.meetings=DB.meetings.filter(m=>m.id!==id);saveDB();renderMyDay();toast('Meeting removed');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS (in-app)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pushNotif(userId, message) {
  // Store in DB for when user logs in
  if(!DB.notifications) DB.notifications=[];
  DB.notifications.push({id:'n'+Date.now(),userId,message,ts:Date.now(),read:false});
  saveDB();
  // If current user, show banner
  if(SESSION?.userId===userId) showNotifBanner(message);
}

function showNotifBanner(message) {
  const bar=document.getElementById('notif-bar');
  const notif=document.createElement('div');
  notif.className='notif';
  notif.innerHTML=`<span class="notif-icon">üîî</span><span class="notif-text">${esc(message)}</span><button class="notif-close" onclick="this.parentElement.remove()">√ó</button>`;
  bar.appendChild(notif);
  setTimeout(()=>notif.remove(),6000);
}

function checkInAppNotifications() {
  if(!DB.notifications||!SESSION) return;
  const unread=DB.notifications.filter(n=>n.userId===SESSION.userId&&!n.read);
  unread.forEach(n=>{showNotifBanner(n.message);n.read=true;});
  if(unread.length>0) saveDB();
}

function notifyStatusChange(userId, message) { pushNotif(userId, message); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAY PLANNER (ZONES)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editingZoneIdx = null;

function renderDayPlanner() {
  const u = currentUser();
  const zones = (u && u.dayZones) || [];
  const list = document.getElementById('dp-zones-list');

  if (zones.length === 0) {
    list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--muted);font-size:.76rem;">No zones yet ‚Äî add your first time block.</div>`;
  } else {
    list.innerHTML = zones.map((z,i) => {
      const taskCount = DB.tasks.filter(t=>t.ownerId===u.id&&t.zone===z.id&&t.status!=='done').length;
      return `<div class="dp-zone">
        <div class="dp-zone-color" style="background:${z.color}"></div>
        <div class="dp-zone-body">
          <div class="dp-zone-name">${esc(z.name)}</div>
          <div class="dp-zone-time">${z.start}${z.end?" ‚Äì "+z.end:""}</div>
          ${z.desc?`<div class="dp-zone-tasks">${esc(z.desc)}</div>`:''}
          <div class="dp-zone-tasks">${taskCount} task${taskCount!==1?'s':''} assigned</div>
        </div>
        <div class="dp-zone-edit btn-row">
          <button class="btn btn-xs btn-secondary" onclick="editZone(${i})">Edit</button>
          <button class="btn btn-xs btn-danger" onclick="deleteZone(${i})">√ó</button>
        </div>
      </div>`;
    }).join('');
  }

  // Render preview timeline
  const previewEl = document.getElementById('dp-preview-timeline');
  if (previewEl) {
    const todayTasks = getTasksForDay(u.id, today());
    const todayMeets = DB.meetings.filter(m=>m.ownerId===u.id&&m.date===today());
    renderVisualTimeline(todayTasks, todayMeets, 'dp-preview-timeline', u.id);
  }
}

function openZoneModal(idx=null) {
  editingZoneIdx=idx;
  document.getElementById('zone-modal-title').textContent=idx!==null?'Edit Zone':'Add Day Zone';
  if(idx!==null){
    const u=currentUser(); const zones=u.dayZones||[];
    const z=zones[idx];
    document.getElementById('zm-name').value=z.name;
    document.getElementById('zm-start').value=z.start;
    document.getElementById('zm-end').value=z.end||''
    document.getElementById('zm-color').value=z.color;
    document.getElementById('zm-desc').value=z.desc||'';
  } else {
    document.getElementById('zm-name').value='';
    document.getElementById('zm-start').value='09:00';
    document.getElementById('zm-end').value='12:00';
    document.getElementById('zm-color').value='#1e4f82';
    document.getElementById('zm-desc').value='';
  }
  openModal('zone-modal');
  document.getElementById('zm-name').focus();
}

function editZone(idx){openZoneModal(idx);}

function submitZone() {
  const name=document.getElementById('zm-name').value.trim();
  const start=document.getElementById('zm-start').value;
  if(!name||!start){toast('Zone name and start time required');return;}
  const u=currentUser();
  if(!u.dayZones) u.dayZones=[];
  const zone={id:'z'+Date.now(),name,start,end:document.getElementById('zm-end').value||null,color:document.getElementById('zm-color').value,desc:document.getElementById('zm-desc').value.trim()};
  if(editingZoneIdx!==null){u.dayZones[editingZoneIdx]=zone;}else{u.dayZones.push(zone);}
  // Update user in DB
  const uIdx=DB.users.findIndex(x=>x.id===u.id);
  if(uIdx>=0) DB.users[uIdx]=u;
  saveDB(); closeModal('zone-modal'); renderDayPlanner();
  // Update zone selects
  populateAllSelects();
  toast(`Zone "${name}" saved`);
}

function deleteZone(idx) {
  if(!confirm('Delete this zone?')) return;
  const u=currentUser();
  if(!u.dayZones) return;
  u.dayZones.splice(idx,1);
  const uIdx=DB.users.findIndex(x=>x.id===u.id);
  if(uIdx>=0) DB.users[uIdx]=u;
  saveDB(); renderDayPlanner(); toast('Zone deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPULATE SELECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateAllSelects() {
  const cats=DB.categories.taskCategories;
  const meetTypes=DB.categories.meetingTypes;
  ['tm-category','at-category'].forEach(id=>{const el=document.getElementById(id);if(el) el.innerHTML=cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');});
  ['mm-type'].forEach(id=>{const el=document.getElementById(id);if(el) el.innerHTML=meetTypes.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');});
  // Status select in task modal
  const statusEl=document.getElementById('tm-status');
  if(statusEl) statusEl.innerHTML=DB.categories.statuses.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  // Zone select in task modal
  const zoneEl=document.getElementById('tm-zone');
  if(zoneEl){
    const u=currentUser();
    const zones=(u&&u.dayZones)||[];
    zoneEl.innerHTML='<option value="">No zone ‚Äî unscheduled</option>'+zones.map(z=>`<option value="${z.id}">${z.name} (${z.start}${z.end?"‚Äì"+z.end:""})</option>`).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function closeIf(e,id){if(e.target===document.getElementById(id))closeModal(id);}
function openTaskModal(taskId=null){
  editingTaskId=taskId;
  populateAllSelects();
  const titleEl=document.getElementById('task-modal-title');
  const submitEl=document.getElementById('task-modal-submit');
  if(taskId){
    const t=DB.tasks.find(x=>x.id===taskId);
    if(!t)return;
    titleEl.textContent='Edit Task';
    submitEl.textContent='Update Task';
    document.getElementById('tm-name').value=t.name;
    document.getElementById('tm-date').value=t.date||today();
    document.getElementById('tm-float').value=t.float||'no';
    document.getElementById('tm-start-time').value=t.startTime||''
    document.getElementById('tm-end-time').value=t.endTime||'';
    document.getElementById('tm-duration').value=t.duration||30;
    document.getElementById('tm-estimate').value='';
    document.getElementById('tm-zone').value=t.zone||'';
    document.getElementById('tm-urgency').value=t.urgency||'medium';
    document.getElementById('tm-importance').value=t.importance||'medium';
    document.getElementById('tm-category').value=t.category||'';
    document.getElementById('tm-due').value=t.due||'';
    document.getElementById('tm-status').value=t.status||'todo';
    document.getElementById('tm-recur').value=t.recur||'none';
    document.getElementById('tm-recur-end').value=t.recurEnd||'';
    document.getElementById('tm-recur-day').value=t.recurDay||'';
    document.getElementById('tm-notes').value=t.notes||'';
    document.getElementById('tm-link').value=t.link||'';
    toggleRecurOpts();
    updateTimePreview();
  } else {
    titleEl.textContent='Add Task';
    submitEl.textContent='Add Task';
    ['tm-name','tm-start-time','tm-end-time','tm-notes','tm-link','tm-recur-end'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    document.getElementById('tm-date').value=today();
    document.getElementById('tm-float').value='no';
    document.getElementById('tm-duration').value=30;
    document.getElementById('tm-estimate').value='';
    document.getElementById('tm-urgency').value='medium';
    document.getElementById('tm-importance').value='medium';
    document.getElementById('tm-recur').value='none';
    document.getElementById('tm-status').value='todo';
    document.getElementById('recur-end-wrap').style.display='none';
    document.getElementById('recur-day-wrap').style.display='none';
    document.getElementById('recur-preview').style.display='none';
    document.getElementById('time-preview').textContent='';
  }
  openModal('task-modal');
  const nameEl = document.getElementById('tm-name');
  nameEl.focus();
  nameEl.oninput = onTaskNameInput;
}
function openMeetModal(){populateAllSelects();document.getElementById('mm-date').value=today();openModal('meet-modal');document.getElementById('mm-title').focus();}

function isOverdue(dateStr){if(!dateStr) return false;return new Date(dateStr+'T00:00:00')<new Date(today()+'T00:00:00');}
function fmtDate(d){if(!d) return '‚Äî';if(typeof d==='number') return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'});return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'});}
function fmtHour(h){if(h===0)return'12am';if(h<12)return h+'am';if(h===12)return'12pm';return(h-12)+'pm';}
function esc(s){if(s===null||s===undefined) return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2800);}
function downloadJSON(data,name){const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();}
function fileToBase64(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(f);});}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEAMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTeamId = null;
let editingTeamId = null;




function getUserTeams(uid) {
  ensureTeams();
  return DB.teams.filter(t => t.members && t.members.includes(uid) || t.leadId === uid);
}

function buildTeamsSidebarNav() {
  const u = currentUser(); if (!u) return;
  ensureTeams();
  const myTeams = u.role === 'admin' ? DB.teams : getUserTeams(u.id);
  const container = document.getElementById('nav-teams-list');
  if (!container) return;
  container.innerHTML = myTeams.map(t =>
    `<div class="sb-item" onclick="openTeamBoard('${t.id}')" id="nav-team-${t.id}" style="padding-left:22px;">
      <span style="width:8px;height:8px;border-radius:50%;background:${t.color};display:inline-block;flex-shrink:0;"></span>
      <span>${esc(t.name)}</span>
    </div>`
  ).join('');
}

function openTeamBoard(teamId) {
  currentTeamId = teamId;
  navTo('team-board');
}

function renderTeamBoard() {
  ensureTeams();
  const team = DB.teams.find(t => t.id === currentTeamId);
  if (!team) { document.getElementById('page-team-board').innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Team not found</div>'; return; }
  const sprint = team.sprint ? ` ‚Äî ${team.sprint}` : '';
  document.getElementById('team-board-heading').textContent = team.name + sprint;
  // Mark active team in sidebar
  document.querySelectorAll('[id^="nav-team-"]').forEach(el => el.classList.remove('active'));
  const activeNav = document.getElementById('nav-team-' + currentTeamId);
  if (activeNav) activeNav.classList.add('active');

  const members = DB.users.filter(u => team.members?.includes(u.id) || u.id === team.leadId);
  // Populate member filter
  const memberSel = document.getElementById('tb-filter-member');
  if (memberSel) {
    const cur = memberSel.value;
    memberSel.innerHTML = '<option value="">All Members</option>' + members.map(u => `<option value="${u.id}" ${u.id==cur?'selected':''}>${esc(u.name||u.username)}</option>`).join('');
  }
  // Populate status filter
  const statusSel = document.getElementById('tb-filter-status');
  if (statusSel && statusSel.children.length <= 1) {
    statusSel.innerHTML = '<option value="">All Statuses</option>' + DB.categories.statuses.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  }
  const filterMember = memberSel?.value || '';
  const filterStatus = statusSel?.value || '';
  let tasks = DB.tasks.filter(t => team.members?.includes(t.ownerId) && !t.deletedAt);
  if (filterMember) tasks = tasks.filter(t => t.ownerId == filterMember);
  if (filterStatus) tasks = tasks.filter(t => t.status === filterStatus);

  renderKanban(tasks, members);
  renderBoardTable(tasks, members);
  renderGantt(tasks, members);
  renderTeamDashboard(tasks, members, currentTeamId);
}

function renderKanban(tasks, members) {
  const container = document.getElementById('tb-kanban');
  const team = currentTeamId ? (DB.teams||[]).find(t=>t.id===currentTeamId) : null;
  const teamWorkflow = team?.workflow?.length ? team.workflow : null;
  const statuses = teamWorkflow
    ? teamWorkflow.map(id => DB.categories.statuses.find(s=>s.id===id)).filter(Boolean)
    : DB.categories.statuses;
  container.innerHTML = `<div class="kanban-board">${statuses.map(s => {
    const sTasks = tasks.filter(t => t.status === s.id);
    return `<div class="kanban-col">
      <div class="kanban-col-hdr">
        <span class="kanban-col-title" style="color:${s.color}">${esc(s.name)}</span>
        <span class="kanban-col-count">${sTasks.length}</span>
      </div>
      <div class="kanban-cards">
        ${sTasks.map(t => {
          const owner = DB.users.find(u => u.id === t.ownerId);
          const cat = DB.categories.taskCategories.find(c => c.id === t.category);
          const overdue = t.due && isOverdue(t.due) && t.status !== 'done';
          const dur = parseInt(t.duration)||30;
          return `<div class="kanban-card" onclick="openTaskDetail(${t.id})">
            <div class="kc-title">${esc(t.name)}</div>
            <div class="kc-meta">
              ${owner?`<span title="${esc(owner.name||owner.username)}" style="width:18px;height:18px;border-radius:50%;background:${owner.color||'#8c7f6e'};color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:.55rem;font-family:'Syne',sans-serif;font-weight:800;flex-shrink:0;">${(owner.name||owner.username).charAt(0).toUpperCase()}</span>`:''}
              ${cat?`<span style="color:${cat.color};font-weight:700;">‚óè ${cat.name}</span>`:''}
              ${dur>=60?`<span>‚è± ${Math.floor(dur/60)}h${dur%60?dur%60+'m':''}</span>`:`<span>‚è± ${dur}m</span>`}
              ${t.due?`<span style="color:${overdue?'var(--red)':'var(--muted)'};">${overdue?'‚ö† ':''}${fmtDate(t.due)}</span>`:''}
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderBoardTable(tasks, members) {
  const tbody = tasks.map(t => {
    const owner = DB.users.find(u => u.id === t.ownerId);
    const cat = DB.categories.taskCategories.find(c => c.id === t.category);
    const status = DB.categories.statuses.find(s => s.id === t.status) || {name:'Todo',color:'#8c7f6e'};
    const dur = parseInt(t.duration)||30;
    const overdue = t.due && isOverdue(t.due) && t.status !== 'done';
    return `<tr>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;cursor:pointer;" onclick="openTaskDetail(${t.id})">${esc(t.name)}</td>
      <td><div style="display:flex;align-items:center;gap:6px;">
        <div style="width:20px;height:20px;border-radius:50%;background:${owner?.color||'#8c7f6e'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;font-family:'Syne',sans-serif;">${(owner?.name||owner?.username||'?').charAt(0).toUpperCase()}</div>
        ${esc(owner?.name||owner?.username||'?')}
      </div></td>
      <td>${cat?`<span style="color:${cat.color};font-family:'Syne',sans-serif;font-weight:700;font-size:.68rem;">‚óè ${cat.name}</span>`:'‚Äî'}</td>
      <td><span class="status-badge" style="background:${status.color}22;color:${status.color}">${status.name}</span></td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;">${dur>=60?`${Math.floor(dur/60)}h${dur%60?dur%60+'m':''}`:dur+'m'}</td>
      <td style="color:${overdue?'var(--red)':'var(--ink)'};">${t.due?fmtDate(t.due):'‚Äî'}</td>
      <td><select onchange="changeStatus(${t.id},this.value)" style="border:1px solid var(--ruled);border-radius:3px;font-size:.6rem;padding:2px;background:var(--p2);font-family:'Syne',sans-serif;font-weight:700;">
        ${DB.categories.statuses.map(s=>`<option value="${s.id}" ${s.id===t.status?'selected':''}>${s.name}</option>`).join('')}
      </select></td>
    </tr>`;
  }).join('');
  document.getElementById('tb-table').innerHTML = `<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Task</th><th>Owner</th><th>Category</th><th>Status</th><th>Duration</th><th>Deadline</th><th>Status</th></tr></thead><tbody>${tbody}</tbody></table></div>`;
}

function renderGantt(tasks, members) {
  if (tasks.length === 0) { document.getElementById('tb-gantt').innerHTML = '<div style="padding:30px;text-align:center;color:var(--muted);font-size:.76rem;">No tasks to display</div>'; return; }
  const today = new Date(); today.setHours(0,0,0,0);
  const allDates = tasks.filter(t=>t.date||t.due).flatMap(t=>[t.date,t.due].filter(Boolean).map(d=>new Date(d+'T00:00:00')));
  if (allDates.length === 0) { document.getElementById('tb-gantt').innerHTML = '<div style="padding:30px;text-align:center;color:var(--muted);">Assign dates to tasks to see Gantt view</div>'; return; }
  const minDate = new Date(Math.min(...allDates, today)); minDate.setDate(minDate.getDate()-1);
  const maxDate = new Date(Math.max(...allDates, today)); maxDate.setDate(maxDate.getDate()+3);
  const totalDays = Math.ceil((maxDate - minDate) / 86400000);
  const dayW = Math.max(28, Math.floor(700 / totalDays));
  const todayOffset = Math.floor((today - minDate) / 86400000);

  // Header dates
  const dateHeaders = [];
  for (let d = 0; d < totalDays; d++) {
    const dt = new Date(minDate); dt.setDate(dt.getDate()+d);
    dateHeaders.push(`<th style="min-width:${dayW}px;font-size:.52rem;white-space:nowrap;text-align:center;${d===todayOffset?'background:rgba(184,50,50,.1);color:var(--red);':''}">${dt.getDate()}/${dt.getMonth()+1}</th>`);
  }

  const rows = tasks.map(t => {
    const owner = DB.users.find(u => u.id === t.ownerId);
    const status = DB.categories.statuses.find(s=>s.id===t.status)||{color:'#8c7f6e'};
    const cat = DB.categories.taskCategories.find(c=>c.id===t.category);
    const startD = t.date ? new Date(t.date+'T00:00:00') : (t.due ? new Date(new Date(t.due+'T00:00:00').getTime()-parseInt(t.duration||30)*60000) : today);
    const endD = t.due ? new Date(t.due+'T00:00:00') : new Date(startD.getTime() + (parseInt(t.duration)||30)*60000);
    const startOff = Math.max(0, Math.floor((startD-minDate)/86400000));
    const durDays = Math.max(1, Math.ceil((endD-startD)/86400000));
    const cells = [];
    for (let d = 0; d < totalDays; d++) {
      if (d === startOff) {
        cells.push(`<td colspan="${Math.min(durDays, totalDays-d)}" style="${d===todayOffset?'background:rgba(184,50,50,.05);':''}">
          <div class="gantt-bar" style="width:100%;height:18px;background:${cat?cat.color:status.color};border-radius:3px;display:flex;align-items:center;padding:0 6px;">
            <span style="font-family:'Syne',sans-serif;font-size:.56rem;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(t.name)}</span>
          </div>
        </td>`);
        d += Math.min(durDays, totalDays-d) - 1;
      } else {
        cells.push(`<td style="${d===todayOffset?'background:rgba(184,50,50,.05);':''}"></td>`);
      }
    }
    return `<tr>
      <td style="white-space:nowrap;font-size:.72rem;font-weight:600;min-width:140px;">${esc(t.name.substring(0,24))}</td>
      <td style="white-space:nowrap;font-size:.68rem;color:var(--muted);min-width:80px;">${esc(owner?.name||'‚Äî')}</td>
      ${cells.join('')}
    </tr>`;
  }).join('');

  document.getElementById('tb-gantt').innerHTML = `<div class="gantt-wrap"><table class="gantt-table"><thead><tr><th>Task</th><th>Owner</th>${dateHeaders.join('')}</tr></thead><tbody>${rows}</tbody></table></div>`;
}




function openAssignToTeam() {
  const team = DB.teams.find(t => t.id === currentTeamId);
  if (!team) return;
  navTo('assign-task');
  // Pre-filter assignee to team members
  setTimeout(() => {
    const sel = document.getElementById('at-assignee');
    if (sel) {
      const members = DB.users.filter(u => team.members?.includes(u.id));
      sel.innerHTML = members.map(u => `<option value="${u.id}">${esc(u.name||u.username)}</option>`).join('');
    }
  }, 100);
}

function openTeamModal(teamId=null) {
  editingTeamId = teamId;
  ensureTeams();
  document.getElementById('team-modal-title').textContent = teamId ? 'Edit Team' : 'Create Team';
  // Populate lead selector
  const leadSel = document.getElementById('team-lead');
  leadSel.innerHTML = DB.users.map(u => `<option value="${u.id}">${esc(u.name||u.username)} (${u.role})</option>`).join('');
  // Populate member checkboxes
  const membersDiv = document.getElementById('team-members-select');
  const team = teamId ? DB.teams.find(t=>t.id===teamId) : null;
  membersDiv.innerHTML = DB.users.map(u => `<label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 0;">
    <input type="checkbox" value="${u.id}" ${team?.members?.includes(u.id)?'checked':''} style="accent-color:var(--green);width:14px;height:14px;">
    <div style="width:22px;height:22px;border-radius:50%;background:${u.color||'#8c7f6e'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:800;font-family:'Syne',sans-serif;">${(u.name||u.username).charAt(0).toUpperCase()}</div>
    <span style="font-size:.78rem;">${esc(u.name||u.username)}</span>
    <span style="font-size:.62rem;color:var(--muted);">(${u.role})</span>
  </label>`).join('');
  // Populate default category dropdown
  const defCatSel = document.getElementById('team-default-cat');
  if (defCatSel) {
    defCatSel.innerHTML = '<option value="">Global default</option>' + DB.categories.taskCategories.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join('');
  }
  if (team) {
    document.getElementById('team-name').value = team.name;
    document.getElementById('team-lead').value = team.leadId;
    document.getElementById('team-color').value = team.color;
    document.getElementById('team-desc').value = team.desc||'';
    if (defCatSel && team.defaultCat) defCatSel.value = team.defaultCat;
    const wfEl = document.getElementById('team-workflow');
    if (wfEl) wfEl.value = (team.workflow||[]).join(',');
    const spEl = document.getElementById('team-sprint');
    if (spEl) spEl.value = team.sprint||'';
  } else {
    document.getElementById('team-name').value = '';
    document.getElementById('team-desc').value = '';
    const wfEl = document.getElementById('team-workflow'); if(wfEl) wfEl.value='';
    const spEl = document.getElementById('team-sprint'); if(spEl) spEl.value='';
  }
  openModal('team-modal');
}

function submitTeam() {
  const name = document.getElementById('team-name').value.trim();
  const leadId = parseInt(document.getElementById('team-lead').value);
  if (!name || !leadId) { toast('Name and lead required'); return; }
  const members = Array.from(document.querySelectorAll('#team-members-select input[type=checkbox]:checked')).map(cb => parseInt(cb.value));
  if (!members.includes(leadId)) members.push(leadId);
  const team = {
    id: editingTeamId || ('team_' + Date.now()),
    name, leadId, color: document.getElementById('team-color').value,
    desc: document.getElementById('team-desc').value.trim(),
    members,
    defaultCat: document.getElementById('team-default-cat')?.value||'',
    workflow: (document.getElementById('team-workflow')?.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    sprint: document.getElementById('team-sprint')?.value?.trim()||'',
    createdAt: Date.now()
  };
  ensureTeams();
  if (editingTeamId) { const idx = DB.teams.findIndex(t=>t.id===editingTeamId); if(idx>=0) DB.teams[idx]=team; }
  else DB.teams.push(team);
  saveDB(); closeModal('team-modal'); renderTeamManager(); buildTeamsSidebarNav();
  toast(`Team "${name}" saved`);
}

function renderTeamManager() {
  ensureTeams();
  const container = document.getElementById('teams-list');
  if (!container) return;
  if (DB.teams.length === 0) {
    container.innerHTML = `<div style="padding:40px;text-align:center;color:var(--muted);grid-column:span 2;"><div style="font-size:2rem;margin-bottom:8px;">üè¢</div><div style="font-family:'Syne',sans-serif;font-weight:700;">No teams yet</div><div style="font-size:.76rem;margin-top:4px;">Create your first team above</div></div>`;
    return;
  }
  container.innerHTML = DB.teams.map(t => {
    const lead = DB.users.find(u => u.id === t.leadId);
    const memberUsers = DB.users.filter(u => t.members?.includes(u.id));
    const nonMembers = DB.users.filter(u => !t.members?.includes(u.id));
    const taskCount = DB.tasks.filter(task => t.members?.includes(task.ownerId) && !task.deletedAt).length;
    const memberAvatars = memberUsers.map(u => `
      <div style="display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:5px;background:var(--p2);margin-bottom:3px;">
        <div style="width:22px;height:22px;border-radius:50%;background:${u.color||'#8c7f6e'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:800;font-family:'Syne',sans-serif;flex-shrink:0;">${(u.name||u.username).charAt(0).toUpperCase()}</div>
        <span style="font-size:.72rem;flex:1;">${esc(u.name||u.username)}</span>
        <span style="font-size:.62rem;color:var(--muted);">${u.role}</span>
        <button class="btn btn-xs btn-danger" onclick="removeTeamMember('${t.id}',${u.id})" title="Remove from team" style="padding:1px 5px;font-size:.6rem;">‚úï</button>
      </div>`).join('');
    const addSelect = nonMembers.length ? `
      <div style="display:flex;gap:6px;margin-top:6px;align-items:center;">
        <select class="fsel" id="add-member-sel-${t.id}" style="flex:1;font-size:.72rem;padding:4px 6px;">
          <option value="">‚Äî Add member ‚Äî</option>
          ${nonMembers.map(u=>`<option value="${u.id}">${esc(u.name||u.username)} (${u.role})</option>`).join('')}
        </select>
        <button class="btn btn-primary btn-sm" onclick="addTeamMember('${t.id}')" style="white-space:nowrap;">+ Add</button>
      </div>` : `<div style="font-size:.68rem;color:var(--muted);margin-top:6px;">All users are already members.</div>`;
    return `<div class="card white" style="border-left:4px solid ${t.color};">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <div style="width:36px;height:36px;border-radius:8px;background:${t.color};display:flex;align-items:center;justify-content:center;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;">${t.name.charAt(0)}</div>
        <div style="flex:1;"><div style="font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;">${esc(t.name)}</div><div style="font-size:.68rem;color:var(--muted);">${t.desc||'No description'}</div></div>
      </div>
      <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">
        <span>Lead: <strong>${esc(lead?.name||lead?.username||'‚Äî')}</strong></span> ¬∑ <span>${memberUsers.length} members</span> ¬∑ <span>${taskCount} tasks</span>
      </div>
      <div style="font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;">Members</div>
      <div style="margin-bottom:2px;">${memberAvatars||'<div style="font-size:.72rem;color:var(--muted);padding:4px 0;">No members yet</div>'}</div>
      ${addSelect}
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-primary btn-sm" onclick="openTeamBoard('${t.id}')">View Board</button>
        <button class="btn btn-secondary btn-sm" onclick="openTeamModal('${t.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteTeam('${t.id}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}

function deleteTeam(id) {
  if (!confirm('Delete this team?')) return;
  DB.teams = DB.teams.filter(t => t.id !== id);
  saveDB(); renderTeamManager(); buildTeamsSidebarNav(); toast('Team deleted');
}

function addTeamMember(teamId) {
  const sel = document.getElementById('add-member-sel-' + teamId);
  if (!sel || !sel.value) { toast('Select a user to add'); return; }
  const uid = parseInt(sel.value);
  const team = DB.teams.find(t => t.id === teamId);
  if (!team) return;
  if (!team.members) team.members = [];
  if (!team.members.includes(uid)) team.members.push(uid);
  saveDB(); renderTeamManager(); buildTeamsSidebarNav();
  const u = DB.users.find(u => u.id === uid);
  toast((u?.name||u?.username||'User') + ' added to ' + team.name);
}

function removeTeamMember(teamId, userId) {
  const team = DB.teams.find(t => t.id === teamId);
  if (!team) return;
  const u = DB.users.find(u => u.id === userId);
  if (!confirm('Remove ' + (u?.name||u?.username||'this user') + ' from ' + team.name + '?')) return;
  team.members = (team.members || []).filter(id => id !== userId);
  // If removed user was lead, clear lead
  if (team.leadId === userId) team.leadId = team.members[0] || null;
  saveDB(); renderTeamManager(); buildTeamsSidebarNav();
  toast((u?.name||u?.username||'User') + ' removed from ' + team.name);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let aiConversation = [];
let parsedTaskData = null;
let aiPanelOpen = false;

function toggleAI() {
  aiPanelOpen = !aiPanelOpen;
  document.getElementById('ai-panel').classList.toggle('open', aiPanelOpen);
  if (aiPanelOpen) document.getElementById('ai-input').focus();
}

function aiKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAIMessage(); }
}

function askAI(prompt) {
  document.getElementById('ai-input').value = prompt;
  sendAIMessage();
}

async function sendAIMessage() {
  const input = document.getElementById('ai-input');
  const rawMsg = input ? input.value : '';
  const msg = rawMsg.trim();
  if (!msg) return;
  if (input) input.value = '';
  appendAIMessage(msg, 'user');
  const btn = document.getElementById('ai-send-btn');
  if (btn) btn.disabled = true;

  // ‚îÄ‚îÄ Built-in command router (fast, no API needed) ‚îÄ‚îÄ
  const lower = msg.toLowerCase().trim();

  if (/^(show|analytics|stats?|summary)/.test(lower) && /analytic|stat|summar|overview|progress/.test(lower)) {
    appendAIMessage(buildLocalAnalytics(), 'ai');
    if (btn) btn.disabled = false; return;
  }
  if (/^(show|list) my tasks/.test(lower)) {
    const u = currentUser();
    const open = DB.tasks.filter(function(t){return t.ownerId===u.id&&!t.deletedAt&&t.status!=='done';}).slice(0,12);
    if (!open.length) { appendAIMessage('No open tasks!', 'ai'); if (btn) btn.disabled=false; return; }
    const tl = open.map(function(t){ const st=DB.categories.statuses.find(function(s){return s.id===t.status;}); return '- **'+t.name+'**'+(t.due?' (due '+fmtDate(t.due)+')':'')+' - '+(st?st.name:t.status); });
    appendAIMessage('Your '+open.length+' open tasks:\n\n'+tl.join('\n'), 'ai');
    if (btn) btn.disabled = false; return;
  }
  if (/workload|show workload|who.*(busy|most)/.test(lower)) {
    const wls = DB.users.filter(function(u2){return canSeeUser(u2.id);}).map(function(u2){
      const act=DB.tasks.filter(function(t){return t.ownerId===u2.id&&t.status!=='done'&&!t.deletedAt;});
      const od=act.filter(function(t){return t.due&&isOverdue(t.due);});
      const sig=od.length>0||act.filter(function(t){return t.status==='stuck';}).length>0?'[HIGH]':act.length>6?'[BUSY]':'[OK]';
      return sig+' **'+(u2.name||u2.username)+'** - '+act.length+' tasks, '+od.length+' overdue, ~'+Math.round(act.reduce(function(s,t){return s+(parseInt(t.duration)||30);},0)/60)+'h';
    });
    appendAIMessage('**Team Workload:**\n\n'+wls.join('\n'), 'ai');
    if (btn) btn.disabled = false; return;
  }
  var reschedMatch = msg.match(/reschedule (.+?) to (.+)/i);
  if (reschedMatch) {
    var tName=reschedMatch[1].trim(), dateStr=reschedMatch[2].trim(), u2=currentUser();
    var found=DB.tasks.filter(function(t){return t.ownerId===u2.id&&!t.deletedAt&&t.name.toLowerCase().indexOf(tName.toLowerCase())>=0;});
    var pd=parseNaturalDate(dateStr);
    if (!found.length){appendAIMessage('No task matching "'+tName+'". Try "show my tasks".','ai');}
    else if (!pd){appendAIMessage('Could not parse "'+dateStr+'". Try "tomorrow", "Monday", or YYYY-MM-DD.','ai');}
    else if (found.length>1){appendAIMessage('Found '+found.length+' matches: '+found.slice(0,3).map(function(t){return '"'+t.name+'"';}).join(', ')+'. Be more specific.','ai');}
    else { appendAIMessage('Rescheduling "'+found[0].name+'" to '+pd,'ai'); queueAIAction('Reschedule "'+found[0].name.substring(0,40)+'" to '+pd, function(){ found[0].date=pd; found[0].float='no'; saveDB(); try{renderPage(currentPage);}catch(ex){} }); }
    if (btn) btn.disabled = false; return;
  }
  var emailMatch = msg.match(/send (?:an? )?email to ([^,]+?)(?:\s+about\s+(.+))?$/i);
  if (emailMatch) {
    var recip=emailMatch[1].trim(), subj=emailMatch[2]?emailMatch[2].trim():'Message from MERIDIAN';
    var tu=DB.users.find(function(u3){return (u3.name||u3.username||'').toLowerCase().indexOf(recip.toLowerCase())>=0;});
    if (!tu||!tu.email){appendAIMessage('No user "'+recip+'" with an email found.','ai'); if(btn)btn.disabled=false; return;}
    var thE=appendAIMessage('Drafting email...','ai thinking');
    callAI('Write a 3-sentence professional email to '+(tu.name||tu.username)+' about: "'+subj+'". Body only.',true).then(function(draft){
      thE.remove(); appendAIMessage('Draft for **'+(tu.name||tu.username)+'** ('+tu.email+'):\n\n'+draft,'ai');
      queueAIAction('Send email to '+(tu.name||tu.username),function(){sendEmailUnified(tu.email,tu.name||tu.username,subj,draft);});
      if(btn)btn.disabled=false;
    }).catch(function(er){thE.remove();appendAIMessage('Draft failed: '+(er.message||er),'ai');if(btn)btn.disabled=false;});
    return;
  }
  if (/weekly report|report.*week/.test(lower)){if(btn)btn.disabled=false; generateWeeklyReport(); return;}
  if (/^risk|.*risk check/.test(lower)){if(btn)btn.disabled=false; aiRiskReport(); return;}

  // ‚îÄ‚îÄ Call AI API ‚îÄ‚îÄ
  const thinkingEl = appendAIMessage('Thinking‚Ä¶', 'ai thinking');

  try {
    const response = await callAI(msg);
    thinkingEl.remove();
    if (response.startsWith('TASK_PARSE:')) {
      try {
        const parsed = JSON.parse(response.substring(11));
        parsedTaskData = parsed;
        showTaskParsePreview(parsed);
        appendAIMessage('I parsed that as a task. Review above and confirm or edit.', 'ai');
      } catch(e) {
        appendAIMessage(response.substring(11), 'ai');
      }
    } else {
      appendAIMessage(response, 'ai');
    }
  } catch(e) {
    thinkingEl.remove();
    const errMsg = e.message || String(e);
    // Parse common API errors into friendly messages
    let friendlyErr = 'AI error: ' + errMsg.substring(0, 120);
    if (errMsg.includes('API key') || errMsg.includes('api_key') || errMsg.includes('401')) {
      friendlyErr = 'Invalid API key. Go to Integrations ‚Üí AI Configuration and re-enter your key.';
    } else if (errMsg.includes('quota') || errMsg.includes('429') || errMsg.includes('rate')) {
      friendlyErr = 'Rate limit hit ‚Äî wait a moment and try again (free tier limit).';
    } else if (errMsg.includes('model') || errMsg.includes('404')) {
      friendlyErr = 'Model not found. Try clearing the Model field in AI Configuration to use the default.';
    } else if (errMsg.includes('fetch') || errMsg.includes('network') || errMsg.includes('Failed to fetch')) {
      friendlyErr = 'Network error ‚Äî check your internet connection.';
    }
    appendAIMessage('‚ö† ' + friendlyErr, 'ai');
    console.error('[AI Error]', errMsg);
  }
  if (btn) btn.disabled = false;
}

function appendAIMessage(text, role) {
  const container = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  div.innerHTML = text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`(.*?)`/g,'<code style="background:rgba(0,0,0,.08);padding:1px 4px;border-radius:3px;font-size:.9em;">$1</code>');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

async function callAI(userMessage, _skipLearn) {
  if (!_skipLearn) { try { aiLearn({ type:'ai_call', msg:(userMessage||'').substring(0,80), ts:Date.now() }); } catch(e2) {} }
  const cfg = DB.config;
  const provider = cfg.aiProvider || 'gemini';
  const apiKey = cfg.aiApiKey;
  if (!apiKey) throw new Error('No API key configured');

  // Build context from user's data
  const u = currentUser();
  const myTasks = DB.tasks.filter(t => t.ownerId === u.id && !t.deletedAt).slice(0,20);
  const myMeets = DB.meetings.filter(m => m.ownerId === u.id && m.date >= today()).slice(0,10);
  const teamTasks = u.role !== 'member' ? DB.tasks.filter(t => canSeeUser(t.ownerId) && !t.deletedAt).slice(0,30) : [];
  const overdue = myTasks.filter(t => t.due && isOverdue(t.due) && t.status !== 'done');
  const myTeamsList = DB.teams ? getUserTeams(u.id) : [];

  const _taskLines = myTasks.slice(0,15).map(function(t){ return '- "' + t.name + '" | status:' + t.status + ' | due:' + (t.due||'none') + ' | duration:' + (t.duration||30) + 'm | cat:' + t.category; }).join('\n');
  const _meetLines = myMeets.slice(0,5).map(function(m){ return '- "' + m.title + '" ' + m.start + '-' + m.end; }).join('\n') || 'None';
  const _overdueLines = overdue.map(function(t){ return '"' + t.name + '" (' + t.due + ')'; }).join(', ') || 'None';
  const _teamLines = teamTasks.length > 0 ? ('TEAM TASKS (' + teamTasks.length + '):\n' + teamTasks.slice(0,15).map(function(t){ const o=DB.users.find(function(u2){return u2.id===t.ownerId;}); return '- "' + t.name + '" | owner:' + (o ? (o.name||o.username) : '?') + ' | status:' + t.status + ' | due:' + (t.due||'none'); }).join('\n')) : '';
  const systemPrompt = 'You are MERIDIAN AI, a smart team planning assistant. You have access to real user data.\n\n' +
    'USER: ' + (u.name||u.username) + ' (' + u.role + ')\nTODAY: ' + today() + '\n\n' +
    'MY TASKS (' + myTasks.length + ' total, ' + overdue.length + ' overdue):\n' + _taskLines + '\n\n' +
    'MY MEETINGS TODAY:\n' + _meetLines + '\n\n' +
    'OVERDUE: ' + _overdueLines + '\n\n' +
    _teamLines + (teamTasks.length>0?'\n\n':'') +
    'CATEGORIES: ' + DB.categories.taskCategories.map(function(c){return c.name;}).join(', ') + '\n' +
    'STATUSES: ' + DB.categories.statuses.map(function(s){return s.name;}).join(', ') + '\n' +
    'TEAMS: ' + (myTeamsList.map(function(t){return t.name;}).join(', ')||'None') + '\n\n' +
    'INSTRUCTIONS:\n' +
    '- Answer questions about tasks, workload, deadlines concisely.\n' +
    '- If user describes a task naturally, respond ONLY with: TASK_PARSE:{"name":"...","date":"YYYY-MM-DD","startTime":"HH:MM","duration":30,"category":"admin","urgency":"medium","importance":"medium","notes":""}\n' +
    '- today=' + today() + '. Infer category from content.\n' +
    '- For email: write professional concise emails.\n' +
    '- Flag tasks with todo/inprogress status and deadlines within 3 days as risks.\n' +
    '- Max 200 words unless writing email/report. Use **bold** and - bullets.';

  // Add to conversation
  aiConversation.push({ role: 'user', content: userMessage });

  let responseText = '';

  if (provider === 'gemini') {
    const model = cfg.aiModel || 'gemini-2.0-flash';
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
    // Gemini requires strictly alternating user/model turns ‚Äî enforce this
    const turns = [];
    let lastRole = null;
    for (const m of aiConversation) {
      const role = m.role === 'assistant' ? 'model' : 'user';
      if (role === lastRole) continue; // skip consecutive same-role (keeps first)
      turns.push({ role, parts: [{ text: m.content }] });
      lastRole = role;
    }
    // Must start with user
    if (!turns.length || turns[0].role !== 'user') {
      turns.unshift({ role: 'user', parts: [{ text: userMessage }] });
    }
    const body = {
      system_instruction: { parts: [{ text: systemPrompt }] },
      contents: turns
    };
    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    if (!res.ok) {
      const errText = await res.text();
      // Reset conversation on API error to prevent stuck state
      aiConversation = [];
      throw new Error('Gemini ' + res.status + ': ' + errText.substring(0, 200));
    }
    const data = await res.json();
    responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';

  } else if (provider === 'groq') {
    const model = cfg.aiModel || 'llama3-8b-8192';
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
      body: JSON.stringify({ model, messages: [{ role:'system', content:systemPrompt }, ...aiConversation], max_tokens:600 })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    responseText = data.choices?.[0]?.message?.content || 'No response';

  } else if (provider === 'openrouter') {
    const model = cfg.aiModel || 'meta-llama/llama-3.1-8b-instruct:free';
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`, 'HTTP-Referer': window.location.href },
      body: JSON.stringify({ model, messages: [{ role:'system', content:systemPrompt }, ...aiConversation], max_tokens:600 })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    responseText = data.choices?.[0]?.message?.content || 'No response';

  } else if (provider === 'huggingface') {
    const model = cfg.aiModel || 'mistralai/Mistral-7B-Instruct-v0.3';
    const prompt = systemPrompt + '\n\n' + aiConversation.map(function(m){return (m.role==='user'?'User: ':'Assistant: ')+m.content;}).join('\n') + '\nAssistant:';
    const res = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
      body: JSON.stringify({ inputs: prompt, parameters: { max_new_tokens:400 } })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    responseText = Array.isArray(data) ? data[0]?.generated_text?.split('Assistant:').pop()?.trim() : (data.error || 'No response');
  }

  aiConversation.push({ role: 'assistant', content: responseText });
  return responseText;
}

function showTaskParsePreview(parsed) {
  const preview = document.getElementById('ai-parse-preview');
  const cats = DB.categories.taskCategories;
  const cat = cats.find(c=>c.id===parsed.category);
  preview.innerHTML = `<div class="ap-title">‚ú¶ AI Parsed Task</div>
    <div class="ai-parse-field"><label>Name</label><span class="ai-parse-val">${esc(parsed.name||'‚Äî')}</span></div>
    <div class="ai-parse-field"><label>Date</label><span class="ai-parse-val">${parsed.date?fmtDate(parsed.date):'Not set'}</span></div>
    <div class="ai-parse-field"><label>Time</label><span class="ai-parse-val">${parsed.startTime||'Not set'}</span></div>
    <div class="ai-parse-field"><label>Duration</label><span class="ai-parse-val">${parsed.duration?parsed.duration+'m':'30m'}</span></div>
    <div class="ai-parse-field"><label>Category</label><span class="ai-parse-val">${cat?cat.name:parsed.category||'‚Äî'}</span></div>
    <div class="ai-parse-field"><label>Urgency</label><span class="ai-parse-val">${parsed.urgency||'medium'}</span></div>
    ${parsed.assignee?`<div class="ai-parse-field"><label>Assign to</label><span class="ai-parse-val">${esc(parsed.assignee)}</span></div>`:''}
    ${parsed.notes?`<div class="ai-parse-field"><label>Notes</label><span class="ai-parse-val">${esc(parsed.notes)}</span></div>`:''}`;
  openModal('ai-parse-modal');
}

function confirmParsedTask() {
  if (!parsedTaskData) return;
  const u = currentUser();
  const t = {
    id: genId(), name: parsedTaskData.name||'New Task', type:'task',
    ownerId: u.id, assignedBy: null,
    category: parsedTaskData.category||'admin',
    urgency: parsedTaskData.urgency||'medium',
    importance: parsedTaskData.importance||'medium',
    impact: parsedTaskData.importance||'medium',
    duration: parseInt(parsedTaskData.duration)||30,
    startTime: parsedTaskData.startTime||null,
    date: parsedTaskData.date||today(),
    due: parsedTaskData.due||null, float:'no',
    notes: parsedTaskData.notes||'', link:'', status:'todo',
    createdAt: Date.now(), score:0
  };
  DB.tasks.push(t); saveDB(); closeModal('ai-parse-modal');
  renderMyDay(); toast(`‚ú¶ AI added: "${t.name}"`);
  parsedTaskData = null;
}

function editParsedTask() {
  if (!parsedTaskData) return;
  closeModal('ai-parse-modal');
  populateAllSelects();
  const modal = document.getElementById('task-modal');
  document.getElementById('tm-name').value = parsedTaskData.name||'';
  document.getElementById('tm-date').value = parsedTaskData.date||today();
  document.getElementById('tm-start-time').value = parsedTaskData.startTime||'';
  document.getElementById('tm-duration').value = parsedTaskData.duration||30;
  document.getElementById('tm-urgency').value = parsedTaskData.urgency||'medium';
  document.getElementById('tm-importance').value = parsedTaskData.importance||'medium';
  document.getElementById('tm-category').value = parsedTaskData.category||'';
  document.getElementById('tm-notes').value = parsedTaskData.notes||'';
  calcEndTime();
  openModal('task-modal');
}

function saveAIConfig() {
  const map = { aiProvider:'ai-provider', aiApiKey:'ai-api-key', aiModel:'ai-model' };
  Object.entries(map).forEach(([k,id])=>{const el=document.getElementById(id);if(el) DB.config[k]=el.value.trim();});
  saveDB();
  document.getElementById('ai-model-label').textContent = 'Powered by ' + ({gemini:'Gemini',groq:'Groq',openrouter:'OpenRouter',huggingface:'HuggingFace'}[DB.config.aiProvider]||'AI');
  toast('AI config saved ‚úì');
}

async function testAI() {
  const btn = event?.target;
  if (btn) { btn.disabled = true; btn.textContent = 'Testing...'; }

  const cfg = DB.config;
  const provider = cfg.aiProvider || 'gemini';
  const apiKey = (cfg.aiApiKey || '').trim();

  // Pre-flight checks
  if (!apiKey) {
    toast('‚ö† No API key saved. Enter your key and click Save first.', 'error');
    if (btn) { btn.disabled = false; btn.textContent = 'Test AI'; }
    return;
  }

  // Diagnose file:// protocol issue
  if (location.protocol === 'file:') {
    toast('‚ö† Running from file:// ‚Äî browsers block API calls. Open via a local server or use the Claude.ai hosted version.', 'error');
    if (btn) { btn.disabled = false; btn.textContent = 'Test AI'; }
    return;
  }

  try {
    // Do a minimal direct fetch to the provider endpoint to get the raw error
    let testUrl, testBody, testHeaders;
    if (provider === 'gemini') {
      const model = cfg.aiModel || 'gemini-2.0-flash';
      testUrl = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + apiKey;
      testHeaders = { 'Content-Type': 'application/json' };
      testBody = JSON.stringify({ contents: [{ role: 'user', parts: [{ text: 'Hi' }] }], generationConfig: { maxOutputTokens: 5 } });
    } else if (provider === 'groq') {
      testUrl = 'https://api.groq.com/openai/v1/chat/completions';
      testHeaders = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey };
      testBody = JSON.stringify({ model: cfg.aiModel || 'llama3-8b-8192', messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 });
    } else if (provider === 'openrouter') {
      testUrl = 'https://openrouter.ai/api/v1/chat/completions';
      testHeaders = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey };
      testBody = JSON.stringify({ model: cfg.aiModel || 'meta-llama/llama-3.1-8b-instruct:free', messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 });
    } else if (provider === 'huggingface') {
      const hfModel = cfg.aiModel || 'mistralai/Mistral-7B-Instruct-v0.3';
      testUrl = 'https://api-inference.huggingface.co/models/' + hfModel;
      testHeaders = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey };
      testBody = JSON.stringify({ inputs: 'Hi', parameters: { max_new_tokens: 5 } });
    }

    const res = await fetch(testUrl, { method: 'POST', headers: testHeaders, body: testBody });
    const rawText = await res.text();

    if (res.ok) {
      toast('‚úì ' + provider.charAt(0).toUpperCase() + provider.slice(1) + ' connected! API key is valid.');
    } else {
      let hint = 'HTTP ' + res.status + ': ';
      if (res.status === 400) hint += 'Bad request (check model name)';
      else if (res.status === 401 || res.status === 403) hint += 'Invalid or unauthorized API key';
      else if (res.status === 404) hint += 'Model not found ‚Äî clear the Model field';
      else if (res.status === 429) hint += 'Rate limit hit ‚Äî wait a moment and try again (free tier limit).';
      else hint += rawText.substring(0, 100);
      toast('‚ö† ' + hint, 'error');
      console.error('[testAI raw response]', rawText);
    }
  } catch(e) {
    const msg = e.message || String(e);
    console.error('[testAI exception]', msg);
    if (msg.includes('fetch') || msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
      toast('‚ö† Network blocked. Are you opening this file directly (file://)? Try serving it via a local server or uploading it somewhere.', 'error');
    } else {
      toast('‚ö† Error: ' + msg.substring(0, 120), 'error');
    }
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Test AI'; }
  }
}

function updateAIProviderUI() {
  const provider = document.getElementById('ai-provider').value;
  const hints = {
    gemini:'aistudio.google.com/app/apikey ¬∑ Free, generous ¬∑ Model: gemini-2.0-flash',
    groq:'console.groq.com ¬∑ Very fast, free ¬∑ Model: llama3-8b-8192 or mixtral-8x7b-32768',
    openrouter:'openrouter.ai ‚Üí free credits ¬∑ Model: meta-llama/llama-3.1-8b-instruct:free',
    huggingface:'huggingface.co/settings/tokens ¬∑ Free ¬∑ Model: mistralai/Mistral-7B-Instruct-v0.3'
  };
  document.getElementById('ai-provider-hint').innerHTML = '‚ú¶ <strong>'+(provider.charAt(0).toUpperCase()+provider.slice(1))+':</strong> '+hints[provider];
  document.getElementById('ai-model').placeholder = {gemini:'gemini-1.5-flash',groq:'llama3-8b-8192',openrouter:'meta-llama/llama-3.1-8b-instruct:free',huggingface:'mistralai/Mistral-7B-Instruct-v0.3'}[provider]||'';
}

// AI-powered task suggestions when typing
let aiSuggestTimeout = null;
function onTaskNameInput() {
  const name = document.getElementById('tm-name')?.value?.trim();
  if (!name || name.length < 6 || !DB.config?.aiApiKey) return;
  clearTimeout(aiSuggestTimeout);
  aiSuggestTimeout = setTimeout(async () => {
    try {
      const prompt = `For the task named "${name}", suggest: category (pick one: ${DB.categories.taskCategories.map(c=>c.id).join(',')}), urgency (high/medium/low), duration in minutes, importance (high/medium/low). Respond ONLY as JSON: {"category":"...","urgency":"...","duration":30,"importance":"..."}`;
      const resp = await callAI(prompt);
      const clean = resp.replace(/```json|```/g,'').trim();
      const parsed = JSON.parse(clean.substring(clean.indexOf('{')));
      if (parsed.category) document.getElementById('tm-category').value = parsed.category;
      if (parsed.urgency) document.getElementById('tm-urgency').value = parsed.urgency;
      if (parsed.duration) document.getElementById('tm-duration').value = parsed.duration;
      if (parsed.importance) document.getElementById('tm-importance').value = parsed.importance;
      calcEndTime();
      const badge = document.querySelector('.ai-inline-badge');
      if (!badge) {
        const b = document.createElement('span');
        b.className = 'ai-inline-badge';
        b.textContent = '‚ú¶ AI filled';
        document.getElementById('tm-name').parentElement.appendChild(b);
        setTimeout(()=>b.remove(), 3000);
      }
    } catch(e) {}
  }, 900);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MULTI-PROVIDER EMAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê









// Patch old sendEmailJS calls to use unified



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI EMAIL DRAFTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function aiDraftEmail() {
  const type = document.getElementById('em-template').value;
  const toId = document.getElementById('em-to').value;
  const toUser = toId ? DB.users.find(u=>u.id==toId) : null;
  const u = currentUser();

  const taskSummary = DB.tasks.filter(t => toUser ? t.ownerId==toId : canSeeUser(t.ownerId))
    .filter(t=>!t.deletedAt).slice(0,10)
    .map(function(t){ return t.name + ': ' + t.status + ', due ' + (t.due||'no deadline'); }).join('\n');

  const _type_lbl = type || 'status update';
  const _to_lbl = toUser ? (' to ' + (toUser.name||toUser.username)) : ' to the team';
  const prompt = 'Write a professional ' + _type_lbl + ' email' + _to_lbl + ' from ' + (u.name||u.username) + ' (MERIDIAN).\n\nTheir tasks:\n' + (taskSummary||'No tasks') + '\n\nWrite email body only (no subject). Be specific and professional.';

  const bodyEl = document.getElementById('em-body');
  bodyEl.value = 'AI is drafting‚Ä¶';
  try {
    const draft = await callAI(prompt);
    bodyEl.value = draft;
    if (!document.getElementById('em-subject').value) {
      document.getElementById('em-subject').value = {status:'Status Update',reminder:'Task Reminder',overdue:'Overdue Alert',weekly:'Weekly Digest'}[type]||'Update from MERIDIAN';
    }
    toast('‚ú¶ Email drafted by AI');
  } catch(e) {
    bodyEl.value = '';
    toast('AI draft failed ‚Äî check API key');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEAM DASHBOARD ‚Äî per-person analytics + traffic lights
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTeamDashboard(tasks, members, teamId) {
  const container = document.getElementById('tb-dashboard');
  if (!container) return;

  const team = DB.teams ? DB.teams.find(t => t.id === teamId) : null;

  // ‚îÄ‚îÄ Team-level summary stats ‚îÄ‚îÄ
  const total = tasks.length;
  const done = tasks.filter(t => t.status === 'done').length;
  const stuck = tasks.filter(t => t.status === 'stuck').length;
  const overdueTasks = tasks.filter(t => t.due && isOverdue(t.due) && t.status !== 'done');
  const pct = total > 0 ? Math.round(done / total * 100) : 0;

  const summaryHtml = `
    <div class="grid-4" style="margin-bottom:18px;">
      <div class="card stat-card"><div class="stat-val" style="color:var(--blue)">${total}</div><div class="stat-lbl">Total Tasks</div></div>
      <div class="card stat-card"><div class="stat-val" style="color:var(--green)">${pct}%</div><div class="stat-lbl">Completion</div></div>
      <div class="card stat-card"><div class="stat-val" style="color:var(--red)">${stuck}</div><div class="stat-lbl">Stuck</div></div>
      <div class="card stat-card"><div class="stat-val" style="color:${overdueTasks.length>0?'var(--red)':'var(--green)'}">${overdueTasks.length}</div><div class="stat-lbl">Overdue</div></div>
    </div>`;

  // ‚îÄ‚îÄ Category breakdown ‚îÄ‚îÄ
  const catBreakdown = DB.categories.taskCategories.map(cat => {
    const catTasks = tasks.filter(t => t.category === cat.id);
    const catDone = catTasks.filter(t => t.status === 'done').length;
    const pctDone = catTasks.length > 0 ? Math.round(catDone / catTasks.length * 100) : 0;
    return { cat, total: catTasks.length, done: catDone, pct: pctDone };
  }).filter(c => c.total > 0);

  const catHtml = catBreakdown.length > 0 ? `
    <div class="card" style="margin-bottom:18px;">
      <div style="font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Category Breakdown</div>
      ${catBreakdown.map(c => `
        <div class="tdb-bar-row" style="margin-bottom:8px;">
          <div class="tdb-bar-label" style="color:${c.cat.color}">${esc(c.cat.name)}</div>
          <div class="tdb-bar-track"><div class="tdb-bar-fill" style="width:${c.pct}%;background:${c.cat.color};"></div></div>
          <div class="tdb-bar-val" style="color:${c.cat.color}">${c.pct}%</div>
          <div style="font-size:.62rem;color:var(--muted);width:48px;text-align:right;">${c.done}/${c.total}</div>
        </div>`).join('')}
    </div>` : '';

  // ‚îÄ‚îÄ Per-person cards with traffic lights ‚îÄ‚îÄ
  const personCards = members.map(member => {
    const mTasks = tasks.filter(t => t.ownerId === member.id);
    const mDone = mTasks.filter(t => t.status === 'done').length;
    const mInprog = mTasks.filter(t => t.status === 'inprogress').length;
    const mStuck = mTasks.filter(t => t.status === 'stuck').length;
    const mOverdue = mTasks.filter(t => t.due && isOverdue(t.due) && t.status !== 'done').length;
    const mTotal = mTasks.length;
    const mPct = mTotal > 0 ? Math.round(mDone / mTotal * 100) : 0;

    // Traffic light logic
    let signal = 'green';
    if (mStuck > 0 || mOverdue > 1) signal = 'red';
    else if (mOverdue === 1 || (mTotal > 0 && mPct < 40)) signal = 'amber';
    else if (mTotal === 0) signal = 'amber';

    // Upcoming deadlines
    const upcoming = mTasks.filter(t => t.due && !isOverdue(t.due) && t.status !== 'done')
      .sort((a, b) => a.due > b.due ? 1 : -1).slice(0, 3);

    // Overdue list
    const overdueList = mTasks.filter(t => t.due && isOverdue(t.due) && t.status !== 'done');

    return `
      <div class="tdb-person-card ${signal}">
        <div class="traffic-light">
          <div class="tl-dot tl-red ${signal === 'red' ? 'active' : ''}"></div>
          <div class="tl-dot tl-amber ${signal === 'amber' ? 'active' : ''}"></div>
          <div class="tl-dot tl-green ${signal === 'green' ? 'active' : ''}"></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <div style="width:30px;height:30px;border-radius:50%;background:${member.color||'#8c7f6e'};color:#fff;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:.76rem;font-weight:800;flex-shrink:0;">${(member.name||member.username).charAt(0).toUpperCase()}</div>
          <div>
            <div class="tdb-person-name">${esc(member.name||member.username)}</div>
            <div class="tdb-person-role">${member.role}</div>
          </div>
        </div>
        <div class="tdb-bar-row"><div class="tdb-bar-label">Done</div><div class="tdb-bar-track"><div class="tdb-bar-fill" style="width:${mPct}%;background:var(--green);"></div></div><div class="tdb-bar-val" style="color:var(--green);">${mPct}%</div></div>
        <div class="tdb-bar-row"><div class="tdb-bar-label">Stuck</div><div class="tdb-bar-track"><div class="tdb-bar-fill" style="width:${mTotal>0?mStuck/mTotal*100:0}%;background:var(--red);"></div></div><div class="tdb-bar-val" style="color:var(--red);">${mStuck}</div></div>
        <div style="font-size:.66rem;color:var(--muted);margin-top:6px;font-family:'Syne',sans-serif;">${mDone}‚úì ${mInprog}‚ñ∂ ${mStuck}‚ö† ${mTotal} total</div>
        ${upcoming.length > 0 ? `<div style="margin-top:8px;border-top:1px solid var(--ruled);padding-top:8px;">
          <div style="font-family:'Syne',sans-serif;font-size:.56rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">Upcoming</div>
          ${upcoming.map(t => `<div style="font-size:.66rem;display:flex;justify-content:space-between;margin-bottom:2px;"><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:130px;">${esc(t.name)}</span><span style="color:var(--muted);flex-shrink:0;margin-left:6px;">${fmtDate(t.due)}</span></div>`).join('')}
        </div>` : ''}
        ${overdueList.length > 0 ? `<div class="risk-ribbon"><div class="risk-ribbon-title">‚ö† ${overdueList.length} Overdue</div>${overdueList.slice(0,2).map(t=>`<div style="font-size:.66rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(t.name)} ‚Äî ${fmtDate(t.due)}</div>`).join('')}</div>` : ''}
      </div>`;
  }).join('');

  // ‚îÄ‚îÄ AI Insights panel ‚îÄ‚îÄ
  const aiInsightsHtml = `
    <div class="ai-insight-card" style="margin-bottom:18px;">
      <div class="ai-insight-title"><span>‚ú¶</span>AI Insights</div>
      <div id="tdb-ai-insights" style="font-size:.74rem;color:var(--muted);line-height:1.7;">
        ${DB.config?.aiApiKey
          ? `<span style="opacity:.6;font-style:italic;">Click "‚ú¶ AI Analyse" in the toolbar to generate insights for this team.</span>`
          : `<span style="opacity:.6;">Configure Gemini API key in Integrations ‚Üí AI Configuration to enable insights.</span>`}
      </div>
    </div>`;

  container.innerHTML = summaryHtml + aiInsightsHtml + catHtml +
    `<div style="font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">Team Members ‚Äî Traffic Light Status</div>` +
    `<div class="tdb-grid">${personCards}</div>`;
}

async function aiAnalyseTeam() {
  if (!DB.config?.aiApiKey) { toast('Configure AI API key in Integrations first'); return; }
  const team = DB.teams ? DB.teams.find(t => t.id === currentTeamId) : null;
  if (!team) return;

  // Switch to dashboard tab
  const dashBtn = document.querySelector('#page-team-board .tab-btn:nth-child(4)');
  if (dashBtn) tbView('dashboard', dashBtn);

  const insightsEl = document.getElementById('tdb-ai-insights');
  if (insightsEl) insightsEl.innerHTML = '<span style="opacity:.6;font-style:italic;">‚ú¶ AI is analysing your team‚Ä¶</span>';

  const members = DB.users.filter(u => team.members?.includes(u.id));
  const tasks = DB.tasks.filter(t => team.members?.includes(t.ownerId) && !t.deletedAt);
  const overdue = tasks.filter(t => t.due && isOverdue(t.due) && t.status !== 'done');
  const stuck = tasks.filter(t => t.status === 'stuck');

  const prompt = `Analyse this team and give 5 concise, actionable insights. Team: ${team.name}.

Members: ${members.map(m => {
    const mt = tasks.filter(t=>t.ownerId===m.id);
    const od = mt.filter(t=>t.due&&isOverdue(t.due)&&t.status!=='done');
    return `${m.name||m.username}: ${mt.length} tasks, ${mt.filter(t=>t.status==='done').length} done, ${od.length} overdue`;
  }).join(' | ')}

Total: ${tasks.length} tasks, ${overdue.length} overdue, ${stuck.length} stuck.

Respond with exactly 5 bullet points (one per line, starting with ‚Ä¢), each under 20 words. Focus on: risks, workload balance, who needs help, what to prioritise.`;

  try {
    const response = await callAI(prompt);
    if (insightsEl) {
      const bullets = response.split('\n').filter(l => l.trim().startsWith('‚Ä¢') || l.trim().startsWith('-') || l.trim().startsWith('*'));
      insightsEl.innerHTML = (bullets.length > 0 ? bullets : response.split('\n').filter(l=>l.trim()))
        .map(b => `<div class="ai-insight-item">${esc(b.replace(/^[‚Ä¢\-\*]\s*/,''))}</div>`).join('');
    }
    // Record AI activity
    aiLearn({ type:'team_analysis', teamId: team.id, result: 'success', ts: Date.now() });
  } catch(e) {
    if (insightsEl) insightsEl.innerHTML = '<span style="color:var(--red);">AI analysis failed ‚Äî check your API key.</span>';
  }
}

// Patch tbView to also render dashboard
function tbView(view, btn) {
  document.querySelectorAll('#page-team-board .tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  document.querySelectorAll('#page-team-board .tab-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('tb-' + view);
  if (panel) panel.classList.add('active');
  if (view === 'dashboard' && currentTeamId) {
    const team = DB.teams ? DB.teams.find(t => t.id === currentTeamId) : null;
    if (team) {
      const members = DB.users.filter(u => team.members?.includes(u.id) || u.id === team.leadId);
      const tasks = DB.tasks.filter(t => team.members?.includes(t.ownerId) && !t.deletedAt);
      renderTeamDashboard(tasks, members, currentTeamId);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI LEARNING ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AI_LEARN_KEY = 'meridian_ai_learn';

function getAIMemory() {
  try { return JSON.parse(localStorage.getItem(AI_LEARN_KEY) || '{}'); } catch(e) { return {}; }
}

function saveAIMemory(mem) {
  localStorage.setItem(AI_LEARN_KEY, JSON.stringify(mem));
}

function aiLearn(event) {
  const mem = getAIMemory();
  if (!mem.events) mem.events = [];
  if (!mem.patterns) mem.patterns = {};
  if (!mem.stats) mem.stats = { tasksCreated:0, tasksCompleted:0, tasksOverdue:0, emailsSent:0, aiCalls:0 };

  mem.events.push({ ...event, ts: event.ts || Date.now() });
  if (mem.events.length > 200) mem.events = mem.events.slice(-200); // keep last 200

  // Update pattern stats
  if (event.type === 'task_created') {
    mem.stats.tasksCreated = (mem.stats.tasksCreated||0) + 1;
    // Track category usage
    if (event.category) {
      if (!mem.patterns.categoryFreq) mem.patterns.categoryFreq = {};
      mem.patterns.categoryFreq[event.category] = (mem.patterns.categoryFreq[event.category]||0) + 1;
    }
    // Track typical durations by category
    if (event.category && event.duration) {
      if (!mem.patterns.avgDuration) mem.patterns.avgDuration = {};
      const prev = mem.patterns.avgDuration[event.category] || { sum:0, count:0 };
      prev.sum += event.duration; prev.count++;
      mem.patterns.avgDuration[event.category] = prev;
    }
  }
  if (event.type === 'task_completed') {
    mem.stats.tasksCompleted = (mem.stats.tasksCompleted||0) + 1;
    if (event.actualDuration && event.estimatedDuration && event.category) {
      if (!mem.patterns.durationAccuracy) mem.patterns.durationAccuracy = {};
      const ratio = event.actualDuration / event.estimatedDuration;
      const prev = mem.patterns.durationAccuracy[event.category] || { sum:0, count:0 };
      prev.sum += ratio; prev.count++;
      mem.patterns.durationAccuracy[event.category] = prev;
    }
  }
  if (event.type === 'task_overdue') mem.stats.tasksOverdue = (mem.stats.tasksOverdue||0) + 1;
  if (event.type === 'email_sent') mem.stats.emailsSent = (mem.stats.emailsSent||0) + 1;
  if (event.type === 'ai_call') mem.stats.aiCalls = (mem.stats.aiCalls||0) + 1;

  // Scheduling suggestion: track what hour tasks get completed
  if (event.type === 'task_completed' && event.hour !== undefined) {
    if (!mem.patterns.productiveHours) mem.patterns.productiveHours = {};
    const h = String(event.hour);
    mem.patterns.productiveHours[h] = (mem.patterns.productiveHours[h]||0) + 1;
  }

  saveAIMemory(mem);
}

function getAIContext() {
  const mem = getAIMemory();
  const u = currentUser();
  const patterns = [];
  if (mem.patterns?.categoryFreq) {
    const top = Object.entries(mem.patterns.categoryFreq).sort((a,b)=>b[1]-a[1]).slice(0,3);
    if (top.length) patterns.push(`Most used categories: ${top.map(([k,v])=>`${k}(${v}x)`).join(', ')}`);
  }
  if (mem.patterns?.productiveHours) {
    const top = Object.entries(mem.patterns.productiveHours).sort((a,b)=>b[1]-a[1]).slice(0,2);
    if (top.length) patterns.push(`Most productive hours: ${top.map(([h])=>fmtHour(parseInt(h))).join(', ')}`);
  }
  if (mem.stats) {
    patterns.push(`Lifetime: ${mem.stats.tasksCreated||0} tasks created, ${mem.stats.tasksCompleted||0} completed, ${mem.stats.tasksOverdue||0} went overdue`);
  }
  return patterns.join('\n');
}

// AI confirmation queue ‚Äî always ask before acting
const aiPendingActions = [];

function queueAIAction(description, actionFn) {
  const id = 'ac' + Date.now();
  aiPendingActions.push({ id, description, actionFn });
  showAIConfirmBar(id, description, actionFn);
}

function showAIConfirmBar(id, description, actionFn) {
  const container = document.getElementById('ai-messages');
  if (!container) return;
  const div = document.createElement('div');
  div.className = 'ai-confirm-bar';
  div.id = 'confirm-bar-' + id;
  div.innerHTML = `<div class="ai-confirm-text">‚ú¶ <strong>Suggested action:</strong> ${esc(description)}</div>
    <div class="ai-confirm-actions">
      <button class="btn btn-primary btn-sm" onclick="confirmAIAction('${id}')">Apply</button>
      <button class="btn btn-secondary btn-sm" onclick="dismissAIAction('${id}')">Skip</button>
    </div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function confirmAIAction(id) {
  const action = aiPendingActions.find(a => a.id === id);
  if (action) { action.actionFn(); aiLearn({ type:'ai_action_confirmed', id, ts:Date.now() }); }
  const bar = document.getElementById('confirm-bar-' + id);
  if (bar) bar.remove();
  toast('‚ú¶ Action applied');
}

function dismissAIAction(id) {
  const bar = document.getElementById('confirm-bar-' + id);
  if (bar) bar.remove();
  aiLearn({ type:'ai_action_dismissed', id, ts:Date.now() });
}

// Patch callAI to inject learning context and record calls



// Track task creation/completion for learning






// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEKLY AI REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateWeeklyReport() {
  if (!DB.config?.aiApiKey) { toast('Configure AI API key first'); return; }
  const u = currentUser();
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
  const weekAgoStr = getDayStr(weekAgo);

  const myTasks = DB.tasks.filter(t => t.ownerId === u.id && !t.deletedAt);
  const completed = myTasks.filter(t => t.status === 'done' && t.completedAt && t.completedAt >= weekAgo.getTime());
  const overdue = myTasks.filter(t => t.due && isOverdue(t.due) && t.status !== 'done');
  const stuck = myTasks.filter(t => t.status === 'stuck');
  const upcoming = myTasks.filter(t => t.due && !isOverdue(t.due) && t.status !== 'done').sort((a,b)=>a.due>b.due?1:-1).slice(0,5);

  const mem = getAIMemory();
  const learnCtx = getAIContext();

  const prompt = `Write a professional weekly progress report for ${u.name||u.username}.

THIS WEEK:
- Completed: ${completed.length} tasks: ${completed.slice(0,5).map(t=>t.name).join(', ')||'None'}
- Overdue: ${overdue.length}: ${overdue.slice(0,3).map(t=>t.name+' ('+t.due+')').join(', ')||'None'}
- Stuck: ${stuck.length}: ${stuck.slice(0,3).map(t=>t.name).join(', ')||'None'}
- Upcoming deadlines: ${upcoming.map(t=>t.name+' ('+t.due+')').join(', ')||'None'}

LEARNED PATTERNS:
${learnCtx}

Write a warm, professional 3-paragraph report with:
1. Achievements this week
2. Risks and blockers  
3. Priorities for next week

Include specific task names. End with one concrete recommendation.`;

  appendAIMessage('Generating your weekly report‚Ä¶', 'ai thinking');
  toggleAI();
  try {
    const report = await callAI(prompt, true);
    const thinkingMsgs = document.querySelectorAll('.ai-msg.thinking');
    thinkingMsgs.forEach(m => m.remove());
    appendAIMessage(report, 'ai');
    aiLearn({ type:'weekly_report', ts:Date.now() });
    // Also offer to email
    queueAIAction(`Email this weekly report to yourself (${u.email||'no email set'})`, () => {
      if (u.email) sendEmailUnified(u.email, u.name||u.username, `Weekly Report ‚Äî ${fmtDate(today())}`, report);
      else toast('Add your email in User Manager first');
    });
  } catch(e) {
    appendAIMessage('Failed to generate report. Check your API key.', 'ai');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RISK PREDICTION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function predictRisks(uid) {
  const tasks = DB.tasks.filter(t => t.ownerId === (uid || currentUser()?.id) && !t.deletedAt && t.status !== 'done');
  const risks = [];
  const now = new Date(); now.setHours(0,0,0,0);

  tasks.forEach(t => {
    const score = { task:t, reasons:[], level:'low' };
    if (t.due) {
      const daysLeft = Math.ceil((new Date(t.due+'T00:00:00') - now) / 86400000);
      if (daysLeft < 0) { score.reasons.push(`${Math.abs(daysLeft)} days overdue`); score.level='critical'; }
      else if (daysLeft === 0) { score.reasons.push('Due today'); score.level='high'; }
      else if (daysLeft <= 2) { score.reasons.push(`${daysLeft} days left`); score.level='high'; }
      else if (daysLeft <= 5) { score.reasons.push(`${daysLeft} days left`); if(score.level==='low') score.level='medium'; }
    }
    if (t.status === 'stuck') { score.reasons.push('Marked stuck'); score.level='high'; }
    if (t.status === 'todo' && t.due && Math.ceil((new Date(t.due+'T00:00:00')-now)/86400000)<=3) { score.reasons.push('Not started, deadline near'); if(score.level!=='critical') score.level='high'; }
    // Pattern-based: check if similar tasks historically ran over
    const mem = getAIMemory();
    if (mem.patterns?.durationAccuracy?.[t.category]) {
      const acc = mem.patterns.durationAccuracy[t.category];
      const ratio = acc.sum / acc.count;
      if (ratio > 1.3) { score.reasons.push(`${t.category} tasks typically run ${Math.round((ratio-1)*100)}% over estimate`); if(score.level==='low') score.level='medium'; }
    }
    if (score.reasons.length > 0) risks.push(score);
  });

  return risks.sort((a,b) => {
    const lvl = {critical:4,high:3,medium:2,low:1};
    return lvl[b.level] - lvl[a.level];
  });
}

async function aiRiskReport() {
  if (!DB.config?.aiApiKey) { toast('Configure AI API key first'); return; }
  const risks = predictRisks();
  if (risks.length === 0) { appendAIMessage('‚úì No significant risks detected. All tasks look on track!', 'ai'); return; }

  const riskSummary = risks.slice(0,8).map(r => `"${r.task.name}" (${r.level}): ${r.reasons.join(', ')}`).join('\n');
  const prompt = `I have these task risks:
${riskSummary}

Give 3-5 specific, actionable suggestions to address these. For each suggestion that would change a task status or reschedule something, phrase it as an action I should take. Keep each suggestion under 25 words.`;

  appendAIMessage('Analysing your risks‚Ä¶', 'ai thinking');
  try {
    const resp = await callAI(prompt, true);
    document.querySelectorAll('.ai-msg.thinking').forEach(m=>m.remove());
    appendAIMessage(`**‚ö† ${risks.filter(r=>r.level==='critical'||r.level==='high').length} high-priority risks found:**\n\n${resp}`, 'ai');

    // Offer actions for critical tasks
    risks.filter(r => r.level === 'critical').slice(0,2).forEach(r => {
      queueAIAction(`Mark "${r.task.name.substring(0,30)}" as stuck to flag for team`, () => {
        changeStatus(r.task.id, 'stuck');
        renderMyDay();
      });
    });
    aiLearn({ type:'risk_analysis', riskCount:risks.length, ts:Date.now() });
  } catch(e) {
    document.querySelectorAll('.ai-msg.thinking').forEach(m=>m.remove());
    appendAIMessage('Risk analysis failed. Check your API key.', 'ai');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMAIL ‚Äî SMTP (BROWSER FETCH RELAY) + ENHANCED PROVIDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Note: Browser SMTP requires a relay endpoint. We provide built-in
// support via a simple SMTP-over-HTTP relay pattern, plus direct
// API calls for Resend/SendGrid/Webhook which work natively in browser.

async function sendEmailUnified(toEmail, toName, subject, message) {
  if (!toEmail) { toast('No recipient email set'); return; }
  const cfg = DB.config;
  const provider = cfg.emailProvider || 'emailjs';
  const fromName = cfg.ejsFromName || 'MERIDIAN';

  try {
    if (provider === 'emailjs') {
      if (!cfg.ejsServiceId || !cfg.ejsPublicKey) { toast('EmailJS not configured ‚Äî go to Integrations'); logEmail(toEmail,toName,subject,false); return; }
      if (typeof emailjs === 'undefined') { toast('EmailJS library not loaded'); return; }
      emailjs.init(cfg.ejsPublicKey);
      await emailjs.send(cfg.ejsServiceId, cfg.ejsTemplateId, { to_email:toEmail, to_name:toName, subject, message, from_name:fromName });
      toast(`‚úâ Sent via EmailJS to ${toName}`); logEmail(toEmail,toName,subject,true);

    } else if (provider === 'resend') {
      if (!cfg.resendKey) { toast('Resend API key not set'); return; }
      const res = await fetch('https://api.resend.com/emails', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+cfg.resendKey },
        body: JSON.stringify({ from:`${fromName} <${cfg.resendFrom||'onboarding@resend.dev'}>`, to:[toEmail], subject, text:message })
      });
      const ok = res.ok; logEmail(toEmail,toName,subject,ok);
      if (ok) toast(`‚úâ Sent via Resend to ${toName}`);
      else { const err = await res.json().catch(()=>{}); toast('Resend error: '+(err?.message||res.status)); }

    } else if (provider === 'web3forms') {
      // Web3Forms ‚Äî free 250/month, no backend, works from browser
      if (!cfg.w3fKey) { toast('Web3Forms access key not set'); return; }
      const formData = new FormData();
      formData.append('access_key', cfg.w3fKey);
      formData.append('subject', subject);
      formData.append('from_name', fromName);
      formData.append('email', toEmail); // recipient shown in notification
      formData.append('message', message);
      if (cfg.w3fReplyTo) formData.append('replyto', cfg.w3fReplyTo);
      const res = await fetch('https://api.web3forms.com/submit', { method:'POST', body:formData });
      const data = await res.json();
      const ok = data.success; logEmail(toEmail,toName,subject,ok);
      if (ok) toast(`‚úâ Sent via Web3Forms to ${toName}`);
      else toast('Web3Forms error: '+(data.message||'check key'));

    } else if (provider === 'smtp') {
      // SMTP relay: user configures their relay endpoint URL
      // Works with: Mailhog, Nodemailer Express relay, Zapier SMTP, etc.
      const relay = cfg.smtpRelayUrl;
      if (!relay) { toast('SMTP relay URL not set ‚Äî see Integrations for setup guide'); return; }
      const headers = { 'Content-Type':'application/json' };
      if (cfg.smtpRelayAuth) headers['Authorization'] = cfg.smtpRelayAuth;
      const body = {
        from: cfg.smtpFrom || cfg.ejsFromName || 'meridian@localhost',
        to: toEmail, toName, subject, text: message,
        // SMTP auth forwarded to relay
        smtp: { host:cfg.smtpHost, port:parseInt(cfg.smtpPort)||587, user:cfg.smtpUser, pass:cfg.smtpPass, secure:cfg.smtpSecure||false }
      };
      const res = await fetch(relay, { method:'POST', headers, body:JSON.stringify(body) });
      const ok = res.ok; logEmail(toEmail,toName,subject,ok);
      if (ok) toast(`‚úâ Sent via SMTP to ${toName}`);
      else toast('SMTP relay error: '+res.status);

    } else if (provider === 'webhook') {
      if (!cfg.webhookUrl) { toast('Webhook URL not set'); return; }
      const headers = { 'Content-Type':'application/json' };
      if (cfg.webhookAuth) headers['Authorization'] = cfg.webhookAuth;
      const res = await fetch(cfg.webhookUrl, {
        method:'POST', headers,
        body: JSON.stringify({ to_email:toEmail, to_name:toName, subject, message, from_name:fromName, timestamp:new Date().toISOString() })
      });
      const ok = res.ok; logEmail(toEmail,toName,subject,ok);
      if (ok) toast(`‚úâ Webhook sent to ${toName}`); else toast('Webhook error: '+res.status);

    } else if (provider === 'sendgrid') {
      if (!cfg.sgKey) { toast('SendGrid key not set'); return; }
      const res = await fetch('https://api.sendgrid.com/v3/mail/send', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+cfg.sgKey },
        body: JSON.stringify({ personalizations:[{to:[{email:toEmail,name:toName}]}], from:{email:cfg.sgFrom||'noreply@example.com',name:fromName}, subject, content:[{type:'text/plain',value:message}] })
      });
      const ok = res.ok||res.status===202; logEmail(toEmail,toName,subject,ok);
      if(ok) toast(`‚úâ SendGrid sent to ${toName}`); else toast('SendGrid error: '+res.status);
    }
    aiLearn({ type:'email_sent', provider, to:toEmail, ts:Date.now() });
  } catch(err) {
    toast('Email failed: '+(err.message||String(err)));
    logEmail(toEmail, toName, subject, false);
  }
}

// Patch old function name to route through new one
function sendEmailJS(toEmail, toName, subject, message) {
  sendEmailUnified(toEmail, toName, subject, message);
}

// Update email config save to include SMTP fields
function saveEmailConfig() {
  const cfg = DB.config;
  const provider = document.getElementById('email-provider')?.value || 'emailjs';
  cfg.emailProvider = provider;
  // EmailJS
  ['ejsServiceId:ejs-service','ejsTemplateId:ejs-template','ejsPublicKey:ejs-pubkey','ejsFromName:ejs-from-name'].forEach(pair => {
    const [k,id] = pair.split(':');
    const el = document.getElementById(id); if(el) cfg[k]=el.value.trim();
  });
  // Resend
  cfg.resendKey = document.getElementById('resend-key')?.value?.trim()||cfg.resendKey||'';
  cfg.resendFrom = document.getElementById('resend-from')?.value?.trim()||cfg.resendFrom||'';
  // SMTP
  cfg.smtpRelayUrl = document.getElementById('smtp-relay-url')?.value?.trim()||cfg.smtpRelayUrl||'';
  cfg.smtpRelayAuth = document.getElementById('smtp-relay-auth')?.value?.trim()||cfg.smtpRelayAuth||'';
  cfg.smtpHost = document.getElementById('smtp-host')?.value?.trim()||cfg.smtpHost||'';
  cfg.smtpPort = document.getElementById('smtp-port')?.value||cfg.smtpPort||'587';
  cfg.smtpUser = document.getElementById('smtp-user')?.value?.trim()||cfg.smtpUser||'';
  cfg.smtpPass = document.getElementById('smtp-pass')?.value?.trim()||cfg.smtpPass||'';
  cfg.smtpFrom = document.getElementById('smtp-from')?.value?.trim()||cfg.smtpFrom||'';
  // SendGrid
  cfg.sgKey = document.getElementById('sg-key')?.value?.trim()||cfg.sgKey||'';
  cfg.sgFrom = document.getElementById('sg-from')?.value?.trim()||cfg.sgFrom||'';
  // Webhook
  cfg.webhookUrl = document.getElementById('webhook-url')?.value?.trim()||cfg.webhookUrl||'';
  cfg.webhookAuth = document.getElementById('webhook-auth')?.value?.trim()||cfg.webhookAuth||'';
  // Web3Forms
  cfg.w3fKey = document.getElementById('w3f-key')?.value?.trim()||cfg.w3fKey||'';
  cfg.w3fReplyTo = document.getElementById('w3f-replyto')?.value?.trim()||cfg.w3fReplyTo||'';
  saveDB(); toast('Email config saved ‚úì');
}

function updateEmailProviderUI() {
  const provider = document.getElementById('email-provider')?.value || 'emailjs';
  ['emailjs','resend','web3forms','smtp','sendgrid','webhook'].forEach(p => {
    const el = document.getElementById('ep-'+p);
    if (el) { el.style.display = p===provider ? 'block' : 'none'; el.classList.toggle('visible', p===provider); }
    const card = document.getElementById('epc-'+p);
    if (card) card.classList.toggle('active-provider', p===provider);
  });
  DB.config.emailProvider = provider;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI WORKLOAD ASSIGNMENT SUGGESTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function aiSuggestAssignee(taskName, taskDesc) {
  if (!DB.config?.aiApiKey) return null;
  const u = currentUser();
  const team = currentTeamId ? DB.teams?.find(t=>t.id===currentTeamId) : null;
  const candidates = team
    ? DB.users.filter(u2 => team.members?.includes(u2.id))
    : DB.users.filter(u2 => canSeeUser(u2.id) && u2.id !== u.id);

  if (candidates.length === 0) return null;

  const workloads = candidates.map(u2 => {
    const active = DB.tasks.filter(t=>t.ownerId===u2.id&&t.status!=='done'&&!t.deletedAt);
    const overdue = active.filter(t=>t.due&&isOverdue(t.due));
    return { user:u2, active:active.length, overdue:overdue.length };
  });

  const prompt = `For task: "${taskName}". ${taskDesc?'Description: '+taskDesc:''}

Team workload:
${workloads.map(w=>`${w.user.name||w.user.username}: ${w.active} active tasks, ${w.overdue} overdue`).join('\n')}

Who should I assign this to? Respond with ONLY the person's name and one sentence of reasoning. Format: NAME: reason`;

  try {
    const resp = await callAI(prompt, true);
    const match = resp.match(/^([^:]+):\s*(.+)/);
    if (match) return { name: match[1].trim(), reason: match[2].trim() };
    return null;
  } catch(e) { return null; }
}

// Hook into assign task form
async function aiHintAssignee() {
  const title = document.getElementById('at-title')?.value?.trim();
  const desc = document.getElementById('at-desc')?.value?.trim();
  if (!title || !DB.config?.aiApiKey) return;
  const hint = document.getElementById('at-ai-hint');
  if (hint) hint.textContent = '‚ú¶ AI thinking‚Ä¶';
  const suggestion = await aiSuggestAssignee(title, desc);
  if (hint && suggestion) {
    hint.innerHTML = `‚ú¶ AI suggests: <strong>${esc(suggestion.name)}</strong> ‚Äî ${esc(suggestion.reason)}`;
    // Try to auto-select in dropdown
    const sel = document.getElementById('at-assignee');
    if (sel) {
      Array.from(sel.options).forEach(opt => {
        if (opt.text.toLowerCase().includes(suggestion.name.toLowerCase())) sel.value = opt.value;
      });
    }
  } else if (hint) {
    hint.textContent = '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSOLE ERROR FIXES ‚Äî safe element accessors
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function safeGet(id) {
  const el = document.getElementById(id);
  return el || { value:'', innerHTML:'', style:{}, checked:false, textContent:'' };
}

// Patch renderMyDay to not crash if elements missing

// Prevent onTaskNameInput crash when AI not configured



// Fix aiConversation not being reset between conversations
function clearAIChat() {
  aiConversation = [];
  const container = document.getElementById('ai-messages');
  if (container) container.innerHTML = '<div class="ai-msg ai">Chat cleared. Start a new conversation!</div>';
}

// Add weekly report + risk buttons to AI suggestions
function refreshAISuggestions() {
  const strip = document.getElementById('ai-suggestions');
  if (!strip) return;
  strip.innerHTML = `
    <span class="ai-suggestion" onclick="sendAIMessage_direct('show my tasks')">üìã My tasks</span>
    <span class="ai-suggestion" onclick="sendAIMessage_direct('show analytics')">üìä Analytics</span>
    <span class="ai-suggestion" onclick="aiRiskReport()">‚ö† Risks</span>
    <span class="ai-suggestion" onclick="generateWeeklyReport()">üìù Weekly report</span>
    <span class="ai-suggestion" onclick="sendAIMessage_direct('show workload')">üë• Workload</span>
    <span class="ai-suggestion" onclick="clearAIChat()">‚úï Clear</span>`;
}

function sendAIMessage_direct(msg) {
  const input = document.getElementById('ai-input');
  if (input) { input.value = msg; sendAIMessage(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERDUE LEARNING TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkOverdueLearning() {
  const u = currentUser(); if (!u) return;
  const mem = getAIMemory();
  const lastCheck = mem.lastOverdueCheck || 0;
  const now = Date.now();
  // Only run once per hour
  if (now - lastCheck < 3600000) return;
  const tasks = DB.tasks.filter(t => t.ownerId === u.id && !t.deletedAt && t.due && isOverdue(t.due) && t.status !== 'done');
  tasks.forEach(t => {
    const key = 'od_' + t.id;
    if (!mem[key]) {
      aiLearn({ type:'task_overdue', name:t.name?.substring(0,40), category:t.category, daysOverdue:Math.abs(Math.ceil((new Date(t.due+'T00:00:00')-new Date())/86400000)), ts:now });
      mem[key] = true;
    }
  });
  mem.lastOverdueCheck = now;
  saveAIMemory(mem);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI COMMAND ROUTER ‚Äî interprets chat as commands
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Intercept sendAIMessage to route commands before sending to API



// Parse natural language dates
function parseNaturalDate(str) {
  const s = str.toLowerCase().trim();
  const today = new Date(); today.setHours(0,0,0,0);
  if (s === 'today') return getDayStr(today);
  if (s === 'tomorrow') { const d=new Date(today); d.setDate(d.getDate()+1); return getDayStr(d); }
  const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dayIdx = days.indexOf(s);
  if (dayIdx >= 0) {
    const d = new Date(today);
    const diff = (dayIdx - d.getDay() + 7) % 7 || 7;
    d.setDate(d.getDate()+diff);
    return getDayStr(d);
  }
  // Try ISO format
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  // Try MM/DD
  const mmdd = s.match(/^(\d{1,2})\/(\d{1,2})$/);
  if (mmdd) {
    const d=new Date(today.getFullYear(), parseInt(mmdd[1])-1, parseInt(mmdd[2]));
    if(!isNaN(d)) return getDayStr(d);
  }
  return null;
}

// Build local analytics without AI
function buildLocalAnalytics() {
  const u = currentUser();
  const all = DB.tasks.filter(t=>t.ownerId===u.id&&!t.deletedAt);
  const done = all.filter(t=>t.status==='done');
  const overdue = all.filter(t=>t.due&&isOverdue(t.due)&&t.status!=='done');
  const stuck = all.filter(t=>t.status==='stuck');
  const totalMins = all.filter(t=>t.status!=='done').reduce((s,t)=>s+(parseInt(t.duration)||30),0);

  // Category breakdown
  const catBreak = DB.categories.taskCategories.map(c=>{
    const ct=all.filter(t=>t.category===c.id);
    return ct.length?`- ${c.name}: ${ct.length} (${ct.filter(t=>t.status==='done').length} done)`:null;
  }).filter(Boolean);

  // Completion rate
  const rate = all.length>0?Math.round(done.length/all.length*100):0;

  // Mem patterns
  const mem = getAIMemory();
  const stats = mem.stats||{};

  return `**üìä Your Analytics**

**Overview**
- Total tasks: **${all.length}** | Completed: **${done.length}** (${rate}%)
- Overdue: **${overdue.length}** | Stuck: **${stuck.length}**
- Remaining workload: ~${totalMins>=60?Math.round(totalMins/60)+'h':totalMins+'m'}

**By Category**
${catBreak.join('\n')||'- No categorised tasks yet'}

**Lifetime Stats**
- Tasks created: ${stats.tasksCreated||0} | Completed: ${stats.tasksCompleted||0} | Overdue: ${stats.tasksOverdue||0}
- Emails sent: ${stats.emailsSent||0} | AI calls: ${stats.aiCalls||0}

${overdue.length>0?`‚ö† **Overdue items:** ${overdue.slice(0,3).map(t=>t.name).join(', ')}${overdue.length>3?' +more':''}`:'‚úì No overdue items ‚Äî great work!'}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSOLE ERROR FIXES (comprehensive)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Safe element value getter ‚Äî never crashes
function safeVal(id, fallback='') {
  return document.getElementById(id)?.value ?? fallback;
}

// Patch initApp to not crash on missing elements



// Fix: checkSession sometimes called before DOM ready
function safeInitApp() {
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initApp();
  } else {
    document.addEventListener('DOMContentLoaded', initApp);
  }
}

// Fix: ensureTeams crash when DB not ready
function ensureTeams() {
  try {
    if (!DB) return;
    _origEnsureTeams();
  } catch(e) {}
}

// Fix: buildTeamsSidebarNav null crash



// Fix: renderTeamBoard null crash  



// Fix: populateAllSelects null crashes  



// Fix: renderDayPlanner null crash



// Fix: openTaskModal null crash when category/status selects not populated



// Fix: renderVisualTimeline null container crash



// Fix: aiDraftEmail crash when email center elements not present



// Fix: changeStatus virtual task crash




// Ensure DB always has required shape
function ensureDBShape() {
  if (!DB) return;
  DB.tasks = DB.tasks||[];
  DB.meetings = DB.meetings||[];
  DB.users = DB.users||[];
  DB.inbox = DB.inbox||[];
  DB.notifications = DB.notifications||[];
  DB.teams = DB.teams||[];
  DB.permissions = DB.permissions||{};
  DB.config = DB.config||{};
  DB.categories = DB.categories||{};
  DB.categories.taskCategories = DB.categories.taskCategories||[];
  DB.categories.statuses = DB.categories.statuses||[];
  DB.categories.meetingTypes = DB.categories.meetingTypes||[];
  DB.nextId = DB.nextId||1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SMTP RELAY HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyRelayScript() {
  const script = `// MERIDIAN SMTP Relay Server ‚Äî run with: node relay.js
// Install: npm install express nodemailer cors
const express = require('express');
const nodemailer = require('nodemailer');
const cors = require('cors');
const app = express();
app.use(cors()); app.use(express.json());

app.post('/send', async (req, res) => {
  const { from, to, toName, subject, text, smtp } = req.body;
  if (!smtp?.host || !smtp?.user || !smtp?.pass) return res.status(400).json({error:'Missing SMTP config'});
  const transporter = nodemailer.createTransport({
    host: smtp.host, port: smtp.port || 587,
    secure: smtp.secure || false,
    auth: { user: smtp.user, pass: smtp.pass }
  });
  try {
    await transporter.sendMail({ from: from || smtp.user, to, subject, text });
    res.json({ success: true });
  } catch(err) {
    res.status(500).json({ error: err.message });
  }
});

app.listen(3001, () => console.log('MERIDIAN SMTP relay running on port 3001'));`;

  navigator.clipboard.writeText(script).then(() => {
    toast('üìã Relay script copied! Save as relay.js and run: npm install express nodemailer cors && node relay.js');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = script; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    toast('üìã Relay script copied!');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{
  const tag=document.activeElement.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT') return;
  if(e.key==='n'||e.key==='N'){e.preventDefault();openTaskModal();}
  if(e.key==='m'||e.key==='M'){e.preventDefault();openMeetModal();}
  if(e.key==='Escape'){document.querySelectorAll('.overlay.open').forEach(el=>el.classList.remove('open'));}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function boot(){
  checkFirstRun();
  if(checkSession()){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').classList.add('vis');
    initApp();
  }
  document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
})();
</script>
</body>
</html>
